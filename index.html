<!DOCTYPE html>
<head>
  <title>Two-Factor Authentication with Node.js and Express</title>
  <style>
    body, html {
      height:100%;
      width:100%;
      padding:0;
      margin:0;
      overflow:hidden;
    }
  </style>
  <link rel="shortcut icon" href="//twilio.com/bundles/marketing/img/favicons/favicon.ico">
  <link rel="apple-touch-icon" href="//twilio.com/bundles/marketing/img/favicons/favicon_57.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/bundles/marketing/img/favicons/favicon_72.png">
  <link rel="apple-touch-icon" sizes="114x114" href="//twilio.com/bundles/marketing/img/favicons/favicon_114.png">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather+Sans:700">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Leckerli+One">
  <style>#viewsaurus{/*! normalize.css v1.0.0 | MIT License | git.io/normalize */position:relative;height:100%;color:#231f20;font-family:'Whitney Book','Helvetica Neue',Helvetica,sans-serif}#viewsaurus article,#viewsaurus aside,#viewsaurus details,#viewsaurus figcaption,#viewsaurus figure,#viewsaurus footer,#viewsaurus header,#viewsaurus hgroup,#viewsaurus nav,#viewsaurus section,#viewsaurus summary{display:block}#viewsaurus audio,#viewsaurus canvas,#viewsaurus video{display:inline-block;;}#viewsaurus audio:not([controls]){display:none;height:0}#viewsaurus [hidden]{display:none}#viewsaurus html{font-size:100%;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}#viewsaurus html,#viewsaurus button,#viewsaurus input,#viewsaurus select,#viewsaurus textarea{font-family:sans-serif}#viewsaurus body{margin:0}#viewsaurus a:focus{outline:thin dotted}#viewsaurus a:active,#viewsaurus a:hover{outline:0}#viewsaurus h1{font-size:2em;margin:.67em 0}#viewsaurus h2{font-size:1.5em;margin:.83em 0}#viewsaurus h3{font-size:1.17em;margin:1em 0}#viewsaurus h4{font-size:1em;margin:1.33em 0}#viewsaurus h5{font-size:.83em;margin:1.67em 0}#viewsaurus h6{font-size:.75em;margin:2.33em 0}#viewsaurus abbr[title]{border-bottom:1px dotted}#viewsaurus b,#viewsaurus strong{font-weight:700}#viewsaurus blockquote{margin:1em 40px}#viewsaurus dfn{font-style:italic}#viewsaurus mark{background:#ff0;color:#000}#viewsaurus p,#viewsaurus pre{margin:1em 0}#viewsaurus code,#viewsaurus kbd,#viewsaurus pre,#viewsaurus samp{font-family:monospace,serif;;font-size:1em}#viewsaurus pre{white-space:pre;white-space:pre-wrap;word-wrap:break-word}#viewsaurus q{quotes:none}#viewsaurus q:before,#viewsaurus q:after{content:'';content:none}#viewsaurus small{font-size:75%}#viewsaurus sub,#viewsaurus sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}#viewsaurus sup{top:-.5em}#viewsaurus sub{bottom:-.25em}#viewsaurus dl,#viewsaurus menu,#viewsaurus ol,#viewsaurus ul{margin:1em 0}#viewsaurus dd{margin:0 0 0 40px}#viewsaurus menu,#viewsaurus ol,#viewsaurus ul{padding:0 0 0 40px}#viewsaurus nav ul,#viewsaurus nav ol{list-style:none;list-style-image:none}#viewsaurus img{border:0;-ms-interpolation-mode:bicubic}#viewsaurus svg:not(:root){overflow:hidden}#viewsaurus figure{margin:0}#viewsaurus form{margin:0}#viewsaurus fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}#viewsaurus legend{border:0;padding:0;white-space:normal;}#viewsaurus button,#viewsaurus input,#viewsaurus select,#viewsaurus textarea{font-size:100%;margin:0;vertical-align:baseline;}#viewsaurus button,#viewsaurus input{line-height:normal}#viewsaurus button,#viewsaurus html input[type=button],#viewsaurus input[type=reset],#viewsaurus input[type=submit]{-webkit-appearance:button;cursor:pointer;}#viewsaurus button[disabled],#viewsaurus input[disabled]{cursor:default}#viewsaurus input[type=checkbox],#viewsaurus input[type=radio]{box-sizing:border-box;padding:0;;}#viewsaurus input[type=search]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}#viewsaurus input[type=search]::-webkit-search-cancel-button,#viewsaurus input[type=search]::-webkit-search-decoration{-webkit-appearance:none}#viewsaurus button::-moz-focus-inner,#viewsaurus input::-moz-focus-inner{border:0;padding:0}#viewsaurus textarea{overflow:auto;vertical-align:top}#viewsaurus table{border-collapse:collapse;border-spacing:0}#viewsaurus a,#viewsaurus a:visited{color:#e12127}#viewsaurus h1{font-family:'United Sans Cond Heavy','Merriweather Sans',Arial,sans-serif}#viewsaurus h2,#viewsaurus h3,#viewsaurus h4{font-family:'Knockout Jr. Bantamweight','Open Sans Condensed',Arial,sans-serif}#viewsaurus .saurus-panes{position:absolute;top:0;left:0;right:0;bottom:0}#viewsaurus .saurus-button{cursor:pointer;padding:4px;font-size:14px;color:#2c2c2a;border:1px solid #b1aca0;-webkit-border-radius:3px;-moz-border-radius:3px;border-radius:3px;text-decoration:none;display:inline-block;-webkit-box-shadow:1px 1px 1px #c8c4bc;box-shadow:1px 1px 1px #c8c4bc;background-color:#dbddd7;background-image:-webkit-gradient(linear,left top,left bottom,from(#dbddd7),to(#e7e9e5));background-image:-webkit-linear-gradient(top,#dbddd7,#e7e9e5);background-image:-moz-linear-gradient(top,#dbddd7,#e7e9e5);background-image:-ms-linear-gradient(top,#dbddd7,#e7e9e5);background-image:-o-linear-gradient(top,#dbddd7,#e7e9e5);background-image:linear-gradient(to bottom,#dbddd7,#e7e9e5);filter:progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr=#dbddd7, endColorstr=#e7e9e5)}#viewsaurus .saurus-button:hover{background-color:#dbddd7;background-image:-webkit-gradient(linear,left top,left bottom,from(#f4f4f3),to(#dbddd7));background-image:-webkit-linear-gradient(top,#f4f4f3,#dbddd7);background-image:-moz-linear-gradient(top,#f4f4f3,#dbddd7);background-image:-ms-linear-gradient(top,#f4f4f3,#dbddd7);background-image:-o-linear-gradient(top,#f4f4f3,#dbddd7);background-image:linear-gradient(to bottom,#f4f4f3,#dbddd7);filter:progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr=#f4f4f3, endColorstr=#dbddd7)}#viewsaurus .hll{background-color:#49483e}#viewsaurus .c{color:#75715e}#viewsaurus .err{color:#f92672}#viewsaurus .k{color:#66d9ef}#viewsaurus .l{color:#ae81ff}#viewsaurus .n{color:#f8f8f2}#viewsaurus .o{color:#f92672}#viewsaurus .p{color:#f8f8f2}#viewsaurus .cm{color:#75715e}#viewsaurus .cp{color:#75715e}#viewsaurus .c1{color:#75715e}#viewsaurus .cs{color:#75715e}#viewsaurus .ge{font-style:italic}#viewsaurus .gs{font-weight:700}#viewsaurus .kc{color:#66d9ef}#viewsaurus .kd{color:#66d9ef}#viewsaurus .kn{color:#f92672}#viewsaurus .kp{color:#66d9ef}#viewsaurus .kr{color:#66d9ef}#viewsaurus .kt{color:#66d9ef}#viewsaurus .ld{color:#e6db74}#viewsaurus .m{color:#ae81ff}#viewsaurus .s{color:#e6db74}#viewsaurus .na{color:#a6e22e}#viewsaurus .nb{color:#f8f8f2}#viewsaurus .nc{color:#a6e22e}#viewsaurus .no{color:#66d9ef}#viewsaurus .nd{color:#a6e22e}#viewsaurus .ni{color:#f8f8f2}#viewsaurus .ne{color:#a6e22e}#viewsaurus .nf{color:#a6e22e}#viewsaurus .nl{color:#f8f8f2}#viewsaurus .nn{color:#f8f8f2}#viewsaurus .nx{color:#a6e22e}#viewsaurus .py{color:#f8f8f2}#viewsaurus .nt{color:#f92672}#viewsaurus .nv{color:#f8f8f2}#viewsaurus .ow{color:#f92672}#viewsaurus .w{color:#f8f8f2}#viewsaurus .mf{color:#ae81ff}#viewsaurus .mh{color:#ae81ff}#viewsaurus .mi{color:#ae81ff}#viewsaurus .mo{color:#ae81ff}#viewsaurus .sb{color:#e6db74}#viewsaurus .sc{color:#e6db74}#viewsaurus .sd{color:#e6db74}#viewsaurus .s2{color:#e6db74}#viewsaurus .se{color:#ae81ff}#viewsaurus .sh{color:#e6db74}#viewsaurus .si{color:#e6db74}#viewsaurus .sx{color:#e6db74}#viewsaurus .sr{color:#e6db74}#viewsaurus .s1{color:#e6db74}#viewsaurus .ss{color:#e6db74}#viewsaurus .bp{color:#f8f8f2}#viewsaurus .vc{color:#f8f8f2}#viewsaurus .vg{color:#f8f8f2}#viewsaurus .vi{color:#f8f8f2}#viewsaurus .il{color:#ae81ff}#viewsaurus .x{color:#f4f4f3}#viewsaurus .saurus-lightbox{position:absolute;top:0;left:0;height:100%;width:100%;z-index:1030;color:#fff;display:none}#viewsaurus .saurus-lightbox .backdrop{position:absolute;top:0;left:0;height:100%;width:100%;background-color:#2c2c2a;opacity:.8;z-index:-1}#viewsaurus .saurus-lightbox .content{height:100%;width:100%;display:table}#viewsaurus .saurus-lightbox .content .content-container{height:100%;width:100%;display:table-cell;vertical-align:middle;text-align:center;cursor:zoom-out}#viewsaurus .saurus-lightbox .content .content-container img{max-height:80vh;max-width:80vh}#viewsaurus .saurus-code.minimized{width:auto;right:300px}#viewsaurus .saurus-code{position:absolute;top:0;left:300px;bottom:0;right:0;background-color:#2c2c2a;color:#fff;border-left:1px solid #464643;overflow:hidden}@media screen and (min-width:1240px){#viewsaurus .saurus-code{left:25%;width:auto}}#viewsaurus .saurus-code div,#viewsaurus .saurus-code table{height:100%}#viewsaurus .saurus-code pre{font-size:12px;margin:0;white-space:pre;line-height:18px}#viewsaurus .saurus-code .explorer-toggle{cursor:pointer;position:absolute;z-index:1020;top:25px;right:-5px;height:40px;width:40px;text-align:center;font-size:28px;color:#2c2c2a;background-color:#fff;border-radius:5px}#viewsaurus .saurus-code .explorer-toggle i{margin-top:8px}#viewsaurus .saurus-code .explorer-toggle i.fa-chevron-left{margin-right:8px}#viewsaurus .saurus-code td.code{padding-left:5px;padding-right:20px}#viewsaurus .saurus-code .current-file{position:relative;top:0;left:0;font-size:12px;color:#7a7a75;background-color:#231f20;padding:2px 0 0 5px;border-bottom:1px solid #464643;height:16px;overflow:hidden}#viewsaurus .saurus-code .code-files{position:relative;top:0;left:0;bottom:0;right:0}#viewsaurus .saurus-code .saurus-file{position:absolute;top:0;left:0;bottom:-25px;right:-25px;overflow:scroll}#viewsaurus .saurus-code .highlight{margin-right:25px}#viewsaurus .saurus-code .highlight pre span{line-height:18px}#viewsaurus .saurus-code .linenos{text-align:center;padding:0 10px;border-right:1px solid;margin:0;color:#464643;height:100%;width:20px}#viewsaurus .saurus-code .unhighlighted{cursor:help}#viewsaurus .saurus-code .unhighlighted span{text-shadow:0 0 20px #f4f4f3}#viewsaurus .saurus-code .muted-mix{color:transparent!important;text-shadow:0 0 3px #5d6253;cursor:help}#viewsaurus .saurus-code .mute:not(.unmute){color:transparent!important;text-shadow:0 0 3px #5d6253;cursor:help}#viewsaurus .saurus-code .mute:not(.unmute) span{color:transparent!important;text-shadow:0 0 3px #5d6253;cursor:help}#viewsaurus .saurus-explorer.maximized{width:300px}#viewsaurus .saurus-explorer{position:absolute;top:0;right:0;height:100%;width:0;z-index:1020;overflow:hidden}#viewsaurus .saurus-explorer .project-data h3{margin:5px 10px -5px 10px;padding:0;font-weight:700;font-family:'Whitney Book','Helvetica Neue',Helvetica,sans-serif}#viewsaurus .saurus-explorer .project-data h3 a{color:#231f20;text-decoration:none}#viewsaurus .saurus-explorer .project-data h3 a:hover{color:#594f51}#viewsaurus .saurus-explorer .project-data h3 a:focus{outline:0}#viewsaurus .saurus-explorer hr{margin:5px 10px;color:#2c2c2a}#viewsaurus .saurus-explorer .file:first-child p{margin-top:5px}#viewsaurus .saurus-explorer .folder{font-size:14px;padding-left:10px;margin-top:10px}#viewsaurus .saurus-explorer .folder .expand{cursor:pointer}#viewsaurus .saurus-explorer .folder .expand i{margin-right:5px}#viewsaurus .saurus-explorer .folder i{color:#b3ad97}#viewsaurus .saurus-explorer .folder:last-child{margin-bottom:5px}#viewsaurus .saurus-explorer p{font-size:12px;padding:5px 10px;margin:5px 0}#viewsaurus .saurus-explorer .file p{cursor:pointer}#viewsaurus .saurus-explorer .file i{float:left;margin-right:5px;color:#231f20}#viewsaurus .saurus-explorer .folder p{margin-left:-10px;padding-left:30px}#viewsaurus .saurus-explorer p.selected{background-color:#2c2c2a;color:#fff;-webkit-box-shadow:-1px 2px 2px #60605c;box-shadow:-1px 2px 2px #60605c}#viewsaurus .saurus-explorer p.selected i{color:#fff}#viewsaurus .saurus-prose{position:absolute;top:0;left:0;bottom:0;width:300px;min-width:300px;color:#000;background-color:#fff}@media screen and (min-width:1240px){#viewsaurus .saurus-prose{width:25%}}#viewsaurus .saurus-prose .header{height:138px}#viewsaurus .saurus-prose .header .project-links{background-color:#971d1f;height:26px;border-bottom:1px solid #82191b;border-top:1px solid #82191b;text-align:center}#viewsaurus .saurus-prose .header .project-links .wrap{margin-top:2px}#viewsaurus .saurus-prose .header .project-links a,#viewsaurus .saurus-prose .header .project-links a:visited,#viewsaurus .saurus-prose .header .project-links a:focus,#viewsaurus .saurus-prose .header .project-links a:hover{outline:0;color:#e7e9e5;text-decoration:none;font-size:12px}#viewsaurus .saurus-prose .header .project-links a span,#viewsaurus .saurus-prose .header .project-links a:visited span,#viewsaurus .saurus-prose .header .project-links a:focus span,#viewsaurus .saurus-prose .header .project-links a:hover span{font-family:'United Sans Cond Heavy','Merriweather Sans',Arial,sans-serif;text-transform:uppercase;font-weight:700;margin-left:5px}#viewsaurus .saurus-prose .header .project-links a:hover{color:#fff}#viewsaurus .saurus-prose .header .project-links a:not(:first-child){margin-left:15px}#viewsaurus .saurus-prose .header .controls{height:44px;background-color:#e7e9e5;color:#231f20}#viewsaurus .saurus-prose .header .controls .title-outer{position:relative;left:5px;padding-right:10px;display:table;vertical-align:middle;height:44px}#viewsaurus .saurus-prose .header .controls .title-outer h1{text-transform:uppercase;margin:0;padding:0;font-size:12px;line-height:1.2em;display:table-cell;vertical-align:middle;position:relative}#viewsaurus .saurus-prose .header .controls .title-outer h1.open{color:#000;font-weight:700}#viewsaurus .saurus-prose .header .controls .overview{float:right;margin:8px 5px 0 10px}#viewsaurus .saurus-prose .header .controls .overview span{margin:0 2px}#viewsaurus .saurus-prose .header .controls .overview i{margin:0 0 0 2px}#viewsaurus .saurus-prose .header .controls .overview.open,#viewsaurus .saurus-prose .header .controls .overview.open:hover{border-color:#2c2c2a;background-image:none;background-color:#2c2c2a;color:#fff}#viewsaurus .saurus-prose .header a,#viewsaurus .saurus-prose .header a:focus,#viewsaurus .saurus-prose .header a:active,#viewsaurus .saurus-prose .header a:hover{outline:0}#viewsaurus .saurus-prose .header a{font-size:12px;text-decoration:none}#viewsaurus .saurus-prose .header a:hover{text-decoration:underline}#viewsaurus .saurus-prose .header .left,#viewsaurus .saurus-prose .header .right{z-index:1010;width:50%;margin:0;padding:10px 0;text-align:center;background-color:#2c2c2a;color:#f4f4f3;outline:1px solid #464643;-webkit-box-shadow:0 2px 2px #464643;box-shadow:0 2px 2px #464643}#viewsaurus .saurus-prose .header .left i,#viewsaurus .saurus-prose .header .right i{font-size:32px}#viewsaurus .saurus-prose .header .left.disabled,#viewsaurus .saurus-prose .header .right.disabled{cursor:not-allowed;pointer-events:none;background-color:#f4f4f3;color:#dbddd7;outline:1px solid #f4f4f3;-webkit-box-shadow:0 2px 2px #fff;box-shadow:0 2px 2px #fff}#viewsaurus .saurus-prose .header .left.disabled:hover,#viewsaurus .saurus-prose .header .right.disabled:hover{background-color:#f4f4f3;outline:1px solid #f4f4f3;color:#dbddd7}#viewsaurus .saurus-prose .header .left:hover,#viewsaurus .saurus-prose .header .right:hover{background-color:#393936;outline:1px solid #464643}#viewsaurus .saurus-prose .header .left:focus,#viewsaurus .saurus-prose .header .right:focus{outline:1px solid #464643}#viewsaurus .saurus-prose .header .left.disabled:focus,#viewsaurus .saurus-prose .header .right.disabled:focus{outline:1px solid #f4f4f3}#viewsaurus .saurus-prose .header .left{margin:1px -1px 0 1px;float:left}#viewsaurus .saurus-prose .header .right{margin:1px 0 0 -1px;float:right}#viewsaurus .saurus-prose .progress-bar{height:4px;width:100%;position:relative;overflow:hidden}#viewsaurus .saurus-prose .progress-bar .progress-bar-inner{height:100%;width:0;position:absolute;top:0;left:0;background-color:#54c3c2;background-image:-webkit-gradient(linear,left top,left bottom,from(#3ba9a8),to(#54c3c2));background-image:-webkit-linear-gradient(top,#3ba9a8,#54c3c2);background-image:-moz-linear-gradient(top,#3ba9a8,#54c3c2);background-image:-ms-linear-gradient(top,#3ba9a8,#54c3c2);background-image:-o-linear-gradient(top,#3ba9a8,#54c3c2);background-image:linear-gradient(to bottom,#3ba9a8,#54c3c2);filter:progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr=#3ba9a8, endColorstr=#54c3c2)}#viewsaurus .saurus-prose .modal{display:none}#viewsaurus .saurus-prose .overview-content{position:absolute;z-index:10;top:44px;left:0;right:0;bottom:0;background-color:#2c2c2a;color:#e7e9e5;overflow-y:hidden;overflow-x:hidden}#viewsaurus .saurus-prose .overview-content .overview-wrapper{overflow-y:scroll;overflow-x:hidden;position:absolute;top:0;right:-20px;left:0;bottom:0}#viewsaurus .saurus-prose .overview-content ol{margin:5px 0 10px 0;padding-left:5px;list-style:none}#viewsaurus .saurus-prose .overview-content ol li{font-size:18px;font-family:'Knockout Jr. Bantamweight','Open Sans Condensed',Arial,sans-serif;text-transform:uppercase;color:#e12127;font-weight:300;margin:10px 30px 10px 10px}#viewsaurus .saurus-prose .overview-content ol li .accordion-header{cursor:pointer}#viewsaurus .saurus-prose .overview-content ol li .accordion-header:hover{color:#e74e53}#viewsaurus .saurus-prose .overview-content ol li span i{float:left;margin:4px 10px 10px 0}#viewsaurus .saurus-prose .overview-content ol li ol li{font-size:16px;margin:0;text-transform:none;padding:5px 25px 5px 10px}#viewsaurus .saurus-prose .overview-content ol li ol li a{text-decoration:none;color:#dbddd7;outline:0}#viewsaurus .saurus-prose .overview-content ol li ol li a:hover{text-decoration:underline}#viewsaurus .saurus-prose .overview-content ol li ol li.current{padding:5px 50px 5px 49px;margin-left:-40px;margin-right:-20px;background-color:#464643;-webkit-box-shadow:inset 0 2px 1px #53534f;box-shadow:inset 0 2px 1px #53534f}#viewsaurus .saurus-prose .overview-content ol li ol li.current a{color:#fff}#viewsaurus .saurus-prose .drop{color:#2c2c2a;z-index:10;font-size:32px;position:absolute;top:25px;right:30px}#viewsaurus .saurus-prose .prose-wrapper{position:absolute;top:138px;left:0;right:0;bottom:0;overflow:hidden}#viewsaurus .saurus-prose .saurus-step{position:absolute;top:0;left:0;right:-15px;bottom:0;line-height:1.4em;overflow-y:scroll;overflow-x:hidden;padding:0 25px 10px 10px;margin-bottom:10px}#viewsaurus .saurus-prose .saurus-step h1,#viewsaurus .saurus-prose .saurus-step h2,#viewsaurus .saurus-prose .saurus-step h3,#viewsaurus .saurus-prose .saurus-step h4,#viewsaurus .saurus-prose .saurus-step h5{font-family:'Knockout Jr. Bantamweight','Open Sans Condensed',Arial,sans-serif;font-weight:300;line-height:1.2em;margin:5px 0}#viewsaurus .saurus-prose .saurus-step img{display:block;margin:0 auto;max-width:100%;max-height:300px;cursor:pointer;outline:1px solid #b1aca0}#viewsaurus .saurus-prose .saurus-step img:hover{opacity:.8}#viewsaurus .saurus-prose .saurus-step p,#viewsaurus .saurus-prose .saurus-step li{font-size:14px}#viewsaurus .saurus-prose .saurus-step ul{padding-left:20px}#viewsaurus .saurus-prose .saurus-step p code{padding:3px;border-radius:3px;background-color:#dbddd7;color:#231f20}#viewsaurus .saurus-prose .saurus-step pre{margin:0;padding:5px;background-color:#231f20;border:1px solid #2c2c2a}#viewsaurus .saurus-prose .saurus-step pre code{font-size:12px;color:#fff}#viewsaurus .saurus-prose .saurus-step em{font-weight:700;text-decoration:none;font-style:normal}</style>
</head>
<body>
  <div id="viewsaurus">
    <div class="saurus-lightbox">
      <div class="backdrop"></div>
      <div class="content">
        <div class="content-container"><img src=""></div>
      </div>
    </div>
    <div class="saurus-panes">
      <div class="saurus-prose">
        <div class="header">
          <div class="controls">
            <div class="overview saurus-button"><span class="current">1</span><span>/</span><span class="total">26</span><i class="fa fa-fw fa-list"></i></div>
            <div class="title-outer">
              <h1>Two-Factor Authentication with Node.js and Express</h1>
            </div>
          </div>
          <div class="project-links">
            <div class="wrap"><a href="https://github.com/kwhinnery/tfa-node" target="_blank"> <i class="fa fa-fw fa-github-square"></i><span>GitHub</span></a><a href="https://github.com/kwhinnery/tfa-node/archive/master.zip"> <i class="fa fa-fw fa-cloud-download"></i><span>Download</span></a><a href="https://heroku.com/deploy?template=https://github.com/kwhinnery/tfa-node" target="_blank"> <i class="fa fa-fw fa-rocket"></i><span>Deploy</span></a>
            </div>
          </div><a href="" class="left disabled"><i class="fa fa-caret-left"></i></a><a href="#0-Application-Overview/1-Installing-Dependencies" class="right"><i class="fa fa-caret-right"></i></a>
          <div class="progress-bar">
            <div class="progress-bar-inner"></div>
          </div>
        </div>
        <div class="modal overview-content">
          <div class="overview-wrapper">
            <ol>
              <li class="toc-chapter expanded-chapter"><span class="accordion-header"><i class="fa fa-minus-square"></i><span>Application Overview</span></span>
                <ol style="display:block;">
                  <li data-chapter-index='0' data-step-index='0' class="current"><a href="#0-Application-Overview/0-Welcome">Welcome</a>
                  </li>
                  <li data-chapter-index='0' data-step-index='1'><a href="#0-Application-Overview/1-Installing-Dependencies">Installing Dependencies</a>
                  </li>
                  <li data-chapter-index='0' data-step-index='2'><a href="#0-Application-Overview/2-Configuring-the-Application">Configuring the Application</a>
                  </li>
                  <li data-chapter-index='0' data-step-index='3'><a href="#0-Application-Overview/3-Running-the-Application">Running the Application</a>
                  </li>
                  <li data-chapter-index='0' data-step-index='4'><a href="#0-Application-Overview/4-Express-Application-Configuration">Express Application Configuration</a>
                  </li>
                  <li data-chapter-index='0' data-step-index='5'><a href="#0-Application-Overview/5-The-Story-So-Far">The Story So Far</a>
                  </li>
                </ol>
              </li>
              <li class="toc-chapter"><span class="accordion-header"><i class="fa fa-plus-square"></i><span>Domain Model</span></span>
                <ol style="display:none;">
                  <li data-chapter-index='1' data-step-index='0'><a href="#1-Domain-Model/0-Designing-Our-Domain-Model">Designing Our Domain Model</a>
                  </li>
                  <li data-chapter-index='1' data-step-index='1'><a href="#1-Domain-Model/1-The-User-Model">The User Model</a>
                  </li>
                  <li data-chapter-index='1' data-step-index='2'><a href="#1-Domain-Model/2-The-Session-Model">The Session Model</a>
                  </li>
                  <li data-chapter-index='1' data-step-index='3'><a href="#1-Domain-Model/3-The-Story-So-Far">The Story So Far</a>
                  </li>
                </ol>
              </li>
              <li class="toc-chapter"><span class="accordion-header"><i class="fa fa-plus-square"></i><span>Creating an Authenticated Session</span></span>
                <ol style="display:none;">
                  <li data-chapter-index='2' data-step-index='0'><a href="#2-Creating-an-Authenticated-Session/0-The-Main-Router">The Main Router</a>
                  </li>
                  <li data-chapter-index='2' data-step-index='1'><a href="#2-Creating-an-Authenticated-Session/1-Rendering-the-Login-Form-Controller">Rendering the Login Form: Controller</a>
                  </li>
                  <li data-chapter-index='2' data-step-index='2'><a href="#2-Creating-an-Authenticated-Session/2-Rendering-the-Login-Form-View">Rendering the Login Form: View</a>
                  </li>
                  <li data-chapter-index='2' data-step-index='3'><a href="#2-Creating-an-Authenticated-Session/3-Processing-the-Username-and-Password">Processing the Username and Password</a>
                  </li>
                  <li data-chapter-index='2' data-step-index='4'><a href="#2-Creating-an-Authenticated-Session/4-Sending-The-Verification-Code">Sending The Verification Code</a>
                  </li>
                  <li data-chapter-index='2' data-step-index='5'><a href="#2-Creating-an-Authenticated-Session/5-Rendering-the-Verification-Form-Controller">Rendering the Verification Form: Controller</a>
                  </li>
                  <li data-chapter-index='2' data-step-index='6'><a href="#2-Creating-an-Authenticated-Session/6-Rendering-the-Verification-Form-View">Rendering the Verification Form: View</a>
                  </li>
                  <li data-chapter-index='2' data-step-index='7'><a href="#2-Creating-an-Authenticated-Session/7-Rendering-the-Verification-Form-JS">Rendering the Verification Form: JS</a>
                  </li>
                  <li data-chapter-index='2' data-step-index='8'><a href="#2-Creating-an-Authenticated-Session/8-Completing-the-Login-Process">Completing the Login Process</a>
                  </li>
                  <li data-chapter-index='2' data-step-index='9'><a href="#2-Creating-an-Authenticated-Session/9-Session-Middleware">Session Middleware</a>
                  </li>
                  <li data-chapter-index='2' data-step-index='10'><a href="#2-Creating-an-Authenticated-Session/10-The-Story-So-Far">The Story So Far</a>
                  </li>
                </ol>
              </li>
              <li class="toc-chapter"><span class="accordion-header"><i class="fa fa-plus-square"></i><span>Next Steps</span></span>
                <ol style="display:none;">
                  <li data-chapter-index='3' data-step-index='0'><a href="#3-Next-Steps/0-Making-It-Better">Making It Better</a>
                  </li>
                  <li data-chapter-index='3' data-step-index='1'><a href="#3-Next-Steps/1-Persistent-User-Accounts">Persistent User Accounts</a>
                  </li>
                  <li data-chapter-index='3' data-step-index='2'><a href="#3-Next-Steps/2-Don-t-Require-2FA-Every-Time">Don't Require 2FA Every Time</a>
                  </li>
                  <li data-chapter-index='3' data-step-index='3'><a href="#3-Next-Steps/3-User-Account-Verification">User Account Verification</a>
                  </li>
                  <li data-chapter-index='3' data-step-index='4'><a href="#3-Next-Steps/4-Let-Us-Help-">Let Us Help!</a>
                  </li>
                </ol>
              </li>
            </ol>
          </div>
        </div>
        <div class="prose-wrapper">
          <section data-title="Application Overview" class="saurus-chapter">
            <section style="" data-title="Welcome" data-file="package.json" data-language="json" data-overallStep='1' class="saurus-step">
              <section class="saurus-step-content"><h2 id="building-two-factor-authentication-in-node-js-with-express">Building Two-Factor Authentication in Node.js with Express</h2>
<p>Adding two-factor authentication (2FA) to your web application can help increase the security of your user&apos;s data. <a href="http://en.wikipedia.org/wiki/Multi-factor_authentication">Multi-factor authentication</a> determines the identity of a user by validating one or more of the following &quot;factors&quot;:</p>
<ul>
<li><em>Knowledge Factors</em> (Something a user knows, like a password)</li>
<li><em>Posession Factors</em> (Something a user has, like a mobile phone)</li>
<li><em>Inheritance Factors</em> (Something a user is, like a person with a unique finger print)</li>
</ul>
<p>We&apos;re about to walk you through a sample application that implements a simple login system with a <em>knowledge factor</em> and a <em>posession factor</em>. For the knowledge factor, we will use a standard username/password system. For the possession factor, we will validate that the user has their mobile phone by sending them a one-time passcode in a text message or phone call <a href="http://www.twilio.com/">sent via Twilio</a>. Click on the image below to view a diagram of how this works at a high level:</p>
<p><img src="./tutorial/images/diagram.png" alt="How Twilio 2FA Works"></p>
<h3 id="let-apos-s-go-">Let&apos;s Go!</h3>
<p>Let&apos;s begin by showing how to run this application locally, after which we&apos;ll dive in to the project&apos;s structure to understand what&apos;s in the box. Click the right arrow button above to move on to the next section of the tutorial.</p>
</section>
            </section>
            <section style="display:none;" data-title="Installing Dependencies" data-file="package.json" data-overallStep='2' class="saurus-step">
              <section class="saurus-step-content"><h2 id="installing-dependencies">Installing Dependencies</h2>
<p>We will assume at this point that you have installed <a href="http://www.nodejs.org">Node.js</a> on your system. The default installer should put both the <code>node</code> and <code>npm</code> commands on your system path.</p>
<p>After you have downloaded or cloned the source code for this application, you will need to install its dependencies from <a href="http://www.npmjs.org">npm</a>.  Open a terminal window in the directory where you downloaded the code and run:</p>
<pre><code class="lang-bash">npm install
</code></pre>
<p>This will install the necessary third party dependencies for this application. Let&apos;s take a quick look at what those are.</p>
</section>
              <section style="display:none;" data-file="package.json" data-highlight="18" class="saurus-chunk"><h3 id="express-framework">Express Framework</h3>
<p>This application uses the <a href="http://expressjs.com">Express</a> web framework, one of the most popular high-level web frameworks for Node.js. Built atop <a href="https://github.com/senchalabs/connect">Connect</a>, an Express application is essentially a series of <a href="http://expressjs.com/guide/using-middleware.html">middleware functions</a> that together process and render a response to an HTTP request.</p>
</section>
              <section style="display:none;" data-file="package.json" data-highlight="15-17,19,22-23" class="saurus-chunk"><h3 id="connect-middleware">Connect Middleware</h3>
<p>Express doesn&apos;t actually ship with much functionality that helps you process those HTTP requests, however. Most Express applications employ a variety of open source middleware components like these to handle common tasks like parsing POST bodies, adding <a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_%28CSRF%29_Prevention_Cheat_Sheet">CSRF</a> protection tokens for form submissions, and storing data in an HTTP session.</p>
</section>
              <section style="display:none;" data-file="package.json" data-highlight="25" class="saurus-chunk"><h3 id="twilio-module">Twilio Module</h3>
<p>Of course, we also need the <a href="http://twilio.github.io/twilio-node/">twilio module for Node.js</a>, which makes sending text messages and making phone calls from your Twilio account very easy.</p>
<p>Now let&apos;s take a look at the configuration our application needs to run.</p>
</section>
            </section>
            <section style="display:none;" data-title="Configuring the Application" data-file="config.js" data-language="js" data-overallStep='3' class="saurus-step">
              <section class="saurus-step-content"><h2 id="configuring-the-application">Configuring the Application</h2>
<p>We&apos;ve listed all the configuration our application requires in <code>config.js</code> to keep it in a single place, but the actual values for most of these variables are being pulled in from the system environment. This is a good idea for more sensitive information like API keys, so they don&apos;t end up being checked in to source control.</p>
<p>Let&apos;s take a look at a few key bits of configuration.</p>
</section>
              <section style="display:none;" data-file="config.js" data-highlight="6-8" class="saurus-chunk"><h3 id="secret-string">Secret String</h3>
<p>Here we configure a random string which we&apos;ll use as a seed to generate other random tokens in our application. You can set this to be anything you like.</p>
</section>
              <section style="display:none;" data-file="config.js" data-highlight="10-21" class="saurus-chunk"><h3 id="twilio-configuration">Twilio Configuration</h3>
<p>Here we configure information about our Twilio account, including our account credentials and a phone number we&apos;ll use to make outbound calls or send text messages.</p>
<p>Now we have our dependencies and configuration all set - let&apos;s see how we would actually run our application.</p>
</section>
            </section>
            <section style="display:none;" data-title="Running the Application" data-file="index.js" data-language="js" data-overallStep='4' class="saurus-step">
              <section class="saurus-step-content"><h2 id="running-the-application">Running the Application</h2>
<p>The bootstrap file for our application is <code>index.js</code>. This program will <code>require</code> an Express web app we&apos;ve configured in another file.  To start this application on the configured HTTP port, simply execute this program from the terminal with:</p>
<pre><code class="lang-bash">node index.js
</code></pre>
<p>Let&apos;s check out that web application module to see how our Express application is configured.</p>
</section>
            </section>
            <section style="display:none;" data-title="Express Application Configuration" data-file="webapp.js" data-language="js" data-overallStep='5' class="saurus-step">
              <section class="saurus-step-content"><h2 id="express-application-configuration">Express Application Configuration</h2>
<p>In <code>webapp.js</code> we create and configure an Express web application object. Here, we configure the order in which middleware functions are executed, mount the route handlers for our application&apos;s actual functionality, and configure application middleware that handles 404 and 500 error conditions.</p>
<p>This file is something of a beast - let&apos;s dig into exactly what&apos;s going on in a few key areas.</p>
</section>
              <section style="display:none;" data-file="webapp.js" data-highlight="1-10" class="saurus-chunk"><h3 id="dependencies">Dependencies</h3>
<p>We begin by requiring our dependencies from core Node.js, third party modules, and our own local project.</p>
</section>
              <section style="display:none;" data-file="webapp.js" data-highlight="12-14" class="saurus-chunk"><h3 id="creating-the-express-app">Creating the Express App</h3>
<p>Here, we create the actual Express web app and configure <a href="http://jade-lang.com/">Jade</a> as the default template engine for generating HTML pages from our application.</p>
</section>
              <section style="display:none;" data-file="webapp.js" data-highlight="16-43" class="saurus-chunk"><h3 id="third-party-middleware">Third-Party Middleware</h3>
<p>Here we configure the third-party middleware we use in our application to handle concerns that aren&apos;t core to our application logic. In our case, these include tasks like handling HTTP sessions, parsing POST bodies, and persisting &quot;flash&quot; messages between requests to render in our HTML UI.</p>
</section>
              <section style="display:none;" data-file="webapp.js" data-highlight="45-49" class="saurus-chunk"><h3 id="application-logic">Application Logic</h3>
<p>Here we start adding in logic that is specific to our example application.</p>
<p>First, we have a &quot;user session&quot; middleware that will look for session information that indicates a logged in user, and will automatically add the logged in User&apos;s information to an incoming HTTP request so we can use it in our controllers. We&apos;ll see how that works in greater depth later.</p>
<p>Next, we <code>require</code> a module that defines all of the <a href="http://expressjs.com/4x/api.html#app.METHOD">route handlers</a> for our application. These routes will display login pages and secure pages that only a logged in user will see. We&apos;ll dive into these route definitions a little later on also.</p>
</section>
              <section style="display:none;" data-file="webapp.js" data-highlight="51-73" class="saurus-chunk"><h3 id="error-handling">Error Handling</h3>
<p>Finally, we add handlers for 404 and 500 error conditions in our application. </p>
<p>In the first middleware function, we assume that because no other middleware or route has handled the request so far, the resource could not be found. We return a 404 response and send a static HTML file in reply to a request for a page that doesn&apos;t exist.</p>
<p>In the second function, we handle any error conditions that were not handled further up the middleware stack, like any unhandled exceptions. We have a special check for expired CSRF tokens, but most 500 errors will result in a static 500 error page.</p>
</section>
            </section>
            <section style="display:none;" data-title="The Story So Far" data-file="webapp.js" data-language="js" data-overallStep='6' class="saurus-step">
              <section class="saurus-step-content"><h2 id="the-story-so-far">The Story So Far</h2>
<p>So far, we have explored our application&apos;s dependencies, configured it to run, and stepped through how the application is initialized. With those implementation details out of the way, we can take a step back and think about what kind of domain model features we&apos;ll need to support 2FA in our application.</p>
</section>
            </section>
          </section>
          <section data-title="Domain Model" class="saurus-chapter">
            <section style="display:none;" data-title="Designing Our Domain Model" data-file="models/User.js" data-language="js" data-overallStep='7' class="saurus-step">
              <section class="saurus-step-content"><h2 id="designing-our-domain-model">Designing Our Domain Model</h2>
<p>To support 2FA in our application, we need to have a login system in place. Authentication is one of those things that&apos;s implemented a tiny bit differently in every application on the web, but at a very high level we&apos;ll need at least two domain model objects:</p>
<ul>
<li><em>User</em>: An individual user of the application that can be uniquely identified</li>
<li><em>Session</em>: A model representing a User&apos;s period of interaction with the application. Creating a session should require a login operation to succeed first.</li>
</ul>
<p>In our sample application, we&apos;ve provided model objects that fulfill these two tasks. We won&apos;t dive too far into the implementation these model objects (since they only persist information in memory and not to a database), but we will examine their interfaces and features to see how a login system with 2FA might be implemented.</p>
</section>
            </section>
            <section style="display:none;" data-title="The User Model" data-file="models/User.js" data-language="js" data-overallStep='8' class="saurus-step">
              <section class="saurus-step-content"><h2 id="the-user-model">The User Model</h2>
<p>Our User model is responsible for storing information about the user (their username, phone number, password, etc.) and testing candidate passwords against (securely hashed in production!) stored passwords.</p>
<p>Let&apos;s take a look at how the API for a &quot;User&quot; domain object might be constructed.</p>
</section>
              <section style="display:none;" data-file="models/User.js" data-highlight="6-13" class="saurus-chunk"><h3 id="defining-the-user-schema">Defining the User Schema</h3>
<p>No matter what persistence framework your application uses, you&apos;ll probably define some sort of schema to describe how your domain models are structured.</p>
<p>One module I really like for defining JavaScript obejct schemas independent of a persistence framework is <a href="https://github.com/hapijs/joi">Joi</a>.  With the Joi module you can define data structures and validation logic for arbitrary JavaScript objects. This is super useful if you&apos;re building an API that accepts JSON input, but it&apos;s also useful for defining business model objects like our User.</p>
<p>Our user has properties like a username, a full (human readable) name, a contact phone number, and a contact preference which can be either <code>text</code> or <code>voice</code>. This will dictate how we send their 2FA password to them, as we will see later.</p>
</section>
              <section style="display:none;" data-file="models/User.js" data-highlight="24-25,28-31,38,40,42-43" class="saurus-chunk"><h3 id="saving-a-user">Saving a User</h3>
<p>Our user will need to be able to save its self to the database. How this actually happens will differ between applications, but all I/O operations in a Node.js program should (most of the time) be asynchronous. As such, our <code>save</code> method should accept a callback function that will be invoked either with an error object or a positive result of the operation. If you&apos;re new to designing async interfaces for Node, <a href="http://blog.izs.me/post/59142742143/designing-apis-for-asynchrony">you may want to check out this helpful post</a>.</p>
<p>Before actually executing the save logic, we first use our Joi schema to validate that the User&apos;s properties are valid within the constraints of our schema.</p>
</section>
              <section style="display:none;" data-file="models/User.js" data-highlight="45-46,65,67" class="saurus-chunk"><h3 id="testing-a-username-password-combination">Testing a Username / Password Combination</h3>
<p>At the &quot;class&quot; level, our User domain model object will need to be able to takle a username/password combination and return a user object for any account that matches those credentials.  We use the same async callback pattern here, calling the passed in callback function with an error object (which is null in the success case) and the user object (which is null if a username/password match was not found).</p>
</section>
              <section style="display:none;" data-file="models/User.js" data-highlight="69-70,86,88" class="saurus-chunk"><h3 id="finding-user-data-by-username">Finding User Data by Username</h3>
<p>Another class-level function we&apos;ll need is for querying our data store for users whose username match the one passed in. We have an async interface defined to do this as well.</p>
<p>Now that we know at a high level what our User model does, let&apos;s take a look at the Session model.</p>
</section>
            </section>
            <section style="display:none;" data-title="The Session Model" data-file="models/Session.js" data-language="js" data-overallStep='9' class="saurus-step">
              <section class="saurus-step-content"><h2 id="the-session-model">The Session Model</h2>
<p>Our Session model is responsible for tracking authenticated user sessions for our application. This model will actually generate the one-time passwords we send to the user via Twilio. We&apos;ll dig into how that process works when we step through the login flow later on, but let&apos;s look at the high level API for the Session model first.</p>
</section>
              <section style="display:none;" data-file="models/Session.js" data-highlight="71-75,82" class="saurus-chunk"><h3 id="creating-a-session">Creating a Session</h3>
<p>This model has a constructor which associates a User with a new Session. Initally, an instance variable called <code>verified</code> is set to false, since the 2FA step has not been completed at the time a new Session is created (after a username/password combo is validated).</p>
</section>
              <section style="display:none;" data-file="models/Session.js" data-highlight="84-85" class="saurus-chunk"><h3 id="saving-a-session">Saving a Session</h3>
<p>As with our User model, we have an async <code>save</code> method on the model object.</p>
</section>
              <section style="display:none;" data-file="models/Session.js" data-highlight="109-110,127-128" class="saurus-chunk"><h3 id="finding-a-session">Finding a Session</h3>
<p>We have a pair of &quot;class-level&quot; functions that will allow us to query sessions either by their unique ID or a token string associated with them. We&apos;ll see how those ID and token values are used when we examine the login flow later.</p>
</section>
              <section style="display:none;" data-file="models/Session.js" data-highlight="149-150" class="saurus-chunk"><h3 id="destroying-a-session">Destroying a Session</h3>
<p>We also have a class-level function that will log out a User by destroying a Session with the given ID.</p>
</section>
              <section style="display:none;" data-file="models/Session.js" data-highlight="95-107" class="saurus-chunk"><h3 id="sending-verification-codes">Sending Verification Codes</h3>
<p>One instance method we haven&apos;t explored yet is this one, which handles sending one-time passcodes to a User associated with the Session. The <code>sendCode</code> function is where all the Twilio magic happens - we&apos;ll be cracking that nut open when we start exploring the login flow in a moment.</p>
</section>
            </section>
            <section style="display:none;" data-title="The Story So Far" data-file="models/Session.js" data-language="js" data-overallStep='10' class="saurus-step">
              <section class="saurus-step-content"><h2 id="the-story-so-far">The Story So Far</h2>
<p>We&apos;ve just explored the necessary domain model functions needed to support a 2FA login system. We need a User model to store information about the user (like their full name and phone number), and to compare candidate passwords to stored passwords during the login flow.  We need a Session model, associated with a User model, which can track whether or not it has been validated via 2FA. The Session model is also a logical place to keep code that uses Twilio for outbound communication, code which we will explore at some depth in the next phase of the tutorial.</p>
<p>Now that we understand a domain model that can support 2FA, let&apos;s dig into the Express route handlers and front-end code that we use to actually implement the login experience for end users.</p>
</section>
            </section>
          </section>
          <section data-title="Creating an Authenticated Session" class="saurus-chapter">
            <section style="display:none;" data-title="The Main Router" data-file="controllers/router.js" data-language="js" data-overallStep='11' class="saurus-step">
              <section class="saurus-step-content"><h2 id="the-main-router">The Main Router</h2>
<p>When we configured our Express application earlier in <code>webapp.js</code>, we delegated the creation of application-specific routes to this file. This is the best place to start looking through the code which drives the 2FA user experience.</p>
<p>In this section of the tutorial, we&apos;ll walk through the server- and client-side code necessary to implement our HTTP session-based authentication system. Let&apos;s begin by showing how we declare routes in our Express application. After that, we&apos;ll briefly cover how users are created in our application before diving into the login flow.</p>
</section>
              <section style="display:none;" data-file="controllers/router.js" data-highlight="1-8,27" class="saurus-chunk"><h3 id="setting-up-routes">Setting Up Routes</h3>
<p>We&apos;ve set up this module such that the object which is exported is a function that takes an Express web app as its only argument. That app is then extended with all the application-specific routes in our sample, starting with a route for the root URL.</p>
<p>We require all of our custom controllers and middleware first before setting up our routes. The first set of routes we define will be those that manage User-related functionality - let&apos;s briefly check those out next.</p>
</section>
              <section style="display:none;" data-file="controllers/router.js" data-highlight="10-15" class="saurus-chunk"><h3 id="creating-users">Creating Users</h3>
<p>These routes handle creating new users and displaying information about logged in users.  When a new user is created, we collect their name, phone number, a password, and their contact preference for 2FA:</p>
<p><img src="/tutorial/images/create-user.png" alt="New User Form"></p>
<p>We care mostly about how login works, though, so we won&apos;t spend too much time walking through the routes highlighted here.</p>
</section>
              <section style="display:none;" data-file="controllers/router.js" data-highlight="12" class="saurus-chunk"><h3 id="securing-routes">Securing Routes</h3>
<p>One thing I do want to point out, however, is that we protect one of the routes in our application with our custom <code>requireLogin</code> middleware. We want this route to be secured such that only the currently logged in user can see their own &quot;profile page&quot;.</p>
<p>We&apos;ll dig into that middleware function after we show how the main login flow works.</p>
</section>
              <section style="display:none;" data-file="controllers/router.js" data-highlight="17-26" class="saurus-chunk"><h3 id="login-routes">Login Routes</h3>
<p>These are the route handlers we&apos;ll spend the most time on - these routes power all the steps of the login flow:</p>
<ul>
<li>Displaying a login form</li>
<li>Handling the password verification step and sending a one-time password via Twilio</li>
<li>Displaying a form to accept the one-time password for validation</li>
<li>Creating a valid Session for the current User</li>
<li>Destroying a Session (logging out)</li>
</ul>
<p>You&apos;ll notice that many of the routes contain an <code>id</code> parameter - we&apos;ll use this to identify which Session the user is trying to modify.</p>
<p>Let&apos;s check out the code which powers the password authentication step first.</p>
</section>
            </section>
            <section style="display:none;" data-title="Rendering the Login Form: Controller" data-file="controllers/session.js" data-language="js" data-highlight="4-7" data-overallStep='12' class="saurus-step">
              <section class="saurus-step-content"><h2 id="rendering-the-login-form-controller">Rendering the Login Form: Controller</h2>
<p>The first step of authenticating our user is validating the &quot;knowledge&quot; factor - in this case, we&apos;ll use the trusty username and password.  </p>
<p>When the <code>/login</code> page is requested, we render a Jade template that contains our login form from the <code>views</code> directory.</p>
</section>
            </section>
            <section style="display:none;" data-title="Rendering the Login Form: View" data-file="views/session/create.jade" data-language="jade" data-overallStep='13' class="saurus-step">
              <section class="saurus-step-content"><h2 id="a-login-form">A Login Form</h2>
<p>This Jade template will render a login form that will prompt the user to enter their username and password. With a little Bootstrap styling, our form will look like this:</p>
<p><img src="./tutorial/images/login-form.png" alt="The Login Form"></p>
</section>
              <section style="display:none;" data-file="views/session/create.jade" data-highlight="8" class="saurus-chunk"><h3 id="a-form-tag-helper">A Form Tag Helper</h3>
<p>Here we use a <a href="http://jade-lang.com/reference/mixins/">mixin</a> called <code>+formFor</code> to generate an HTML <code>form</code> tag. This handles setting the form action and method on the form tag its self, and embedding a CSRF protection token as a hidden field in the form.</p>
</section>
              <section style="display:none;" data-file="views/session/create.jade" data-highlight="11,15" class="saurus-chunk"><h3 id="login-fields">Login Fields</h3>
<p>We&apos;ll submit both the <code>username</code> and <code>password</code> fields to the server to validate a username and password. Let&apos;s take a look at that server-side code next.</p>
</section>
            </section>
            <section style="display:none;" data-title="Processing the Username and Password" data-file="controllers/session.js" data-language="js" data-highlight="9-50" data-overallStep='14' class="saurus-step">
              <section class="saurus-step-content"><h2 id="processing-the-username-and-password">Processing the Username and Password</h2>
<p>After the form is submitted in the browser, this controller function will process the resulting HTTP POST request.</p>
</section>
              <section style="display:none;" data-file="controllers/session.js" data-highlight="11-13" class="saurus-chunk"><h3 id="form-fields">Form Fields</h3>
<p>First, we get the username and password the user submitted through the form.</p>
</section>
              <section style="display:none;" data-file="controllers/session.js" data-highlight="15-16,49" class="saurus-chunk"><h3 id="testing-the-password">Testing the Password</h3>
<p>Next, we asynchronously test the candidate username and password using the class-level function we saw previously on the <code>User</code> model.</p>
</section>
              <section style="display:none;" data-file="controllers/session.js" data-highlight="17,44-48" class="saurus-chunk"><h3 id="did-it-work-">Did it Work?</h3>
<p>Inside the callback, we test whether or not the login was successful by checking for an error and validating that a user model does indeed exist with the given username and password.</p>
<p>If not, we set a &quot;flash&quot; message with an error that will be displayed in the HTML we send back with feedback to the user on what went wrong.</p>
</section>
              <section style="display:none;" data-file="controllers/session.js" data-highlight="18-43" class="saurus-chunk"><h3 id="creating-a-new-unverified-session">Creating a New, Unverified Session</h3>
<p>If the username and password were correct, the user has cleared the first barrier in logging into the application. We will now create a <code>Session</code> object for them that needs to be verified with a one-time password we will send to their mobile phone via voice call or text message.</p>
</section>
              <section style="display:none;" data-file="controllers/session.js" data-highlight="28-41" class="saurus-chunk"><h3 id="the-verification-code">The Verification Code</h3>
<p>If the session is saved successfully, we call the <code>sendVerification</code> instance method on the session object.  If the message is sent successfully, we render a new form which will allow them to enter the verification code they were sent.  Let&apos;s dive into the <code>Session</code> model again to see how the notification is actually sent using Twilio.</p>
</section>
            </section>
            <section style="display:none;" data-title="Sending The Verification Code" data-file="models/Session.js" data-language="js" data-highlight="95-107" data-overallStep='15' class="saurus-step">
              <section class="saurus-step-content"><h2 id="sending-the-verification-code">Sending The Verification Code</h2>
<p>Our Session model does most of the heavy lifting where the 2FA step is concerned. Let&apos;s see how we generate the one-time password the user will enter into our web form to validate the &quot;possession&quot; factor of our authentication scheme.</p>
</section>
              <section style="display:none;" data-file="models/Session.js" data-highlight="99-102" class="saurus-chunk"><h3 id="generating-a-one-time-password">Generating a One-Time Password</h3>
<p>Here, we use the <a href="https://www.npmjs.com/package/speakeasy">speakeasy</a> module to generate a disposable <a href="http://en.wikipedia.org/wiki/Time-based_One-time_Password_Algorithm">time-based one-time password</a> that we can send to a user&apos;s mobile phone. We assign the code to a property on the current Session model so that we can compare the code later when the user enters it.</p>
</section>
              <section style="display:none;" data-file="models/Session.js" data-highlight="104-106" class="saurus-chunk"><h3 id="invoke-the-twilio-bits">Invoke the Twilio Bits</h3>
<p>Using the generated code and information about the user associated with the Session (their phone number and contact preference), we can use Twilio to send them the code via voice or SMS. Let&apos;s see how that works now.</p>
</section>
              <section style="display:none;" data-file="models/Session.js" data-highlight="2-3,8-9" class="saurus-chunk"><h3 id="creating-a-rest-api-client">Creating a REST API Client</h3>
<p>When the Session model module is loaded, we create an authenticated <a href="http://twilio.github.io/twilio-node/#restapi">REST API client</a> using the <code>twilio</code> module and our <a href="https://www.twilio.com/user/account/voice-messaging">Twilio account information</a>. We&apos;ll re-use this client in every call to <code>sendCode</code>.</p>
</section>
              <section style="display:none;" data-file="models/Session.js" data-highlight="15-31" class="saurus-chunk"><h3 id="sending-the-code-the-right-way">Sending the Code The Right Way</h3>
<p>Depending on the user&apos;s contact preference, we will use the Twilio REST client to send them the generated one-time password.</p>
</section>
              <section style="display:none;" data-file="models/Session.js" data-highlight="25-29" class="saurus-chunk"><h3 id="via-text-message">Via Text Message</h3>
<p>If the user chose to receive their verification code via text message, our job is pretty easy - just send them the code in a text message and you&apos;re done!</p>
</section>
              <section style="display:none;" data-file="models/Session.js" data-highlight="19-23" class="saurus-chunk"><h3 id="via-voice-call">Via Voice Call</h3>
<p>If the user chose to receive the code in a voice call, we have a little more work to do. We need to provide a <a href="https://www.twilio.com/docs/api/twiml">TwiML-generating URL on the public internet</a> that contains instructions on how to read the verification code back to the user.</p>
<p>We could set up this endpoint on our own server, but Twilio provides a handy service (suitable for development and testing) that will simply <a href="https://www.twilio.com/labs/twimlets/echo">echo back any TwiML embedded in the URL</a>. All we need to do in our <code>Session</code> model is build a TwiML (XML) string that contains all the right instructions to read back the code.  We have a helper function that uses the <code>twilio</code> module to do just that - let&apos;s check out how that works.</p>
</section>
              <section style="display:none;" data-file="models/Session.js" data-highlight="33-69" class="saurus-chunk"><h3 id="using-the-twiml-helper">Using the TwiML Helper</h3>
<p>The <code>twilio</code> module has a <a href="http://twilio.github.io/twilio-node/#twimlResponse">helper object that makes it easy to generate valid TwiML XML strings</a>. We use that helper class in this function to build up TwiML instructions that will read back the verification code during a voice call, repeating the code three times.</p>
</section>
              <section style="display:none;" data-file="models/Session.js" data-highlight="35-47" class="saurus-chunk"><h3 id="reading-back-the-code">Reading Back the Code</h3>
<p>We begin by splitting the verification code string into an array of six number strings.  We then use the <a href="https://www.twilio.com/docs/api/twiml/say">Say</a> verb to initiate the message to the user.</p>
<p>Using the <code>appendCode</code> function, we speak each number of the code back to the user one at a time.</p>
</section>
              <section style="display:none;" data-file="models/Session.js" data-highlight="49-63" class="saurus-chunk"><h3 id="repeating-the-code">Repeating the Code</h3>
<p>The user might not get the code 100% the first time. We repeat it back to them twice, so they hear it a total of three times.</p>
</section>
              <section style="display:none;" data-file="models/Session.js" data-highlight="65-68" class="saurus-chunk"><h3 id="rendering-the-twiml-xml-string">Rendering the TwiML XML String</h3>
<p>Finally, we convert the TwiML helper object to an XML representation of the TwiML response we just built programmatically.</p>
<p>Now the verification code should be on its way! In the text message use case, the end user will receive the verification code in a message that looks like this:</p>
<p><img src="./tutorial/images/code.jpg" alt="a verification code on iPhone"></p>
<p>Now, let&apos;s hop back out to the controller and see how we render the form that the user will enter their one-time password into.</p>
</section>
            </section>
            <section style="display:none;" data-title="Rendering the Verification Form: Controller" data-file="controllers/session.js" data-language="js" data-highlight="52-64" data-overallStep='16' class="saurus-step">
              <section class="saurus-step-content"><h2 id="rendering-the-verification-form-controller">Rendering the Verification Form: Controller</h2>
<p>After a successful login, this controller method is called to render a form that allows the user to enter in the verification code that was sent to their mobile phone.</p>
</section>
              <section style="display:none;" data-file="controllers/session.js" data-highlight="54-55,59-63" class="saurus-chunk"><h3 id="finding-the-session">Finding the Session</h3>
<p>Using the URL parameter for the session ID, we locate the session object the user is trying to modify in their browser. If one exists, we display the validation form, otherwise we return a 404 error.</p>
</section>
              <section style="display:none;" data-file="controllers/session.js" data-highlight="56-58" class="saurus-chunk"><h3 id="rendering-the-form">Rendering the Form</h3>
<p>With a valid session found, we render a Jade template, passing in the ID of the session we&apos;re trying to validate. Let&apos;s take a look at that template next.</p>
</section>
            </section>
            <section style="display:none;" data-title="Rendering the Verification Form: View" data-file="views/session/verify.jade" data-language="jade" data-overallStep='17' class="saurus-step">
              <section class="saurus-step-content"><h2 id="rendering-the-verification-form-view">Rendering the Verification Form: View</h2>
<p>On this form, the user can enter in their verification code from their mobile device, or request that a new code be sent to them. It should look a little something like this:</p>
<p><img src="./tutorial/images/confirm.png" alt="A form for validating the one-time password"></p>
</section>
              <section style="display:none;" data-file="views/session/verify.jade" data-highlight="13-20" class="saurus-chunk"><h3 id="the-form">The Form</h3>
<p>This form has a single field - the verification code that was sent to the user. This will send an HTTP POST to the server to potentially complete the login process.</p>
</section>
              <section style="display:none;" data-file="views/session/verify.jade" data-highlight="22-26" class="saurus-chunk"><h3 id="client-side-javascript">Client-Side JavaScript</h3>
<p>There was a second button on the form as well. When clicked, JavaScript will execute on the page to resend a new code to the user. Let&apos;s take a quick look at that script also.</p>
</section>
            </section>
            <section style="display:none;" data-title="Rendering the Verification Form: JS" data-file="public/resend.js" data-language="js" data-overallStep='18' class="saurus-step">
              <section class="saurus-step-content"><h2 id="resending-codes">Resending Codes</h2>
<p>We want to allow our users to request a new validation code in case they didn&apos;t initially have cell coverage when they got the call, or missed the message for some reason. This script will enable that with a bit of AJAX.</p>
</section>
              <section style="display:none;" data-file="public/resend.js" data-highlight="9-12,25" class="saurus-chunk"><h3 id="handling-the-button-click">Handling the Button Click</h3>
<p>We use <a href="http://jquery.com/">jQuery</a> to handle the click event for the second button on our form and disable the button until the resend request is complete.</p>
</section>
              <section style="display:none;" data-file="public/resend.js" data-highlight="14-24" class="saurus-chunk"><h3 id="requesting-a-new-code">Requesting a New Code</h3>
<p>We send an AJAX request to our server to generate a new code for this session. We won&apos;t go into the code that does this on the server-side - it just re-uses the same <code>sendVerification</code> instance function on the <code>Session</code> object we&apos;ve seen already, and returns a JSON response indicating a success or failure.  We use that data here to pop up an alert indicating that a new code has been sent.</p>
<p>Now, let&apos;s head back to the server side to see how we complete the login process.</p>
</section>
            </section>
            <section style="display:none;" data-title="Completing the Login Process" data-file="controllers/session.js" data-language="js" data-highlight="66-97" data-overallStep='19' class="saurus-step">
              <section class="saurus-step-content"><h2 id="completing-the-login-process">Completing the Login Process</h2>
<p>In our session controller, our next job is to validate the one-time code our user entered to complete the login process.</p>
</section>
              <section style="display:none;" data-file="controllers/session.js" data-highlight="70-91" class="saurus-chunk"><h3 id="validating-the-code">Validating the Code</h3>
<p>We start by comparing the entered code to the one we stored on the session model earlier - if they match up, we can finally validate their session!</p>
</section>
              <section style="display:none;" data-file="controllers/session.js" data-highlight="73-74,86" class="saurus-chunk"><h3 id="updating-the-session">Updating the Session</h3>
<p>Here, we flip the bit on the user&apos;s session and save it - this session can now be used to make authenticated requests against our application.</p>
</section>
              <section style="display:none;" data-file="controllers/session.js" data-highlight="81" class="saurus-chunk"><h3 id="saving-the-session-token">Saving the Session Token</h3>
<p>In order to authenticate future requests, we save a unique token string in the HTTP Session (via cookie storage), where our security middleware can access it. This will indicate that an incoming HTTP request has session state associated with it.</p>
</section>
              <section style="display:none;" data-file="controllers/session.js" data-highlight="80-84" class="saurus-chunk"><h3 id="rendering-the-user-profile-page">Rendering the User Profile Page</h3>
<p>Finally, we redirect to the secure user profile page:</p>
<p><img src="./tutorial/images/success.png" alt="A secure user profile page"></p>
<p>Awesome! Our user is now logged into the application.</p>
<p>Now that the user is logged in, how can we tell elsewhere in our application? On every request, we have configured middleware that will look for a session token on the incoming request to see if there is an authenticated user.  If there is, subsequent controllers can access our User&apos;s information and secure resources based on who is logged in.  Let&apos;s take a look at that middleware next.</p>
</section>
            </section>
            <section style="display:none;" data-title="Session Middleware" data-file="middleware/session.js" data-language="js" data-overallStep='20' class="saurus-step">
              <section class="saurus-step-content"><h2 id="session-middleware">Session Middleware</h2>
<p>Our session middleware allows us to detect whether or not HTTP requests to our app have an authenticated session associated with them.  We also have a middleware function that will automatically return a 403 Forbidden response if an unauthenticated user tries to access a protected URL.  Let&apos;s see how these middleware functions work.</p>
</section>
              <section style="display:none;" data-file="middleware/session.js" data-highlight="4-21" class="saurus-chunk"><h3 id="getting-the-user-for-a-session">Getting the User for a Session</h3>
<p>On each request, we look for a session token in the request object. If we have a valid <code>Session</code> associated with that token, we automatically fetch the <code>User</code> associated with it and make that data available on the request object so subsquent route controllers can access it.</p>
</section>
              <section style="display:none;" data-file="middleware/session.js" data-highlight="23-34" class="saurus-chunk"><h3 id="requiring-login-for-routes">Requiring Login for Routes</h3>
<p>This middleware function automates the process of restricting individual routes to logged in users.  We saw one example of this earlier, but if I wanted to ensure a visitor was logged in before executing my controller function, I could do the following:</p>
<pre><code>var sess = require(&quot;./middleware/session&apos;);

function handler(request, response) {
    response.send(&apos;you are logged in already!&apos;);
}

app.get(&apos;/sumpm/secure&apos;, sess.requireLogin(), handler);
</code></pre>
</section>
            </section>
            <section style="display:none;" data-title="The Story So Far" data-language="js" data-overallStep='21' class="saurus-step">
              <section class="saurus-step-content"><h2 id="the-story-so-far">The Story So Far</h2>
<p>With that, we&apos;ve managed to implement 2FA in our Express application! This is, of course, far from a battle-ready login system, but these will be the basic steps necessary to integrate 2FA into your existing login system.</p>
<p>Now that we understand the basics of implementing 2FA, let&apos;s explore a few more resources that will help you as you move 2FA into production.</p>
</section>
            </section>
          </section>
          <section data-title="Next Steps" class="saurus-chapter">
            <section style="display:none;" data-title="Making It Better" data-file="models/User.js" data-language="js" data-overallStep='22' class="saurus-step">
              <section class="saurus-step-content"><h2 id="making-it-better">Making It Better</h2>
<p>This tutorial should have oriented you on the basic steps necesssary to implement 2FA in your application, but there&apos;s more that you&apos;ll want to do with this code before it&apos;s truly ready for prime time. Let&apos;s call out a few of those TODO items.</p>
</section>
            </section>
            <section style="display:none;" data-title="Persistent User Accounts" data-file="models/User.js" data-language="js" data-overallStep='23' class="saurus-step">
              <section class="saurus-step-content"><h2 id="persistent-user-accounts">Persistent User Accounts</h2>
<p>We didn&apos;t introduce persistent user accounts in this tutorial, as we wanted to keep the focus on the 2FA flow rather than a database or login system. But if you&apos;re starting from scratch and looking to build an authentication system in Node with Express, here are a few options:</p>
<h3 id="passport">Passport</h3>
<p><a href="http://passportjs.org/">Passport</a> is an authentication middleware framework that works well with Express. It supports login schemes for GitHub, Facebook, local username/passwords, and more. If you&apos;re looking for more features out of the box, Passport might eb a good option for you.</p>
<h3 id="mongoose">Mongoose</h3>
<p>If you&apos;d prefer to create your own user models, you might check out <a href="http://mongoosejs.com/">Mongoose</a>, an object modeling framework for <a href="http://www.mongodb.org/">MongoDB</a>. The model objects in this tutorial were based very heavily on how you might implement those models using a framework like Mongoose.</p>
<p>There are <a href="http://miamicoder.com/2014/using-mongodb-and-mongoose-for-user-registration-login-and-logout-in-a-mobile-application/">a few</a> handy <a href="http://devsmash.com/blog/password-authentication-with-mongoose-and-bcrypt">tutorials</a> on how you might set up a User/Session model with Mongoose, on top of which you might consider adding 2FA.</p>
<h3 id="loopback">LoopBack</h3>
<p>If you&apos;d like to try a higher-level framework than Express, you might try <a href="http://loopback.io/">LoopBack</a>, which is built on top of it. It has a baked-in concept of a User model - you can <a href="https://github.com/strongloop/loopback-example-access-control">check out an example of it here</a>.</p>
<p>Every application&apos;s login needs are a little different, but the 2FA steps should be about the same no matter which solution you choose.</p>
</section>
            </section>
            <section style="display:none;" data-title="Don't Require 2FA Every Time" data-file="controllers/session.js" data-language="js" data-overallStep='24' class="saurus-step">
              <section class="saurus-step-content"><h2 id="don-apos-t-require-2fa-every-time">Don&apos;t Require 2FA Every Time</h2>
<p>Requiring a 2FA step on every login may not be the best choice for your application. You&apos;ll probably, at least for a given computer, want to only require 2FA every few weeks, or when the user is logging in from a new computer. The way that you would accomplish something like this is using cookies associated with a user of the application.</p>
<p>We are already using it in this application, but the <a href="https://github.com/expressjs/session#reqsessioncookie">session</a> middleware&apos;s cookie functionality should give you the tools you need to remember how and where your users have logged in. </p>
</section>
            </section>
            <section style="display:none;" data-title="User Account Verification" data-file="controllers/user.js" data-language="js" data-overallStep='25' class="saurus-step">
              <section class="saurus-step-content"><h2 id="user-account-verification">User Account Verification</h2>
<p>The same techniques you use for 2FA can also be used to verify new user accounts. You can send a one-time code to new users when they sign up to prove that they are human. This can increase the quality of your signups and lead to fewer wasted resources. Expect a tutorial on this topic very soon as well.</p>
</section>
            </section>
            <section style="display:none;" data-title="Let Us Help!" data-file="controllers/user.js" data-language="js" data-overallStep='26' class="saurus-step">
              <section class="saurus-step-content"><h2 id="let-us-help-">Let Us Help!</h2>
<p>If you&apos;d like to implement 2FA in your application and need a little assistance, we&apos;ve got your back! Send a note to <a href="mailto:help@twilio.com">help@twilio.com</a> and let us know what your needs are. We&apos;d love to help you get up and running.</p>
<p>Thanks for checking out this tutorial!</p>
</section>
            </section>
          </section>
        </div>
      </div>
      <div class="saurus-code">
        <div class="explorer-toggle"><i class="fa fa-chevron-left"></i></div>
        <div class="current-file">tfa-node &gt; <span>package.json</span></div>
        <div class="code-files">
          <div data-file="package.json" class="saurus-file"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span id="saurus-line-1"><a name="swl-1"></a><span class="p">{</span>
</span><span id="saurus-line-2"><a name="swl-2"></a>  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;tfa-node&quot;</span><span class="p">,</span>
</span><span id="saurus-line-3"><a name="swl-3"></a>  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
</span><span id="saurus-line-4"><a name="swl-4"></a>  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="saurus-line-5"><a name="swl-5"></a>  <span class="nt">&quot;main&quot;</span><span class="p">:</span> <span class="s2">&quot;index.js&quot;</span><span class="p">,</span>
</span><span id="saurus-line-6"><a name="swl-6"></a>  <span class="nt">&quot;scripts&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="saurus-line-7"><a name="swl-7"></a>    <span class="nt">&quot;test&quot;</span><span class="p">:</span> <span class="s2">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span>
</span><span id="saurus-line-8"><a name="swl-8"></a>  <span class="p">},</span>
</span><span id="saurus-line-9"><a name="swl-9"></a>  <span class="nt">&quot;engines&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="saurus-line-10"><a name="swl-10"></a>    <span class="nt">&quot;node&quot;</span><span class="p">:</span> <span class="s2">&quot;0.10.x&quot;</span>
</span><span id="saurus-line-11"><a name="swl-11"></a>  <span class="p">},</span>
</span><span id="saurus-line-12"><a name="swl-12"></a>  <span class="nt">&quot;author&quot;</span><span class="p">:</span> <span class="s2">&quot;Kevin Whinnery&quot;</span><span class="p">,</span>
</span><span id="saurus-line-13"><a name="swl-13"></a>  <span class="nt">&quot;license&quot;</span><span class="p">:</span> <span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
</span><span id="saurus-line-14"><a name="swl-14"></a>  <span class="nt">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="saurus-line-15"><a name="swl-15"></a>    <span class="nt">&quot;body-parser&quot;</span><span class="p">:</span> <span class="s2">&quot;^1.9.2&quot;</span><span class="p">,</span>
</span><span id="saurus-line-16"><a name="swl-16"></a>    <span class="nt">&quot;connect-flash&quot;</span><span class="p">:</span> <span class="s2">&quot;^0.1.1&quot;</span><span class="p">,</span>
</span><span id="saurus-line-17"><a name="swl-17"></a>    <span class="nt">&quot;csurf&quot;</span><span class="p">:</span> <span class="s2">&quot;^1.6.3&quot;</span><span class="p">,</span>
</span><span id="saurus-line-18"><a name="swl-18"></a>    <span class="nt">&quot;express&quot;</span><span class="p">:</span> <span class="s2">&quot;^4.10.2&quot;</span><span class="p">,</span>
</span><span id="saurus-line-19"><a name="swl-19"></a>    <span class="nt">&quot;express-session&quot;</span><span class="p">:</span> <span class="s2">&quot;^1.9.1&quot;</span><span class="p">,</span>
</span><span id="saurus-line-20"><a name="swl-20"></a>    <span class="nt">&quot;jade&quot;</span><span class="p">:</span> <span class="s2">&quot;^1.7.0&quot;</span><span class="p">,</span>
</span><span id="saurus-line-21"><a name="swl-21"></a>    <span class="nt">&quot;joi&quot;</span><span class="p">:</span> <span class="s2">&quot;^4.9.0&quot;</span><span class="p">,</span>
</span><span id="saurus-line-22"><a name="swl-22"></a>    <span class="nt">&quot;method-override&quot;</span><span class="p">:</span> <span class="s2">&quot;^2.3.0&quot;</span><span class="p">,</span>
</span><span id="saurus-line-23"><a name="swl-23"></a>    <span class="nt">&quot;morgan&quot;</span><span class="p">:</span> <span class="s2">&quot;^1.5.0&quot;</span><span class="p">,</span>
</span><span id="saurus-line-24"><a name="swl-24"></a>    <span class="nt">&quot;speakeasy&quot;</span><span class="p">:</span> <span class="s2">&quot;^1.0.3&quot;</span><span class="p">,</span>
</span><span id="saurus-line-25"><a name="swl-25"></a>    <span class="nt">&quot;twilio&quot;</span><span class="p">:</span> <span class="s2">&quot;^1.8.0&quot;</span>
</span><span id="saurus-line-26"><a name="swl-26"></a>  <span class="p">}</span>
</span><span id="saurus-line-27"><a name="swl-27"></a><span class="p">}</span>
</span></pre></div>
</td></tr></table></div>
          <div data-file="config.js" style="display:none;" class="saurus-file"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span id="saurus-line-1"><a name="swl-1"></a><span class="kd">var</span> <span class="nx">cfg</span> <span class="o">=</span> <span class="p">{};</span>
</span><span id="saurus-line-2"><a name="swl-2"></a>
</span><span id="saurus-line-3"><a name="swl-3"></a><span class="c1">// HTTP Port to run our web application</span>
</span><span id="saurus-line-4"><a name="swl-4"></a><span class="nx">cfg</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">;</span>
</span><span id="saurus-line-5"><a name="swl-5"></a>
</span><span id="saurus-line-6"><a name="swl-6"></a><span class="c1">// A random string that will help generate secure one-time passwords and</span>
</span><span id="saurus-line-7"><a name="swl-7"></a><span class="c1">// HTTP sessions</span>
</span><span id="saurus-line-8"><a name="swl-8"></a><span class="nx">cfg</span><span class="p">.</span><span class="nx">secret</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">APP_SECRET</span> <span class="o">||</span> <span class="s1">&#39;keyboard cat&#39;</span><span class="p">;</span>
</span><span id="saurus-line-9"><a name="swl-9"></a>
</span><span id="saurus-line-10"><a name="swl-10"></a><span class="c1">// Your Twilio account SID and auth token, both found at:</span>
</span><span id="saurus-line-11"><a name="swl-11"></a><span class="c1">// https://www.twilio.com/user/account</span>
</span><span id="saurus-line-12"><a name="swl-12"></a><span class="c1">// </span>
</span><span id="saurus-line-13"><a name="swl-13"></a><span class="c1">// A good practice is to store these string values as system environment</span>
</span><span id="saurus-line-14"><a name="swl-14"></a><span class="c1">// variables, and load them from there as we are doing below. Alternately,</span>
</span><span id="saurus-line-15"><a name="swl-15"></a><span class="c1">// you could hard code these values here as strings.</span>
</span><span id="saurus-line-16"><a name="swl-16"></a><span class="nx">cfg</span><span class="p">.</span><span class="nx">accountSid</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TWILIO_ACCOUNT_SID</span><span class="p">;</span>
</span><span id="saurus-line-17"><a name="swl-17"></a><span class="nx">cfg</span><span class="p">.</span><span class="nx">authToken</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TWILIO_AUTH_TOKEN</span><span class="p">;</span>
</span><span id="saurus-line-18"><a name="swl-18"></a>
</span><span id="saurus-line-19"><a name="swl-19"></a><span class="c1">// A Twilio number you control - choose one from:</span>
</span><span id="saurus-line-20"><a name="swl-20"></a><span class="c1">// https://www.twilio.com/user/account/phone-numbers/incoming</span>
</span><span id="saurus-line-21"><a name="swl-21"></a><span class="nx">cfg</span><span class="p">.</span><span class="nx">twilioNumber</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TWILIO_NUMBER</span><span class="p">;</span>
</span><span id="saurus-line-22"><a name="swl-22"></a>
</span><span id="saurus-line-23"><a name="swl-23"></a><span class="c1">// Export configuration object</span>
</span><span id="saurus-line-24"><a name="swl-24"></a><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">cfg</span><span class="p">;</span>
</span></pre></div>
</td></tr></table></div>
          <div data-file="index.js" style="display:none;" class="saurus-file"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span id="saurus-line-1"><a name="swl-1"></a><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
</span><span id="saurus-line-2"><a name="swl-2"></a><span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./config&#39;</span><span class="p">);</span>
</span><span id="saurus-line-3"><a name="swl-3"></a>
</span><span id="saurus-line-4"><a name="swl-4"></a><span class="c1">// Create Express web app</span>
</span><span id="saurus-line-5"><a name="swl-5"></a><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./webapp&#39;</span><span class="p">);</span>
</span><span id="saurus-line-6"><a name="swl-6"></a>
</span><span id="saurus-line-7"><a name="swl-7"></a><span class="c1">// Create an HTTP server and listen on the configured port</span>
</span><span id="saurus-line-8"><a name="swl-8"></a><span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</span><span id="saurus-line-9"><a name="swl-9"></a><span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span id="saurus-line-10"><a name="swl-10"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Express server listening on *:&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">port</span><span class="p">);</span>
</span><span id="saurus-line-11"><a name="swl-11"></a><span class="p">});</span>
</span></pre></div>
</td></tr></table></div>
          <div data-file="webapp.js" style="display:none;" class="saurus-file"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76</pre></div></td><td class="code"><div class="highlight"><pre><span id="saurus-line-1"><a name="swl-1"></a><span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
</span><span id="saurus-line-2"><a name="swl-2"></a><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
</span><span id="saurus-line-3"><a name="swl-3"></a><span class="kd">var</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;body-parser&#39;</span><span class="p">);</span>
</span><span id="saurus-line-4"><a name="swl-4"></a><span class="kd">var</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express-session&#39;</span><span class="p">);</span>
</span><span id="saurus-line-5"><a name="swl-5"></a><span class="kd">var</span> <span class="nx">morgan</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;morgan&#39;</span><span class="p">);</span>
</span><span id="saurus-line-6"><a name="swl-6"></a><span class="kd">var</span> <span class="nx">methodOverride</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;method-override&#39;</span><span class="p">);</span>
</span><span id="saurus-line-7"><a name="swl-7"></a><span class="kd">var</span> <span class="nx">flash</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./middleware/flash&#39;</span><span class="p">);</span>
</span><span id="saurus-line-8"><a name="swl-8"></a><span class="kd">var</span> <span class="nx">csrf</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./middleware/csrf&#39;</span><span class="p">);</span>
</span><span id="saurus-line-9"><a name="swl-9"></a><span class="kd">var</span> <span class="nx">userSession</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./middleware/session&#39;</span><span class="p">);</span>
</span><span id="saurus-line-10"><a name="swl-10"></a><span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./config&#39;</span><span class="p">);</span>
</span><span id="saurus-line-11"><a name="swl-11"></a>
</span><span id="saurus-line-12"><a name="swl-12"></a><span class="c1">// Create Express web app</span>
</span><span id="saurus-line-13"><a name="swl-13"></a><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
</span><span id="saurus-line-14"><a name="swl-14"></a><span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;view engine&#39;</span><span class="p">,</span> <span class="s1">&#39;jade&#39;</span><span class="p">);</span>
</span><span id="saurus-line-15"><a name="swl-15"></a>
</span><span id="saurus-line-16"><a name="swl-16"></a><span class="c1">// Use morgan for HTTP request logging</span>
</span><span id="saurus-line-17"><a name="swl-17"></a><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">morgan</span><span class="p">(</span><span class="s1">&#39;combined&#39;</span><span class="p">));</span>
</span><span id="saurus-line-18"><a name="swl-18"></a>
</span><span id="saurus-line-19"><a name="swl-19"></a><span class="c1">// Serve static assets</span>
</span><span id="saurus-line-20"><a name="swl-20"></a><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;public&#39;</span><span class="p">)));</span>
</span><span id="saurus-line-21"><a name="swl-21"></a>
</span><span id="saurus-line-22"><a name="swl-22"></a><span class="c1">// Override HTTP methods from a query parameter</span>
</span><span id="saurus-line-23"><a name="swl-23"></a><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">methodOverride</span><span class="p">(</span><span class="s1">&#39;_method&#39;</span><span class="p">));</span>
</span><span id="saurus-line-24"><a name="swl-24"></a>
</span><span id="saurus-line-25"><a name="swl-25"></a><span class="c1">// Parse incoming form-encoded HTTP bodies</span>
</span><span id="saurus-line-26"><a name="swl-26"></a><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span>
</span><span id="saurus-line-27"><a name="swl-27"></a>    <span class="nx">extended</span><span class="o">:</span> <span class="kc">true</span>
</span><span id="saurus-line-28"><a name="swl-28"></a><span class="p">}));</span>
</span><span id="saurus-line-29"><a name="swl-29"></a>
</span><span id="saurus-line-30"><a name="swl-30"></a><span class="c1">// Create and manage HTTP sessions for all requests</span>
</span><span id="saurus-line-31"><a name="swl-31"></a><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">session</span><span class="p">({</span>
</span><span id="saurus-line-32"><a name="swl-32"></a>    <span class="nx">secret</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">secret</span><span class="p">,</span>
</span><span id="saurus-line-33"><a name="swl-33"></a>    <span class="nx">resave</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span id="saurus-line-34"><a name="swl-34"></a>    <span class="nx">saveUninitialized</span><span class="o">:</span> <span class="kc">true</span>
</span><span id="saurus-line-35"><a name="swl-35"></a><span class="p">}));</span>
</span><span id="saurus-line-36"><a name="swl-36"></a>
</span><span id="saurus-line-37"><a name="swl-37"></a><span class="c1">// Configure middleware to manage &quot;flash&quot; messages</span>
</span><span id="saurus-line-38"><a name="swl-38"></a><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">flash</span><span class="p">());</span>
</span><span id="saurus-line-39"><a name="swl-39"></a><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">flash</span><span class="p">.</span><span class="nx">addLocals</span><span class="p">());</span>
</span><span id="saurus-line-40"><a name="swl-40"></a>
</span><span id="saurus-line-41"><a name="swl-41"></a><span class="c1">// Generate and handle CSRF tokens for all requests</span>
</span><span id="saurus-line-42"><a name="swl-42"></a><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">csrf</span><span class="p">());</span>
</span><span id="saurus-line-43"><a name="swl-43"></a><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">csrf</span><span class="p">.</span><span class="nx">addLocals</span><span class="p">());</span>
</span><span id="saurus-line-44"><a name="swl-44"></a>
</span><span id="saurus-line-45"><a name="swl-45"></a><span class="c1">// Mount middleware to add user to authenticated requests</span>
</span><span id="saurus-line-46"><a name="swl-46"></a><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">userSession</span><span class="p">());</span>
</span><span id="saurus-line-47"><a name="swl-47"></a>
</span><span id="saurus-line-48"><a name="swl-48"></a><span class="c1">// Configure application routes</span>
</span><span id="saurus-line-49"><a name="swl-49"></a><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./controllers/router&#39;</span><span class="p">)(</span><span class="nx">app</span><span class="p">);</span>
</span><span id="saurus-line-50"><a name="swl-50"></a>
</span><span id="saurus-line-51"><a name="swl-51"></a><span class="c1">// Handle 404</span>
</span><span id="saurus-line-52"><a name="swl-52"></a><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-53"><a name="swl-53"></a>    <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">);</span>
</span><span id="saurus-line-54"><a name="swl-54"></a>    <span class="nx">response</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;public&#39;</span><span class="p">,</span> <span class="s1">&#39;404.html&#39;</span><span class="p">));</span>
</span><span id="saurus-line-55"><a name="swl-55"></a><span class="p">});</span>
</span><span id="saurus-line-56"><a name="swl-56"></a>
</span><span id="saurus-line-57"><a name="swl-57"></a><span class="c1">// Unhandled errors (500)</span>
</span><span id="saurus-line-58"><a name="swl-58"></a><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-59"><a name="swl-59"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;An application error has occurred:&#39;</span><span class="p">);</span>
</span><span id="saurus-line-60"><a name="swl-60"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span id="saurus-line-61"><a name="swl-61"></a>    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
</span><span id="saurus-line-62"><a name="swl-62"></a>
</span><span id="saurus-line-63"><a name="swl-63"></a>    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="s1">&#39;EBADCSRFTOKEN&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-64"><a name="swl-64"></a>        <span class="c1">// Attempt to recover from a CSRF error</span>
</span><span id="saurus-line-65"><a name="swl-65"></a>        <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="s1">&#39;There was a problem with your request - please retry.&#39;</span><span class="p">;</span>
</span><span id="saurus-line-66"><a name="swl-66"></a>        <span class="nx">request</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;danger&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
</span><span id="saurus-line-67"><a name="swl-67"></a>        <span class="nx">response</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
</span><span id="saurus-line-68"><a name="swl-68"></a>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="saurus-line-69"><a name="swl-69"></a>        <span class="c1">// Otherwise serve error page</span>
</span><span id="saurus-line-70"><a name="swl-70"></a>        <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
</span><span id="saurus-line-71"><a name="swl-71"></a>        <span class="nx">response</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;public&#39;</span><span class="p">,</span> <span class="s1">&#39;500.html&#39;</span><span class="p">));</span>
</span><span id="saurus-line-72"><a name="swl-72"></a>    <span class="p">}</span>
</span><span id="saurus-line-73"><a name="swl-73"></a><span class="p">});</span>
</span><span id="saurus-line-74"><a name="swl-74"></a>
</span><span id="saurus-line-75"><a name="swl-75"></a><span class="c1">// Export Express app</span>
</span><span id="saurus-line-76"><a name="swl-76"></a><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">app</span><span class="p">;</span>
</span></pre></div>
</td></tr></table></div>
          <div data-file="models/User.js" style="display:none;" class="saurus-file"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91</pre></div></td><td class="code"><div class="highlight"><pre><span id="saurus-line-1"><a name="swl-1"></a><span class="kd">var</span> <span class="nx">Joi</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;joi&#39;</span><span class="p">);</span>
</span><span id="saurus-line-2"><a name="swl-2"></a>
</span><span id="saurus-line-3"><a name="swl-3"></a><span class="c1">// A mock database with users and passwords</span>
</span><span id="saurus-line-4"><a name="swl-4"></a><span class="kd">var</span> <span class="nx">database</span> <span class="o">=</span> <span class="p">{};</span>
</span><span id="saurus-line-5"><a name="swl-5"></a>
</span><span id="saurus-line-6"><a name="swl-6"></a><span class="c1">// A validation schema for user objects</span>
</span><span id="saurus-line-7"><a name="swl-7"></a><span class="kd">var</span> <span class="nx">UserSchema</span> <span class="o">=</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">object</span><span class="p">().</span><span class="nx">keys</span><span class="p">({</span>
</span><span id="saurus-line-8"><a name="swl-8"></a>    <span class="nx">username</span><span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">alphanum</span><span class="p">().</span><span class="nx">required</span><span class="p">(),</span>
</span><span id="saurus-line-9"><a name="swl-9"></a>    <span class="nx">fullName</span><span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">required</span><span class="p">(),</span>
</span><span id="saurus-line-10"><a name="swl-10"></a>    <span class="nx">password</span><span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">required</span><span class="p">(),</span>
</span><span id="saurus-line-11"><a name="swl-11"></a>    <span class="nx">phone</span><span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">string</span><span class="p">().</span><span class="nx">required</span><span class="p">(),</span>
</span><span id="saurus-line-12"><a name="swl-12"></a>    <span class="nx">contactType</span><span class="o">:</span> <span class="nx">Joi</span><span class="p">.</span><span class="nx">any</span><span class="p">().</span><span class="nx">allow</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;voice&#39;</span><span class="p">)</span>
</span><span id="saurus-line-13"><a name="swl-13"></a><span class="p">});</span>
</span><span id="saurus-line-14"><a name="swl-14"></a>
</span><span id="saurus-line-15"><a name="swl-15"></a><span class="c1">// A user model object</span>
</span><span id="saurus-line-16"><a name="swl-16"></a><span class="kd">function</span> <span class="nx">User</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">fullName</span><span class="p">,</span> <span class="nx">phone</span><span class="p">,</span> <span class="nx">contactType</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-17"><a name="swl-17"></a>    <span class="k">this</span><span class="p">.</span><span class="nx">username</span> <span class="o">=</span> <span class="nx">username</span><span class="p">;</span>
</span><span id="saurus-line-18"><a name="swl-18"></a>    <span class="k">this</span><span class="p">.</span><span class="nx">fullName</span> <span class="o">=</span> <span class="nx">fullName</span><span class="p">;</span>
</span><span id="saurus-line-19"><a name="swl-19"></a>    <span class="k">this</span><span class="p">.</span><span class="nx">phone</span> <span class="o">=</span> <span class="nx">phone</span><span class="p">;</span>
</span><span id="saurus-line-20"><a name="swl-20"></a>    <span class="k">this</span><span class="p">.</span><span class="nx">contactType</span> <span class="o">=</span> <span class="nx">contactType</span><span class="p">;</span>
</span><span id="saurus-line-21"><a name="swl-21"></a>    <span class="k">this</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">password</span><span class="p">;</span>
</span><span id="saurus-line-22"><a name="swl-22"></a><span class="p">}</span>
</span><span id="saurus-line-23"><a name="swl-23"></a>
</span><span id="saurus-line-24"><a name="swl-24"></a><span class="c1">// Create a &quot;save&quot; instance function to save the user to the database</span>
</span><span id="saurus-line-25"><a name="swl-25"></a><span class="nx">User</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">save</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-26"><a name="swl-26"></a>    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span id="saurus-line-27"><a name="swl-27"></a>
</span><span id="saurus-line-28"><a name="swl-28"></a>    <span class="c1">// Perform validation on object properties</span>
</span><span id="saurus-line-29"><a name="swl-29"></a>    <span class="nx">Joi</span><span class="p">.</span><span class="nx">validate</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">UserSchema</span><span class="p">,</span> <span class="p">{</span>
</span><span id="saurus-line-30"><a name="swl-30"></a>        <span class="nx">allowUnknown</span><span class="o">:</span> <span class="kc">true</span>
</span><span id="saurus-line-31"><a name="swl-31"></a>    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-32"><a name="swl-32"></a>        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
</span><span id="saurus-line-33"><a name="swl-33"></a>
</span><span id="saurus-line-34"><a name="swl-34"></a>        <span class="c1">// Check uniqueness of ID in the &quot;database&quot;</span>
</span><span id="saurus-line-35"><a name="swl-35"></a>        <span class="c1">// Username needs to be unique</span>
</span><span id="saurus-line-36"><a name="swl-36"></a>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">database</span><span class="p">[</span><span class="nx">self</span><span class="p">.</span><span class="nx">username</span><span class="p">])</span> <span class="p">{</span>
</span><span id="saurus-line-37"><a name="swl-37"></a>            <span class="nx">database</span><span class="p">[</span><span class="nx">self</span><span class="p">.</span><span class="nx">username</span><span class="p">]</span> <span class="o">=</span> <span class="nx">self</span><span class="p">;</span>
</span><span id="saurus-line-38"><a name="swl-38"></a>            <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">self</span><span class="p">);</span>
</span><span id="saurus-line-39"><a name="swl-39"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="saurus-line-40"><a name="swl-40"></a>            <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Username has been taken.&#39;</span><span class="p">));</span>
</span><span id="saurus-line-41"><a name="swl-41"></a>        <span class="p">}</span>
</span><span id="saurus-line-42"><a name="swl-42"></a>    <span class="p">});</span>
</span><span id="saurus-line-43"><a name="swl-43"></a><span class="p">};</span>
</span><span id="saurus-line-44"><a name="swl-44"></a>
</span><span id="saurus-line-45"><a name="swl-45"></a><span class="c1">// A &quot;class level&quot; function to test a username/password combo</span>
</span><span id="saurus-line-46"><a name="swl-46"></a><span class="nx">User</span><span class="p">.</span><span class="nx">login</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-47"><a name="swl-47"></a>    <span class="c1">// Create variables for a node-style callback</span>
</span><span id="saurus-line-48"><a name="swl-48"></a>    <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Username/password combination is invalid&#39;</span><span class="p">);</span>
</span><span id="saurus-line-49"><a name="swl-49"></a>    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span id="saurus-line-50"><a name="swl-50"></a>
</span><span id="saurus-line-51"><a name="swl-51"></a>    <span class="c1">// see if there&#39;s a user with the given username</span>
</span><span id="saurus-line-52"><a name="swl-52"></a>    <span class="kd">var</span> <span class="nx">candidateUser</span> <span class="o">=</span> <span class="nx">database</span><span class="p">[</span><span class="nx">username</span><span class="p">];</span>
</span><span id="saurus-line-53"><a name="swl-53"></a>
</span><span id="saurus-line-54"><a name="swl-54"></a>    <span class="c1">// If we have a user, check the password</span>
</span><span id="saurus-line-55"><a name="swl-55"></a>    <span class="k">if</span> <span class="p">(</span><span class="nx">candidateUser</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-56"><a name="swl-56"></a>        <span class="k">if</span> <span class="p">(</span><span class="nx">candidateUser</span><span class="p">.</span><span class="nx">password</span> <span class="o">===</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-57"><a name="swl-57"></a>            <span class="c1">// At this point, can reverse the error and hydrate a user object</span>
</span><span id="saurus-line-58"><a name="swl-58"></a>            <span class="nx">error</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span id="saurus-line-59"><a name="swl-59"></a>            <span class="nx">user</span> <span class="o">=</span> <span class="nx">candidateUser</span><span class="p">;</span>
</span><span id="saurus-line-60"><a name="swl-60"></a>        <span class="p">}</span>
</span><span id="saurus-line-61"><a name="swl-61"></a>    <span class="p">}</span>
</span><span id="saurus-line-62"><a name="swl-62"></a>
</span><span id="saurus-line-63"><a name="swl-63"></a>    <span class="c1">// Simulate a database round trip with a timer</span>
</span><span id="saurus-line-64"><a name="swl-64"></a>    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span id="saurus-line-65"><a name="swl-65"></a>        <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
</span><span id="saurus-line-66"><a name="swl-66"></a>    <span class="p">},</span> <span class="mi">50</span><span class="p">);</span>
</span><span id="saurus-line-67"><a name="swl-67"></a><span class="p">};</span>
</span><span id="saurus-line-68"><a name="swl-68"></a>
</span><span id="saurus-line-69"><a name="swl-69"></a><span class="c1">// Retrieve a user from our database by a given username</span>
</span><span id="saurus-line-70"><a name="swl-70"></a><span class="nx">User</span><span class="p">.</span><span class="nx">findByUsername</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-71"><a name="swl-71"></a>    <span class="c1">// Create variables for a node-style callback</span>
</span><span id="saurus-line-72"><a name="swl-72"></a>    <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;No user found for given ID.&#39;</span><span class="p">);</span>
</span><span id="saurus-line-73"><a name="swl-73"></a>    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span id="saurus-line-74"><a name="swl-74"></a>
</span><span id="saurus-line-75"><a name="swl-75"></a>    <span class="c1">// see if there&#39;s a user with the given username</span>
</span><span id="saurus-line-76"><a name="swl-76"></a>    <span class="kd">var</span> <span class="nx">candidateUser</span> <span class="o">=</span> <span class="nx">database</span><span class="p">[</span><span class="nx">username</span><span class="p">];</span>
</span><span id="saurus-line-77"><a name="swl-77"></a>
</span><span id="saurus-line-78"><a name="swl-78"></a>    <span class="c1">// If we have a user, hydrate a model object</span>
</span><span id="saurus-line-79"><a name="swl-79"></a>    <span class="k">if</span> <span class="p">(</span><span class="nx">candidateUser</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-80"><a name="swl-80"></a>        <span class="nx">error</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span id="saurus-line-81"><a name="swl-81"></a>        <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="nx">candidateUser</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="nx">candidateUser</span><span class="p">.</span><span class="nx">fullName</span><span class="p">);</span>
</span><span id="saurus-line-82"><a name="swl-82"></a>    <span class="p">}</span>
</span><span id="saurus-line-83"><a name="swl-83"></a>
</span><span id="saurus-line-84"><a name="swl-84"></a>    <span class="c1">// Simulate latency</span>
</span><span id="saurus-line-85"><a name="swl-85"></a>    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span id="saurus-line-86"><a name="swl-86"></a>        <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
</span><span id="saurus-line-87"><a name="swl-87"></a>    <span class="p">},</span> <span class="mi">50</span><span class="p">);</span>
</span><span id="saurus-line-88"><a name="swl-88"></a><span class="p">};</span>
</span><span id="saurus-line-89"><a name="swl-89"></a>
</span><span id="saurus-line-90"><a name="swl-90"></a><span class="c1">// Export user constructor as public interface</span>
</span><span id="saurus-line-91"><a name="swl-91"></a><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">User</span><span class="p">;</span>
</span></pre></div>
</td></tr></table></div>
          <div data-file="models/Session.js" style="display:none;" class="saurus-file"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161</pre></div></td><td class="code"><div class="highlight"><pre><span id="saurus-line-1"><a name="swl-1"></a><span class="kd">var</span> <span class="nx">speakeasy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;speakeasy&#39;</span><span class="p">);</span>
</span><span id="saurus-line-2"><a name="swl-2"></a><span class="kd">var</span> <span class="nx">twilio</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;twilio&#39;</span><span class="p">);</span>
</span><span id="saurus-line-3"><a name="swl-3"></a><span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../config&#39;</span><span class="p">);</span>
</span><span id="saurus-line-4"><a name="swl-4"></a>
</span><span id="saurus-line-5"><a name="swl-5"></a><span class="c1">// A mock database for authenticated sessions</span>
</span><span id="saurus-line-6"><a name="swl-6"></a><span class="kd">var</span> <span class="nx">database</span> <span class="o">=</span> <span class="p">{};</span>
</span><span id="saurus-line-7"><a name="swl-7"></a>
</span><span id="saurus-line-8"><a name="swl-8"></a><span class="c1">// Create an authenticated twilio REST API client</span>
</span><span id="saurus-line-9"><a name="swl-9"></a><span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">twilio</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">accountSid</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">authToken</span><span class="p">);</span>
</span><span id="saurus-line-10"><a name="swl-10"></a>
</span><span id="saurus-line-11"><a name="swl-11"></a><span class="c1">// A public service that simply echoes back TwiML that you pass it - we use</span>
</span><span id="saurus-line-12"><a name="swl-12"></a><span class="c1">// it here so we don&#39;t have to worry about knowing our app&#39;s URL ahead of time</span>
</span><span id="saurus-line-13"><a name="swl-13"></a><span class="kd">var</span> <span class="nx">twimlet</span> <span class="o">=</span> <span class="s1">&#39;http://twimlets.com/echo?Twiml=&#39;</span><span class="p">;</span>
</span><span id="saurus-line-14"><a name="swl-14"></a>
</span><span id="saurus-line-15"><a name="swl-15"></a><span class="c1">// Helper function to send out a code via twilio to a given number</span>
</span><span id="saurus-line-16"><a name="swl-16"></a><span class="kd">function</span> <span class="nx">sendCode</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-17"><a name="swl-17"></a>    <span class="c1">// Send the new token over the requested channel</span>
</span><span id="saurus-line-18"><a name="swl-18"></a>    <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;voice&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-19"><a name="swl-19"></a>        <span class="nx">client</span><span class="p">.</span><span class="nx">makeCall</span><span class="p">({</span>
</span><span id="saurus-line-20"><a name="swl-20"></a>            <span class="nx">to</span><span class="o">:</span> <span class="nx">number</span><span class="p">,</span>
</span><span id="saurus-line-21"><a name="swl-21"></a>            <span class="nx">from</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">twilioNumber</span><span class="p">,</span>
</span><span id="saurus-line-22"><a name="swl-22"></a>            <span class="nx">url</span><span class="o">:</span> <span class="nx">twimlet</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">readCode</span><span class="p">(</span><span class="nx">code</span><span class="p">))</span>
</span><span id="saurus-line-23"><a name="swl-23"></a>        <span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
</span><span id="saurus-line-24"><a name="swl-24"></a>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="saurus-line-25"><a name="swl-25"></a>        <span class="nx">client</span><span class="p">.</span><span class="nx">sendMessage</span><span class="p">({</span>
</span><span id="saurus-line-26"><a name="swl-26"></a>            <span class="nx">to</span><span class="o">:</span> <span class="nx">number</span><span class="p">,</span>
</span><span id="saurus-line-27"><a name="swl-27"></a>            <span class="nx">from</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">twilioNumber</span><span class="p">,</span>
</span><span id="saurus-line-28"><a name="swl-28"></a>            <span class="nx">body</span><span class="o">:</span> <span class="s1">&#39;Your confirmation code is: &#39;</span><span class="o">+</span> <span class="nx">code</span>
</span><span id="saurus-line-29"><a name="swl-29"></a>        <span class="p">},</span> <span class="nx">callback</span><span class="p">);</span>
</span><span id="saurus-line-30"><a name="swl-30"></a>    <span class="p">}</span>
</span><span id="saurus-line-31"><a name="swl-31"></a><span class="p">}</span>
</span><span id="saurus-line-32"><a name="swl-32"></a>
</span><span id="saurus-line-33"><a name="swl-33"></a><span class="c1">// Generate TwiML to read out a given confirmation code via TTS</span>
</span><span id="saurus-line-34"><a name="swl-34"></a><span class="kd">function</span> <span class="nx">readCode</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-35"><a name="swl-35"></a>    <span class="c1">// Split up numbers so the user can hear each one individually</span>
</span><span id="saurus-line-36"><a name="swl-36"></a>    <span class="kd">var</span> <span class="nx">numbers</span> <span class="o">=</span> <span class="nx">code</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span><span id="saurus-line-37"><a name="swl-37"></a>    <span class="kd">var</span> <span class="nx">twiml</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">twilio</span><span class="p">.</span><span class="nx">TwimlResponse</span><span class="p">();</span>
</span><span id="saurus-line-38"><a name="swl-38"></a>    <span class="nx">twiml</span><span class="p">.</span><span class="nx">say</span><span class="p">(</span><span class="s1">&#39;Your verification code is&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span id="saurus-line-39"><a name="swl-39"></a>        <span class="nx">voice</span><span class="o">:</span> <span class="s1">&#39;alice&#39;</span>
</span><span id="saurus-line-40"><a name="swl-40"></a>    <span class="p">});</span>
</span><span id="saurus-line-41"><a name="swl-41"></a>
</span><span id="saurus-line-42"><a name="swl-42"></a>    <span class="kd">function</span> <span class="nx">appendCode</span><span class="p">(</span><span class="nx">number</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-43"><a name="swl-43"></a>        <span class="nx">twiml</span><span class="p">.</span><span class="nx">say</span><span class="p">(</span><span class="nx">number</span><span class="p">,</span> <span class="p">{</span> <span class="nx">voice</span><span class="o">:</span> <span class="s1">&#39;alice&#39;</span> <span class="p">});</span>
</span><span id="saurus-line-44"><a name="swl-44"></a>    <span class="p">}</span>
</span><span id="saurus-line-45"><a name="swl-45"></a>
</span><span id="saurus-line-46"><a name="swl-46"></a>    <span class="c1">// Say the number once...</span>
</span><span id="saurus-line-47"><a name="swl-47"></a>    <span class="nx">numbers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">appendCode</span><span class="p">);</span>
</span><span id="saurus-line-48"><a name="swl-48"></a>
</span><span id="saurus-line-49"><a name="swl-49"></a>    <span class="c1">// Prompt again...</span>
</span><span id="saurus-line-50"><a name="swl-50"></a>    <span class="nx">twiml</span><span class="p">.</span><span class="nx">say</span><span class="p">(</span><span class="s1">&#39;Once again, your confirmation code is:&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span id="saurus-line-51"><a name="swl-51"></a>        <span class="nx">voice</span><span class="o">:</span> <span class="s1">&#39;alice&#39;</span>
</span><span id="saurus-line-52"><a name="swl-52"></a>    <span class="p">});</span>
</span><span id="saurus-line-53"><a name="swl-53"></a>
</span><span id="saurus-line-54"><a name="swl-54"></a>    <span class="c1">// Say the number again...</span>
</span><span id="saurus-line-55"><a name="swl-55"></a>    <span class="nx">numbers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">appendCode</span><span class="p">);</span>
</span><span id="saurus-line-56"><a name="swl-56"></a>
</span><span id="saurus-line-57"><a name="swl-57"></a>    <span class="c1">// Prompt again...</span>
</span><span id="saurus-line-58"><a name="swl-58"></a>    <span class="nx">twiml</span><span class="p">.</span><span class="nx">say</span><span class="p">(</span><span class="s1">&#39;One last time, your confirmation code is:&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span id="saurus-line-59"><a name="swl-59"></a>        <span class="nx">voice</span><span class="o">:</span> <span class="s1">&#39;alice&#39;</span>
</span><span id="saurus-line-60"><a name="swl-60"></a>    <span class="p">});</span>
</span><span id="saurus-line-61"><a name="swl-61"></a>
</span><span id="saurus-line-62"><a name="swl-62"></a>    <span class="c1">// Say the number a final time...</span>
</span><span id="saurus-line-63"><a name="swl-63"></a>    <span class="nx">numbers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">appendCode</span><span class="p">);</span>
</span><span id="saurus-line-64"><a name="swl-64"></a>
</span><span id="saurus-line-65"><a name="swl-65"></a>    <span class="c1">// Terminate the TwiML markup</span>
</span><span id="saurus-line-66"><a name="swl-66"></a>    <span class="nx">twiml</span><span class="p">.</span><span class="nx">say</span><span class="p">(</span><span class="s1">&#39;Thank you!&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">voice</span><span class="o">:</span> <span class="s1">&#39;alice&#39;</span> <span class="p">});</span>
</span><span id="saurus-line-67"><a name="swl-67"></a>
</span><span id="saurus-line-68"><a name="swl-68"></a>    <span class="k">return</span> <span class="nx">twiml</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
</span><span id="saurus-line-69"><a name="swl-69"></a><span class="p">}</span>
</span><span id="saurus-line-70"><a name="swl-70"></a>
</span><span id="saurus-line-71"><a name="swl-71"></a><span class="c1">// Create a session for a given unique user, with a randomly generated ID</span>
</span><span id="saurus-line-72"><a name="swl-72"></a><span class="c1">// to identify it and another to store in session</span>
</span><span id="saurus-line-73"><a name="swl-73"></a><span class="kd">function</span> <span class="nx">Session</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-74"><a name="swl-74"></a>    <span class="k">this</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">user</span><span class="p">;</span>
</span><span id="saurus-line-75"><a name="swl-75"></a>    <span class="k">this</span><span class="p">.</span><span class="nx">verified</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span id="saurus-line-76"><a name="swl-76"></a>    <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">speakeasy</span><span class="p">.</span><span class="nx">generate_key</span><span class="p">({</span>
</span><span id="saurus-line-77"><a name="swl-77"></a>        <span class="nx">length</span><span class="o">:</span> <span class="mi">32</span>
</span><span id="saurus-line-78"><a name="swl-78"></a>    <span class="p">}).</span><span class="nx">hex</span><span class="p">;</span>
</span><span id="saurus-line-79"><a name="swl-79"></a>    <span class="k">this</span><span class="p">.</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">speakeasy</span><span class="p">.</span><span class="nx">generate_key</span><span class="p">({</span>
</span><span id="saurus-line-80"><a name="swl-80"></a>        <span class="nx">length</span><span class="o">:</span> <span class="mi">64</span>
</span><span id="saurus-line-81"><a name="swl-81"></a>    <span class="p">}).</span><span class="nx">hex</span><span class="p">;</span>
</span><span id="saurus-line-82"><a name="swl-82"></a><span class="p">}</span>
</span><span id="saurus-line-83"><a name="swl-83"></a>
</span><span id="saurus-line-84"><a name="swl-84"></a><span class="c1">// Save a given session to our &quot;database&quot;</span>
</span><span id="saurus-line-85"><a name="swl-85"></a><span class="nx">Session</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">save</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-86"><a name="swl-86"></a>    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span id="saurus-line-87"><a name="swl-87"></a>    <span class="nx">database</span><span class="p">[</span><span class="nx">self</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">self</span><span class="p">;</span>
</span><span id="saurus-line-88"><a name="swl-88"></a>
</span><span id="saurus-line-89"><a name="swl-89"></a>    <span class="c1">// simulate latency</span>
</span><span id="saurus-line-90"><a name="swl-90"></a>    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span id="saurus-line-91"><a name="swl-91"></a>        <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">self</span><span class="p">);</span>
</span><span id="saurus-line-92"><a name="swl-92"></a>    <span class="p">},</span> <span class="mi">50</span><span class="p">);</span>
</span><span id="saurus-line-93"><a name="swl-93"></a><span class="p">};</span>
</span><span id="saurus-line-94"><a name="swl-94"></a>
</span><span id="saurus-line-95"><a name="swl-95"></a><span class="c1">// Send a one-time password to the phone associated with the user</span>
</span><span id="saurus-line-96"><a name="swl-96"></a><span class="nx">Session</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sendVerification</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-97"><a name="swl-97"></a>    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span id="saurus-line-98"><a name="swl-98"></a>
</span><span id="saurus-line-99"><a name="swl-99"></a>    <span class="c1">// generate a time-based one-time password</span>
</span><span id="saurus-line-100"><a name="swl-100"></a>    <span class="nx">self</span><span class="p">.</span><span class="nx">oneTimePassword</span> <span class="o">=</span> <span class="nx">speakeasy</span><span class="p">.</span><span class="nx">totp</span><span class="p">({</span>
</span><span id="saurus-line-101"><a name="swl-101"></a>        <span class="nx">key</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">secret</span>
</span><span id="saurus-line-102"><a name="swl-102"></a>    <span class="p">});</span>
</span><span id="saurus-line-103"><a name="swl-103"></a>
</span><span id="saurus-line-104"><a name="swl-104"></a>    <span class="c1">// Send the code to the user&#39;s phone</span>
</span><span id="saurus-line-105"><a name="swl-105"></a>    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
</span><span id="saurus-line-106"><a name="swl-106"></a>    <span class="nx">sendCode</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">oneTimePassword</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">contactType</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">phone</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
</span><span id="saurus-line-107"><a name="swl-107"></a><span class="p">};</span>
</span><span id="saurus-line-108"><a name="swl-108"></a>
</span><span id="saurus-line-109"><a name="swl-109"></a><span class="c1">// Check to see if a given session exists</span>
</span><span id="saurus-line-110"><a name="swl-110"></a><span class="nx">Session</span><span class="p">.</span><span class="nx">findById</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sessionId</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-111"><a name="swl-111"></a>    <span class="c1">// Create node-style callback arguments</span>
</span><span id="saurus-line-112"><a name="swl-112"></a>    <span class="kd">var</span> <span class="nx">error</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;No session found by the given ID.&#39;</span><span class="p">);</span>
</span><span id="saurus-line-113"><a name="swl-113"></a>    <span class="kd">var</span> <span class="nx">session</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span id="saurus-line-114"><a name="swl-114"></a>
</span><span id="saurus-line-115"><a name="swl-115"></a>    <span class="c1">// Check for the given session id in our &quot;database&quot;</span>
</span><span id="saurus-line-116"><a name="swl-116"></a>    <span class="k">if</span> <span class="p">(</span><span class="nx">database</span><span class="p">[</span><span class="nx">sessionId</span><span class="p">])</span> <span class="p">{</span>
</span><span id="saurus-line-117"><a name="swl-117"></a>        <span class="nx">error</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span id="saurus-line-118"><a name="swl-118"></a>        <span class="nx">session</span> <span class="o">=</span> <span class="nx">database</span><span class="p">[</span><span class="nx">sessionId</span><span class="p">];</span>
</span><span id="saurus-line-119"><a name="swl-119"></a>    <span class="p">}</span>
</span><span id="saurus-line-120"><a name="swl-120"></a>
</span><span id="saurus-line-121"><a name="swl-121"></a>    <span class="c1">// simulate latency and trigger callback</span>
</span><span id="saurus-line-122"><a name="swl-122"></a>    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span id="saurus-line-123"><a name="swl-123"></a>        <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">session</span><span class="p">);</span>
</span><span id="saurus-line-124"><a name="swl-124"></a>    <span class="p">},</span> <span class="mi">50</span><span class="p">);</span>
</span><span id="saurus-line-125"><a name="swl-125"></a><span class="p">};</span>
</span><span id="saurus-line-126"><a name="swl-126"></a>
</span><span id="saurus-line-127"><a name="swl-127"></a><span class="c1">// Find a session by the given token</span>
</span><span id="saurus-line-128"><a name="swl-128"></a><span class="nx">Session</span><span class="p">.</span><span class="nx">findByToken</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-129"><a name="swl-129"></a>    <span class="kd">var</span> <span class="nx">session</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span id="saurus-line-130"><a name="swl-130"></a>
</span><span id="saurus-line-131"><a name="swl-131"></a>    <span class="c1">// Loop through session &quot;database&quot; and see if we have a session with that</span>
</span><span id="saurus-line-132"><a name="swl-132"></a>    <span class="c1">// token</span>
</span><span id="saurus-line-133"><a name="swl-133"></a>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">s</span> <span class="k">in</span> <span class="nx">database</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-134"><a name="swl-134"></a>        <span class="k">if</span> <span class="p">(</span><span class="nx">database</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span> <span class="p">{</span>
</span><span id="saurus-line-135"><a name="swl-135"></a>            <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">database</span><span class="p">[</span><span class="nx">s</span><span class="p">];</span>
</span><span id="saurus-line-136"><a name="swl-136"></a>            <span class="k">if</span> <span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">token</span> <span class="o">===</span> <span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-137"><a name="swl-137"></a>                <span class="nx">session</span> <span class="o">=</span> <span class="nx">current</span><span class="p">;</span>
</span><span id="saurus-line-138"><a name="swl-138"></a>                <span class="k">break</span><span class="p">;</span>
</span><span id="saurus-line-139"><a name="swl-139"></a>            <span class="p">}</span>
</span><span id="saurus-line-140"><a name="swl-140"></a>        <span class="p">}</span>
</span><span id="saurus-line-141"><a name="swl-141"></a>    <span class="p">}</span>
</span><span id="saurus-line-142"><a name="swl-142"></a>
</span><span id="saurus-line-143"><a name="swl-143"></a>    <span class="c1">// simulate latency and trigger callback</span>
</span><span id="saurus-line-144"><a name="swl-144"></a>    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span id="saurus-line-145"><a name="swl-145"></a>        <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">session</span><span class="p">);</span>
</span><span id="saurus-line-146"><a name="swl-146"></a>    <span class="p">},</span> <span class="mi">50</span><span class="p">);</span>
</span><span id="saurus-line-147"><a name="swl-147"></a><span class="p">};</span>
</span><span id="saurus-line-148"><a name="swl-148"></a>
</span><span id="saurus-line-149"><a name="swl-149"></a><span class="c1">// Remove a session from the database</span>
</span><span id="saurus-line-150"><a name="swl-150"></a><span class="nx">Session</span><span class="p">.</span><span class="nx">destroy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sessionId</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-151"><a name="swl-151"></a>    <span class="c1">// If it exists, remove it</span>
</span><span id="saurus-line-152"><a name="swl-152"></a>    <span class="k">if</span> <span class="p">(</span><span class="nx">database</span><span class="p">[</span><span class="nx">sessionId</span><span class="p">])</span> <span class="p">{</span>
</span><span id="saurus-line-153"><a name="swl-153"></a>        <span class="k">delete</span> <span class="nx">database</span><span class="p">[</span><span class="nx">sessionId</span><span class="p">];</span>
</span><span id="saurus-line-154"><a name="swl-154"></a>    <span class="p">}</span>
</span><span id="saurus-line-155"><a name="swl-155"></a>
</span><span id="saurus-line-156"><a name="swl-156"></a>    <span class="c1">// always succeeds</span>
</span><span id="saurus-line-157"><a name="swl-157"></a>    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
</span><span id="saurus-line-158"><a name="swl-158"></a><span class="p">};</span>
</span><span id="saurus-line-159"><a name="swl-159"></a>
</span><span id="saurus-line-160"><a name="swl-160"></a><span class="c1">// Export user constructor as public interface</span>
</span><span id="saurus-line-161"><a name="swl-161"></a><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Session</span><span class="p">;</span>
</span></pre></div>
</td></tr></table></div>
          <div data-file="controllers/router.js" style="display:none;" class="saurus-file"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span id="saurus-line-1"><a name="swl-1"></a><span class="kd">var</span> <span class="nx">pages</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./pages&#39;</span><span class="p">);</span>
</span><span id="saurus-line-2"><a name="swl-2"></a><span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./user&#39;</span><span class="p">);</span>
</span><span id="saurus-line-3"><a name="swl-3"></a><span class="kd">var</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./session&#39;</span><span class="p">);</span>
</span><span id="saurus-line-4"><a name="swl-4"></a><span class="kd">var</span> <span class="nx">userSession</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../middleware/session&#39;</span><span class="p">);</span>
</span><span id="saurus-line-5"><a name="swl-5"></a>
</span><span id="saurus-line-6"><a name="swl-6"></a><span class="c1">// Map routes to controller functions</span>
</span><span id="saurus-line-7"><a name="swl-7"></a><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-8"><a name="swl-8"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">pages</span><span class="p">.</span><span class="nx">home</span><span class="p">);</span>
</span><span id="saurus-line-9"><a name="swl-9"></a>
</span><span id="saurus-line-10"><a name="swl-10"></a>    <span class="c1">// User routes</span>
</span><span id="saurus-line-11"><a name="swl-11"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/users/new&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">showCreate</span><span class="p">);</span>
</span><span id="saurus-line-12"><a name="swl-12"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/users/:username&#39;</span><span class="p">,</span> <span class="nx">userSession</span><span class="p">.</span><span class="nx">requireLogin</span><span class="p">(),</span> <span class="nx">user</span><span class="p">.</span><span class="nx">showUser</span><span class="p">);</span>
</span><span id="saurus-line-13"><a name="swl-13"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">create</span><span class="p">);</span>
</span><span id="saurus-line-14"><a name="swl-14"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/signup&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">showCreate</span><span class="p">);</span>
</span><span id="saurus-line-15"><a name="swl-15"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/signup&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">create</span><span class="p">);</span>
</span><span id="saurus-line-16"><a name="swl-16"></a>
</span><span id="saurus-line-17"><a name="swl-17"></a>    <span class="c1">// Session routes</span>
</span><span id="saurus-line-18"><a name="swl-18"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/sessions/new&#39;</span><span class="p">,</span> <span class="nx">session</span><span class="p">.</span><span class="nx">showCreate</span><span class="p">);</span>
</span><span id="saurus-line-19"><a name="swl-19"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/sessions/verify/:id&#39;</span><span class="p">,</span> <span class="nx">session</span><span class="p">.</span><span class="nx">showVerify</span><span class="p">);</span>
</span><span id="saurus-line-20"><a name="swl-20"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/sessions&#39;</span><span class="p">,</span> <span class="nx">session</span><span class="p">.</span><span class="nx">create</span><span class="p">);</span>
</span><span id="saurus-line-21"><a name="swl-21"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/sessions/verify/:id&#39;</span><span class="p">,</span> <span class="nx">session</span><span class="p">.</span><span class="nx">verify</span><span class="p">);</span>
</span><span id="saurus-line-22"><a name="swl-22"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/sessions/verify/:id/resend&#39;</span><span class="p">,</span> <span class="nx">session</span><span class="p">.</span><span class="nx">ajaxResendCode</span><span class="p">);</span>
</span><span id="saurus-line-23"><a name="swl-23"></a>    <span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;/sessions&#39;</span><span class="p">,</span> <span class="nx">session</span><span class="p">.</span><span class="nx">destroy</span><span class="p">);</span>
</span><span id="saurus-line-24"><a name="swl-24"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="nx">session</span><span class="p">.</span><span class="nx">showCreate</span><span class="p">);</span>
</span><span id="saurus-line-25"><a name="swl-25"></a>    <span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="nx">session</span><span class="p">.</span><span class="nx">create</span><span class="p">);</span>
</span><span id="saurus-line-26"><a name="swl-26"></a>    <span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">,</span> <span class="nx">session</span><span class="p">.</span><span class="nx">destroy</span><span class="p">);</span>
</span><span id="saurus-line-27"><a name="swl-27"></a><span class="p">};</span>
</span></pre></div>
</td></tr></table></div>
          <div data-file="controllers/session.js" style="display:none;" class="saurus-file"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149</pre></div></td><td class="code"><div class="highlight"><pre><span id="saurus-line-1"><a name="swl-1"></a><span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/User&#39;</span><span class="p">);</span>
</span><span id="saurus-line-2"><a name="swl-2"></a><span class="kd">var</span> <span class="nx">Session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/Session&#39;</span><span class="p">);</span>
</span><span id="saurus-line-3"><a name="swl-3"></a>
</span><span id="saurus-line-4"><a name="swl-4"></a><span class="c1">// Render a page with a login form</span>
</span><span id="saurus-line-5"><a name="swl-5"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">showCreate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-6"><a name="swl-6"></a>    <span class="nx">response</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;session/create&#39;</span><span class="p">);</span>
</span><span id="saurus-line-7"><a name="swl-7"></a><span class="p">};</span>
</span><span id="saurus-line-8"><a name="swl-8"></a>
</span><span id="saurus-line-9"><a name="swl-9"></a><span class="c1">// Handle a login request from the user and create an authenticated session</span>
</span><span id="saurus-line-10"><a name="swl-10"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-11"><a name="swl-11"></a>    <span class="c1">// Get POST parameters</span>
</span><span id="saurus-line-12"><a name="swl-12"></a>    <span class="kd">var</span> <span class="nx">un</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">);</span>
</span><span id="saurus-line-13"><a name="swl-13"></a>    <span class="kd">var</span> <span class="nx">pw</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">);</span>
</span><span id="saurus-line-14"><a name="swl-14"></a>
</span><span id="saurus-line-15"><a name="swl-15"></a>    <span class="c1">// Test credentials</span>
</span><span id="saurus-line-16"><a name="swl-16"></a>    <span class="nx">User</span><span class="p">.</span><span class="nx">login</span><span class="p">(</span><span class="nx">un</span><span class="p">,</span> <span class="nx">pw</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-17"><a name="swl-17"></a>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span> <span class="o">&amp;&amp;</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-18"><a name="swl-18"></a>            <span class="c1">// If password was correct, create a new session for the user</span>
</span><span id="saurus-line-19"><a name="swl-19"></a>            <span class="kd">var</span> <span class="nx">sess</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Session</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
</span><span id="saurus-line-20"><a name="swl-20"></a>
</span><span id="saurus-line-21"><a name="swl-21"></a>            <span class="c1">// Save the session object, then do the 2FA step</span>
</span><span id="saurus-line-22"><a name="swl-22"></a>            <span class="nx">sess</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">newSession</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-23"><a name="swl-23"></a>                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-24"><a name="swl-24"></a>                    <span class="nx">request</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;danger&#39;</span><span class="p">,</span> <span class="s1">&#39;There was a problem logging&#39;</span>
</span><span id="saurus-line-25"><a name="swl-25"></a>                        <span class="o">+</span> <span class="s1">&#39; you in - please try again.&#39;</span><span class="p">);</span>
</span><span id="saurus-line-26"><a name="swl-26"></a>                    <span class="nx">response</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
</span><span id="saurus-line-27"><a name="swl-27"></a>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="saurus-line-28"><a name="swl-28"></a>                    <span class="c1">// if all is well, proceed to second auth step and send</span>
</span><span id="saurus-line-29"><a name="swl-29"></a>                    <span class="c1">// a one-time password to the user&#39;s phone</span>
</span><span id="saurus-line-30"><a name="swl-30"></a>                    <span class="nx">newSession</span><span class="p">.</span><span class="nx">sendVerification</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-31"><a name="swl-31"></a>                        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-32"><a name="swl-32"></a>                            <span class="nx">request</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;danger&#39;</span><span class="p">,</span> <span class="s1">&#39;Error sending validation &#39;</span>
</span><span id="saurus-line-33"><a name="swl-33"></a>                                <span class="o">+</span> <span class="s1">&#39;code - please try again.&#39;</span><span class="p">);</span>
</span><span id="saurus-line-34"><a name="swl-34"></a>                            <span class="nx">response</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
</span><span id="saurus-line-35"><a name="swl-35"></a>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="saurus-line-36"><a name="swl-36"></a>                            <span class="c1">// If the code was sent successfully, show the</span>
</span><span id="saurus-line-37"><a name="swl-37"></a>                            <span class="c1">// verification page</span>
</span><span id="saurus-line-38"><a name="swl-38"></a>                            <span class="nx">response</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/sessions/verify/&#39;</span>
</span><span id="saurus-line-39"><a name="swl-39"></a>                                <span class="o">+</span> <span class="nx">newSession</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span id="saurus-line-40"><a name="swl-40"></a>                        <span class="p">}</span>
</span><span id="saurus-line-41"><a name="swl-41"></a>                    <span class="p">});</span>
</span><span id="saurus-line-42"><a name="swl-42"></a>                <span class="p">}</span>
</span><span id="saurus-line-43"><a name="swl-43"></a>            <span class="p">});</span>
</span><span id="saurus-line-44"><a name="swl-44"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="saurus-line-45"><a name="swl-45"></a>            <span class="c1">// Otherwise, give error and retry</span>
</span><span id="saurus-line-46"><a name="swl-46"></a>            <span class="nx">request</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;danger&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
</span><span id="saurus-line-47"><a name="swl-47"></a>            <span class="nx">response</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
</span><span id="saurus-line-48"><a name="swl-48"></a>        <span class="p">}</span>
</span><span id="saurus-line-49"><a name="swl-49"></a>    <span class="p">});</span>
</span><span id="saurus-line-50"><a name="swl-50"></a><span class="p">};</span>
</span><span id="saurus-line-51"><a name="swl-51"></a>
</span><span id="saurus-line-52"><a name="swl-52"></a><span class="c1">// Show a form where the user can enter a one-time validation password</span>
</span><span id="saurus-line-53"><a name="swl-53"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">showVerify</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-54"><a name="swl-54"></a>    <span class="nx">Session</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-55"><a name="swl-55"></a>        <span class="k">if</span> <span class="p">(</span><span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-56"><a name="swl-56"></a>            <span class="nx">response</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;session/verify&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span id="saurus-line-57"><a name="swl-57"></a>                <span class="nx">sessionId</span><span class="o">:</span> <span class="nx">request</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
</span><span id="saurus-line-58"><a name="swl-58"></a>            <span class="p">});</span>
</span><span id="saurus-line-59"><a name="swl-59"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="saurus-line-60"><a name="swl-60"></a>            <span class="c1">// 404</span>
</span><span id="saurus-line-61"><a name="swl-61"></a>            <span class="nx">next</span><span class="p">();</span>
</span><span id="saurus-line-62"><a name="swl-62"></a>        <span class="p">}</span>
</span><span id="saurus-line-63"><a name="swl-63"></a>    <span class="p">});</span>
</span><span id="saurus-line-64"><a name="swl-64"></a><span class="p">};</span>
</span><span id="saurus-line-65"><a name="swl-65"></a>
</span><span id="saurus-line-66"><a name="swl-66"></a><span class="c1">// Handle a session validation request</span>
</span><span id="saurus-line-67"><a name="swl-67"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">verify</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-68"><a name="swl-68"></a>    <span class="nx">Session</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-69"><a name="swl-69"></a>        <span class="k">if</span> <span class="p">(</span><span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-70"><a name="swl-70"></a>            <span class="c1">// If we have a session, try to validate it with the code passed</span>
</span><span id="saurus-line-71"><a name="swl-71"></a>            <span class="c1">// in to the form</span>
</span><span id="saurus-line-72"><a name="swl-72"></a>            <span class="k">if</span> <span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">oneTimePassword</span> <span class="o">==</span> <span class="nx">request</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">).</span><span class="nx">trim</span><span class="p">())</span> <span class="p">{</span>
</span><span id="saurus-line-73"><a name="swl-73"></a>                <span class="nx">session</span><span class="p">.</span><span class="nx">verified</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span id="saurus-line-74"><a name="swl-74"></a>                <span class="nx">session</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-75"><a name="swl-75"></a>                    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-76"><a name="swl-76"></a>                        <span class="nx">request</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;danger&#39;</span><span class="p">,</span> <span class="s1">&#39;There was a problem verifying&#39;</span>
</span><span id="saurus-line-77"><a name="swl-77"></a>                            <span class="o">+</span> <span class="s1">&#39; your code, please re-enter it.&#39;</span><span class="p">);</span>
</span><span id="saurus-line-78"><a name="swl-78"></a>                        <span class="nx">response</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/sessions/verify/&#39;</span><span class="o">+</span><span class="nx">session</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span id="saurus-line-79"><a name="swl-79"></a>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="saurus-line-80"><a name="swl-80"></a>                        <span class="c1">// if all is well, create a session for the user</span>
</span><span id="saurus-line-81"><a name="swl-81"></a>                        <span class="nx">request</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">sessionToken</span> <span class="o">=</span> <span class="nx">session</span><span class="p">.</span><span class="nx">token</span><span class="p">;</span>
</span><span id="saurus-line-82"><a name="swl-82"></a>                        <span class="nx">request</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="s1">&#39;Welcome back, &#39;</span>
</span><span id="saurus-line-83"><a name="swl-83"></a>                            <span class="o">+</span> <span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">fullName</span> <span class="o">+</span> <span class="s1">&#39;!&#39;</span><span class="p">);</span>
</span><span id="saurus-line-84"><a name="swl-84"></a>                        <span class="nx">response</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/users/&#39;</span><span class="o">+</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">);</span>
</span><span id="saurus-line-85"><a name="swl-85"></a>                    <span class="p">}</span>
</span><span id="saurus-line-86"><a name="swl-86"></a>                <span class="p">});</span>
</span><span id="saurus-line-87"><a name="swl-87"></a>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="saurus-line-88"><a name="swl-88"></a>                <span class="nx">request</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;danger&#39;</span><span class="p">,</span> <span class="s1">&#39;Verification code incorrect, please &#39;</span>
</span><span id="saurus-line-89"><a name="swl-89"></a>                    <span class="o">+</span> <span class="s1">&#39;re-enter your code or send yourself a new one.&#39;</span><span class="p">);</span>
</span><span id="saurus-line-90"><a name="swl-90"></a>                <span class="nx">response</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/sessions/verify/&#39;</span><span class="o">+</span><span class="nx">session</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span id="saurus-line-91"><a name="swl-91"></a>            <span class="p">}</span>
</span><span id="saurus-line-92"><a name="swl-92"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="saurus-line-93"><a name="swl-93"></a>            <span class="c1">// 404</span>
</span><span id="saurus-line-94"><a name="swl-94"></a>            <span class="nx">next</span><span class="p">();</span>
</span><span id="saurus-line-95"><a name="swl-95"></a>        <span class="p">}</span>
</span><span id="saurus-line-96"><a name="swl-96"></a>    <span class="p">});</span>
</span><span id="saurus-line-97"><a name="swl-97"></a><span class="p">};</span>
</span><span id="saurus-line-98"><a name="swl-98"></a>
</span><span id="saurus-line-99"><a name="swl-99"></a><span class="c1">// Re-send a verification code for the given Session</span>
</span><span id="saurus-line-100"><a name="swl-100"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">ajaxResendCode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-101"><a name="swl-101"></a>    <span class="nx">Session</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-102"><a name="swl-102"></a>        <span class="k">if</span> <span class="p">(</span><span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-103"><a name="swl-103"></a>            <span class="c1">// Try to resend verification code</span>
</span><span id="saurus-line-104"><a name="swl-104"></a>            <span class="nx">session</span><span class="p">.</span><span class="nx">sendVerification</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-105"><a name="swl-105"></a>                <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="s1">&#39;Code has been sent.&#39;</span><span class="p">;</span>
</span><span id="saurus-line-106"><a name="swl-106"></a>                <span class="kd">var</span> <span class="nx">success</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span id="saurus-line-107"><a name="swl-107"></a>
</span><span id="saurus-line-108"><a name="swl-108"></a>                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-109"><a name="swl-109"></a>                    <span class="nx">message</span> <span class="o">=</span> <span class="s1">&#39;There was a problem sending your code, please &#39;</span>
</span><span id="saurus-line-110"><a name="swl-110"></a>                        <span class="o">+</span> <span class="s1">&#39;try again.&#39;</span><span class="p">;</span>
</span><span id="saurus-line-111"><a name="swl-111"></a>                    <span class="nx">success</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span id="saurus-line-112"><a name="swl-112"></a>                <span class="p">}</span>
</span><span id="saurus-line-113"><a name="swl-113"></a>
</span><span id="saurus-line-114"><a name="swl-114"></a>                <span class="c1">// Send JSON response</span>
</span><span id="saurus-line-115"><a name="swl-115"></a>                <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
</span><span id="saurus-line-116"><a name="swl-116"></a>                    <span class="nx">success</span><span class="o">:</span> <span class="nx">success</span><span class="p">,</span>
</span><span id="saurus-line-117"><a name="swl-117"></a>                    <span class="nx">message</span><span class="o">:</span> <span class="nx">message</span>
</span><span id="saurus-line-118"><a name="swl-118"></a>                <span class="p">});</span>
</span><span id="saurus-line-119"><a name="swl-119"></a>            <span class="p">});</span>
</span><span id="saurus-line-120"><a name="swl-120"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="saurus-line-121"><a name="swl-121"></a>            <span class="nx">response</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
</span><span id="saurus-line-122"><a name="swl-122"></a>                <span class="nx">success</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span id="saurus-line-123"><a name="swl-123"></a>                <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Session ID not found.&#39;</span>
</span><span id="saurus-line-124"><a name="swl-124"></a>            <span class="p">});</span>
</span><span id="saurus-line-125"><a name="swl-125"></a>        <span class="p">}</span>
</span><span id="saurus-line-126"><a name="swl-126"></a>    <span class="p">});</span>
</span><span id="saurus-line-127"><a name="swl-127"></a><span class="p">};</span>
</span><span id="saurus-line-128"><a name="swl-128"></a>
</span><span id="saurus-line-129"><a name="swl-129"></a><span class="c1">// Log a user out</span>
</span><span id="saurus-line-130"><a name="swl-130"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">destroy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-131"><a name="swl-131"></a>    <span class="kd">var</span> <span class="nx">fail</span> <span class="o">=</span> <span class="s1">&#39;Logout failed - please retry.&#39;</span><span class="p">;</span>
</span><span id="saurus-line-132"><a name="swl-132"></a>    <span class="kd">var</span> <span class="nx">sessionToken</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">sessionToken</span><span class="p">;</span>
</span><span id="saurus-line-133"><a name="swl-133"></a>    <span class="nx">request</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">sessionToken</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span id="saurus-line-134"><a name="swl-134"></a>    <span class="nx">Session</span><span class="p">.</span><span class="nx">findByToken</span><span class="p">(</span><span class="nx">sessionToken</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-135"><a name="swl-135"></a>        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="o">!</span><span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-136"><a name="swl-136"></a>            <span class="nx">request</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;danger&#39;</span><span class="p">,</span> <span class="nx">fail</span><span class="p">);</span>
</span><span id="saurus-line-137"><a name="swl-137"></a>            <span class="nx">response</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
</span><span id="saurus-line-138"><a name="swl-138"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="saurus-line-139"><a name="swl-139"></a>            <span class="nx">Session</span><span class="p">.</span><span class="nx">destroy</span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-140"><a name="swl-140"></a>                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-141"><a name="swl-141"></a>                    <span class="nx">request</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;danger&#39;</span><span class="p">,</span> <span class="nx">fail</span><span class="p">);</span>
</span><span id="saurus-line-142"><a name="swl-142"></a>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="saurus-line-143"><a name="swl-143"></a>                    <span class="nx">request</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;You have been logged out.&#39;</span><span class="p">);</span>
</span><span id="saurus-line-144"><a name="swl-144"></a>                <span class="p">}</span>
</span><span id="saurus-line-145"><a name="swl-145"></a>                <span class="nx">response</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
</span><span id="saurus-line-146"><a name="swl-146"></a>            <span class="p">});</span>
</span><span id="saurus-line-147"><a name="swl-147"></a>        <span class="p">}</span>
</span><span id="saurus-line-148"><a name="swl-148"></a>    <span class="p">});</span>
</span><span id="saurus-line-149"><a name="swl-149"></a><span class="p">};</span>
</span></pre></div>
</td></tr></table></div>
          <div data-file="views/session/create.jade" style="display:none;" class="saurus-file"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span id="saurus-line-1"><a name="swl-1"></a><span class="nt">extends</span> ../layout
</span><span id="saurus-line-2"><a name="swl-2"></a>
</span><span id="saurus-line-3"><a name="swl-3"></a><span class="nt">block</span> content
</span><span id="saurus-line-4"><a name="swl-4"></a>  <span class="nt">h1</span> Log In To Your Account
</span><span id="saurus-line-5"><a name="swl-5"></a>
</span><span id="saurus-line-6"><a name="swl-6"></a>  <span class="nc">.row</span>
</span><span id="saurus-line-7"><a name="swl-7"></a>    <span class="nc">.col-md-12</span>
</span><span id="saurus-line-8"><a name="swl-8"></a>      <span class="err">+</span><span class="nt">formFor</span>(<span class="err">&#39;/</span><span class="na">login</span><span class="err">&#39;</span>)
</span><span id="saurus-line-9"><a name="swl-9"></a>        <span class="nc">.form-group</span>
</span><span id="saurus-line-10"><a name="swl-10"></a>          <span class="nt">label</span>(<span class="na">for=</span><span class="s">&#39;username&#39;</span>) Your User Name
</span><span id="saurus-line-11"><a name="swl-11"></a>          <span class="nt">input</span>(<span class="na">type=</span><span class="s">&#39;text&#39;</span><span class="err">,</span> <span class="na">name=</span><span class="s">&#39;username&#39;</span><span class="err">,</span> <span class="na">class=</span><span class="s">&#39;form-control&#39;</span>)
</span><span id="saurus-line-12"><a name="swl-12"></a>
</span><span id="saurus-line-13"><a name="swl-13"></a>        <span class="nc">.form-group</span>
</span><span id="saurus-line-14"><a name="swl-14"></a>          <span class="nt">label</span>(<span class="na">for=</span><span class="s">&#39;password&#39;</span>) Password
</span><span id="saurus-line-15"><a name="swl-15"></a>          <span class="nt">input</span>(<span class="na">type=</span><span class="s">&#39;password&#39;</span><span class="err">,</span> <span class="na">name=</span><span class="s">&#39;password&#39;</span><span class="err">,</span> <span class="na">class=</span><span class="s">&#39;form-control&#39;</span>)
</span><span id="saurus-line-16"><a name="swl-16"></a>
</span><span id="saurus-line-17"><a name="swl-17"></a>        <span class="nt">button</span>(<span class="na">type=</span><span class="s">&#39;submit&#39;</span><span class="err">,</span> <span class="na">class=</span><span class="s">&#39;btn btn-primary&#39;</span>) Log In
</span></pre></div>
</td></tr></table></div>
          <div data-file="views/session/verify.jade" style="display:none;" class="saurus-file"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span id="saurus-line-1"><a name="swl-1"></a><span class="nt">extends</span> ../layout
</span><span id="saurus-line-2"><a name="swl-2"></a>
</span><span id="saurus-line-3"><a name="swl-3"></a><span class="nt">block</span> content
</span><span id="saurus-line-4"><a name="swl-4"></a>  <span class="nt">h1</span> Just To Be Safe...
</span><span id="saurus-line-5"><a name="swl-5"></a>
</span><span id="saurus-line-6"><a name="swl-6"></a>  <span class="nt">p</span>.
</span><span id="saurus-line-7"><a name="swl-7"></a>    <span class="nt">Thanks</span> for inputing your username and password. We&#39;re contacting
</span><span id="saurus-line-8"><a name="swl-8"></a>    <span class="nt">you</span> on your mobile phone now to validate that it&#39;s really you.
</span><span id="saurus-line-9"><a name="swl-9"></a>    <span class="nt">Enter</span> your confirmation code below.
</span><span id="saurus-line-10"><a name="swl-10"></a>
</span><span id="saurus-line-11"><a name="swl-11"></a>  <span class="nc">.row</span>
</span><span id="saurus-line-12"><a name="swl-12"></a>    <span class="nc">.col-md-12</span>
</span><span id="saurus-line-13"><a name="swl-13"></a>      <span class="err">+</span><span class="nt">formFor</span>(<span class="err">&#39;/</span><span class="na">sessions</span><span class="err">/</span><span class="na">verify</span><span class="err">/&#39;+</span><span class="na">sessionId</span>)
</span><span id="saurus-line-14"><a name="swl-14"></a>
</span><span id="saurus-line-15"><a name="swl-15"></a>        <span class="nc">.form-group</span>
</span><span id="saurus-line-16"><a name="swl-16"></a>          <span class="nt">label</span>(<span class="na">for=</span><span class="s">&#39;code&#39;</span>) Confirmation Code
</span><span id="saurus-line-17"><a name="swl-17"></a>          <span class="nt">input</span>(<span class="na">type=</span><span class="s">&#39;text&#39;</span><span class="err">,</span> <span class="na">name=</span><span class="s">&#39;code&#39;</span><span class="err">,</span> <span class="na">class=</span><span class="s">&#39;form-control&#39;</span>)
</span><span id="saurus-line-18"><a name="swl-18"></a>
</span><span id="saurus-line-19"><a name="swl-19"></a>        <span class="nt">button</span>(<span class="na">type=</span><span class="s">&#39;submit&#39;</span><span class="err">,</span> <span class="na">class=</span><span class="s">&#39;btn btn-primary&#39;</span>) Verify Account
</span><span id="saurus-line-20"><a name="swl-20"></a>        <span class="nt">button</span><span class="nf">#resend</span>(<span class="na">type=</span><span class="s">&#39;button&#39;</span><span class="err">,</span> <span class="na">class=</span><span class="s">&#39;btn btn-link&#39;</span>) Resend Code
</span><span id="saurus-line-21"><a name="swl-21"></a>
</span><span id="saurus-line-22"><a name="swl-22"></a><span class="nt">block</span> scripts
</span><span id="saurus-line-23"><a name="swl-23"></a>  <span class="nt">script</span>(<span class="na">src=</span><span class="s">&#39;//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js&#39;</span>)
</span><span id="saurus-line-24"><a name="swl-24"></a>
</span><span id="saurus-line-25"><a name="swl-25"></a>  <span class="c">// Client-side JS to resend code via Ajax</span>
</span><span id="saurus-line-26"><a name="swl-26"></a>  <span class="nt">script</span>(<span class="na">src=</span><span class="s">&#39;/resend.js&#39;</span>)
</span></pre></div>
</td></tr></table></div>
          <div data-file="public/resend.js" style="display:none;" class="saurus-file"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span id="saurus-line-1"><a name="swl-1"></a><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span id="saurus-line-2"><a name="swl-2"></a>    <span class="c1">// Get handle to verification form</span>
</span><span id="saurus-line-3"><a name="swl-3"></a>    <span class="kd">var</span> <span class="nx">actionUrl</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">);</span>
</span><span id="saurus-line-4"><a name="swl-4"></a>    <span class="kd">var</span> <span class="nx">sessionId</span> <span class="o">=</span> <span class="nx">actionUrl</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">];</span>
</span><span id="saurus-line-5"><a name="swl-5"></a>
</span><span id="saurus-line-6"><a name="swl-6"></a>    <span class="c1">// Get resend link</span>
</span><span id="saurus-line-7"><a name="swl-7"></a>    <span class="nx">$link</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#resend&#39;</span><span class="p">);</span>
</span><span id="saurus-line-8"><a name="swl-8"></a>
</span><span id="saurus-line-9"><a name="swl-9"></a>    <span class="c1">// Resend the verification code on click</span>
</span><span id="saurus-line-10"><a name="swl-10"></a>    <span class="nx">$link</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-11"><a name="swl-11"></a>        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
</span><span id="saurus-line-12"><a name="swl-12"></a>        <span class="nx">$link</span><span class="p">.</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span><span id="saurus-line-13"><a name="swl-13"></a>
</span><span id="saurus-line-14"><a name="swl-14"></a>        <span class="c1">// resend code for session ID</span>
</span><span id="saurus-line-15"><a name="swl-15"></a>        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span id="saurus-line-16"><a name="swl-16"></a>            <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
</span><span id="saurus-line-17"><a name="swl-17"></a>            <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;/sessions/verify/&#39;</span><span class="o">+</span><span class="nx">sessionId</span><span class="o">+</span><span class="s1">&#39;/resend&#39;</span>
</span><span id="saurus-line-18"><a name="swl-18"></a>        <span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-19"><a name="swl-19"></a>            <span class="nx">alert</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
</span><span id="saurus-line-20"><a name="swl-20"></a>        <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span id="saurus-line-21"><a name="swl-21"></a>            <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;There was an error resending your code.&#39;</span><span class="p">);</span>
</span><span id="saurus-line-22"><a name="swl-22"></a>        <span class="p">}).</span><span class="nx">always</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span id="saurus-line-23"><a name="swl-23"></a>            <span class="nx">$link</span><span class="p">.</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span id="saurus-line-24"><a name="swl-24"></a>        <span class="p">});</span>
</span><span id="saurus-line-25"><a name="swl-25"></a>    <span class="p">});</span>
</span><span id="saurus-line-26"><a name="swl-26"></a><span class="p">});</span>
</span></pre></div>
</td></tr></table></div>
          <div data-file="middleware/session.js" style="display:none;" class="saurus-file"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td><td class="code"><div class="highlight"><pre><span id="saurus-line-1"><a name="swl-1"></a><span class="kd">var</span> <span class="nx">Session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/Session&#39;</span><span class="p">);</span>
</span><span id="saurus-line-2"><a name="swl-2"></a><span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/User&#39;</span><span class="p">);</span>
</span><span id="saurus-line-3"><a name="swl-3"></a>
</span><span id="saurus-line-4"><a name="swl-4"></a><span class="c1">// To be run on all requests - looks for a session ID and loads the user</span>
</span><span id="saurus-line-5"><a name="swl-5"></a><span class="c1">// associated with it</span>
</span><span id="saurus-line-6"><a name="swl-6"></a><span class="kd">var</span> <span class="nx">middleware</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span id="saurus-line-7"><a name="swl-7"></a>    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-8"><a name="swl-8"></a>        <span class="kd">var</span> <span class="nx">sessionToken</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">sessionToken</span><span class="p">;</span>
</span><span id="saurus-line-9"><a name="swl-9"></a>        <span class="k">if</span> <span class="p">(</span><span class="nx">sessionToken</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-10"><a name="swl-10"></a>            <span class="c1">// see if we have a session for this ID</span>
</span><span id="saurus-line-11"><a name="swl-11"></a>            <span class="nx">Session</span><span class="p">.</span><span class="nx">findByToken</span><span class="p">(</span><span class="nx">sessionToken</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-12"><a name="swl-12"></a>                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">||</span> <span class="o">!</span><span class="nx">session</span> <span class="o">||</span> <span class="o">!</span><span class="nx">session</span><span class="p">.</span><span class="nx">verified</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>
</span><span id="saurus-line-13"><a name="swl-13"></a>                <span class="nx">request</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
</span><span id="saurus-line-14"><a name="swl-14"></a>                <span class="nx">response</span><span class="p">.</span><span class="nx">locals</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
</span><span id="saurus-line-15"><a name="swl-15"></a>                <span class="nx">next</span><span class="p">();</span>
</span><span id="saurus-line-16"><a name="swl-16"></a>            <span class="p">});</span>
</span><span id="saurus-line-17"><a name="swl-17"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="saurus-line-18"><a name="swl-18"></a>            <span class="nx">next</span><span class="p">();</span>
</span><span id="saurus-line-19"><a name="swl-19"></a>        <span class="p">}</span>
</span><span id="saurus-line-20"><a name="swl-20"></a>    <span class="p">};</span>
</span><span id="saurus-line-21"><a name="swl-21"></a><span class="p">};</span>
</span><span id="saurus-line-22"><a name="swl-22"></a>
</span><span id="saurus-line-23"><a name="swl-23"></a><span class="c1">// A custom middleware function that checks for a currently logged in user, and</span>
</span><span id="saurus-line-24"><a name="swl-24"></a><span class="c1">// redirects home if none is found</span>
</span><span id="saurus-line-25"><a name="swl-25"></a><span class="nx">middleware</span><span class="p">.</span><span class="nx">requireLogin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span id="saurus-line-26"><a name="swl-26"></a>    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-27"><a name="swl-27"></a>        <span class="c1">// If we have a user we&#39;re GTG</span>
</span><span id="saurus-line-28"><a name="swl-28"></a>        <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">user</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>
</span><span id="saurus-line-29"><a name="swl-29"></a>
</span><span id="saurus-line-30"><a name="swl-30"></a>        <span class="c1">// otherwise deny</span>
</span><span id="saurus-line-31"><a name="swl-31"></a>        <span class="nx">request</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;danger&#39;</span><span class="p">,</span> <span class="s1">&#39;Login required.&#39;</span><span class="p">);</span>
</span><span id="saurus-line-32"><a name="swl-32"></a>        <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">);</span>
</span><span id="saurus-line-33"><a name="swl-33"></a>    <span class="p">};</span>
</span><span id="saurus-line-34"><a name="swl-34"></a><span class="p">};</span>
</span><span id="saurus-line-35"><a name="swl-35"></a>
</span><span id="saurus-line-36"><a name="swl-36"></a><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">middleware</span><span class="p">;</span>
</span></pre></div>
</td></tr></table></div>
          <div data-file="controllers/user.js" style="display:none;" class="saurus-file"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63</pre></div></td><td class="code"><div class="highlight"><pre><span id="saurus-line-1"><a name="swl-1"></a><span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/User&#39;</span><span class="p">);</span>
</span><span id="saurus-line-2"><a name="swl-2"></a><span class="kd">var</span> <span class="nx">Session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/Session&#39;</span><span class="p">);</span>
</span><span id="saurus-line-3"><a name="swl-3"></a>
</span><span id="saurus-line-4"><a name="swl-4"></a><span class="c1">// Render form to create a new user account</span>
</span><span id="saurus-line-5"><a name="swl-5"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">showUser</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-6"><a name="swl-6"></a>    <span class="kd">var</span> <span class="nx">requestedUsername</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">);</span>
</span><span id="saurus-line-7"><a name="swl-7"></a>
</span><span id="saurus-line-8"><a name="swl-8"></a>    <span class="c1">// Can only view user details for your user</span>
</span><span id="saurus-line-9"><a name="swl-9"></a>    <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span> <span class="o">===</span> <span class="nx">requestedUsername</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-10"><a name="swl-10"></a>        <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;user/show&#39;</span><span class="p">);</span>
</span><span id="saurus-line-11"><a name="swl-11"></a>    <span class="p">}</span>
</span><span id="saurus-line-12"><a name="swl-12"></a>
</span><span id="saurus-line-13"><a name="swl-13"></a>    <span class="c1">// Otherwise we&#39;ll 404</span>
</span><span id="saurus-line-14"><a name="swl-14"></a>    <span class="nx">next</span><span class="p">();</span>
</span><span id="saurus-line-15"><a name="swl-15"></a><span class="p">};</span>
</span><span id="saurus-line-16"><a name="swl-16"></a>
</span><span id="saurus-line-17"><a name="swl-17"></a><span class="c1">// Render form to create a new user account</span>
</span><span id="saurus-line-18"><a name="swl-18"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">showCreate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-19"><a name="swl-19"></a>    <span class="nx">response</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;user/create&#39;</span><span class="p">);</span>
</span><span id="saurus-line-20"><a name="swl-20"></a><span class="p">};</span>
</span><span id="saurus-line-21"><a name="swl-21"></a>
</span><span id="saurus-line-22"><a name="swl-22"></a><span class="c1">// Handle POST request to create user</span>
</span><span id="saurus-line-23"><a name="swl-23"></a><span class="nx">exports</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-24"><a name="swl-24"></a>    <span class="kd">var</span> <span class="nx">opts</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span><span id="saurus-line-25"><a name="swl-25"></a>    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">(</span>
</span><span id="saurus-line-26"><a name="swl-26"></a>        <span class="nx">opts</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
</span><span id="saurus-line-27"><a name="swl-27"></a>        <span class="nx">opts</span><span class="p">.</span><span class="nx">fullName</span><span class="p">,</span>
</span><span id="saurus-line-28"><a name="swl-28"></a>        <span class="nx">opts</span><span class="p">.</span><span class="nx">phone</span><span class="p">,</span>
</span><span id="saurus-line-29"><a name="swl-29"></a>        <span class="nx">opts</span><span class="p">.</span><span class="nx">contactType</span><span class="p">,</span>
</span><span id="saurus-line-30"><a name="swl-30"></a>        <span class="nx">opts</span><span class="p">.</span><span class="nx">password</span>
</span><span id="saurus-line-31"><a name="swl-31"></a>    <span class="p">);</span>
</span><span id="saurus-line-32"><a name="swl-32"></a>
</span><span id="saurus-line-33"><a name="swl-33"></a>    <span class="c1">// Attempt to save the user object</span>
</span><span id="saurus-line-34"><a name="swl-34"></a>    <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">newUser</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-35"><a name="swl-35"></a>        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-36"><a name="swl-36"></a>            <span class="c1">// Problem creating user object</span>
</span><span id="saurus-line-37"><a name="swl-37"></a>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span id="saurus-line-38"><a name="swl-38"></a>            <span class="nx">request</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;danger&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
</span><span id="saurus-line-39"><a name="swl-39"></a>            <span class="nx">response</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/signup&#39;</span><span class="p">);</span>
</span><span id="saurus-line-40"><a name="swl-40"></a>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="saurus-line-41"><a name="swl-41"></a>            <span class="c1">// Success! Create authenticated session for user</span>
</span><span id="saurus-line-42"><a name="swl-42"></a>            <span class="kd">var</span> <span class="nx">sess</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Session</span><span class="p">(</span><span class="nx">newUser</span><span class="p">);</span>
</span><span id="saurus-line-43"><a name="swl-43"></a>            <span class="c1">// On sign up, don&#39;t require the 2FA step to verify</span>
</span><span id="saurus-line-44"><a name="swl-44"></a>            <span class="nx">sess</span><span class="p">.</span><span class="nx">verified</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span id="saurus-line-45"><a name="swl-45"></a>
</span><span id="saurus-line-46"><a name="swl-46"></a>            <span class="nx">sess</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">newSession</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-47"><a name="swl-47"></a>                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span id="saurus-line-48"><a name="swl-48"></a>                    <span class="c1">// Problem creating session</span>
</span><span id="saurus-line-49"><a name="swl-49"></a>                    <span class="nx">request</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;danger&#39;</span><span class="p">,</span> <span class="s1">&#39;User created, but we could not &#39;</span> 
</span><span id="saurus-line-50"><a name="swl-50"></a>                        <span class="o">+</span> <span class="s1">&#39;log you in. Please try logging in again.&#39;</span><span class="p">);</span>
</span><span id="saurus-line-51"><a name="swl-51"></a>                    <span class="nx">response</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
</span><span id="saurus-line-52"><a name="swl-52"></a>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span id="saurus-line-53"><a name="swl-53"></a>                    <span class="c1">// Save session id in HTTP session</span>
</span><span id="saurus-line-54"><a name="swl-54"></a>                    <span class="nx">request</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">sessionToken</span> <span class="o">=</span> <span class="nx">newSession</span><span class="p">.</span><span class="nx">token</span><span class="p">;</span>
</span><span id="saurus-line-55"><a name="swl-55"></a>
</span><span id="saurus-line-56"><a name="swl-56"></a>                    <span class="c1">// Redirect to user details page</span>
</span><span id="saurus-line-57"><a name="swl-57"></a>                    <span class="nx">request</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="s1">&#39;Welcome, &#39;</span><span class="o">+</span><span class="nx">newUser</span><span class="p">.</span><span class="nx">fullName</span><span class="o">+</span><span class="s1">&#39;!&#39;</span><span class="p">);</span>
</span><span id="saurus-line-58"><a name="swl-58"></a>                    <span class="nx">response</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/users/&#39;</span><span class="o">+</span><span class="nx">newUser</span><span class="p">.</span><span class="nx">username</span><span class="p">);</span>
</span><span id="saurus-line-59"><a name="swl-59"></a>                <span class="p">}</span>
</span><span id="saurus-line-60"><a name="swl-60"></a>            <span class="p">});</span>
</span><span id="saurus-line-61"><a name="swl-61"></a>        <span class="p">}</span>
</span><span id="saurus-line-62"><a name="swl-62"></a>    <span class="p">});</span>
</span><span id="saurus-line-63"><a name="swl-63"></a><span class="p">};</span>
</span></pre></div>
</td></tr></table></div>
        </div>
      </div>
      <div class="saurus-explorer">
        <div class="project-data">
          <h3>tfa-node<a href="https://github.com/kwhinnery/tfa-node" target="_blank"><i class="fa fa-fw fa-github-square"></i></a></h3>
        </div>
        <div data-folder="controllers/" class="folder"><span data-folder="controllers/" class="expand"><i data-folder="controllers/" class="fa fa-fw fa-folder"></i><span data-folder="controllers/">controllers/</span></span>
          <div style="display:none" class="files">
                  <div data-file="controllers/router.js" class="file">
                    <p data-file="controllers/router.js">router.js<i data-file="controllers/router.js" class="fa fa-fw fa-file-text-o"></i></p>
                  </div>
                  <div data-file="controllers/session.js" class="file">
                    <p data-file="controllers/session.js">session.js<i data-file="controllers/session.js" class="fa fa-fw fa-file-text-o"></i></p>
                  </div>
                  <div data-file="controllers/user.js" class="file">
                    <p data-file="controllers/user.js">user.js<i data-file="controllers/user.js" class="fa fa-fw fa-file-text-o"></i></p>
                  </div>
          </div>
        </div>
        <div data-folder="middleware/" class="folder"><span data-folder="middleware/" class="expand"><i data-folder="middleware/" class="fa fa-fw fa-folder"></i><span data-folder="middleware/">middleware/</span></span>
          <div style="display:none" class="files">
                  <div data-file="middleware/session.js" class="file">
                    <p data-file="middleware/session.js">session.js<i data-file="middleware/session.js" class="fa fa-fw fa-file-text-o"></i></p>
                  </div>
          </div>
        </div>
        <div data-folder="models/" class="folder"><span data-folder="models/" class="expand"><i data-folder="models/" class="fa fa-fw fa-folder"></i><span data-folder="models/">models/</span></span>
          <div style="display:none" class="files">
                  <div data-file="models/Session.js" class="file">
                    <p data-file="models/Session.js">Session.js<i data-file="models/Session.js" class="fa fa-fw fa-file-text-o"></i></p>
                  </div>
                  <div data-file="models/User.js" class="file">
                    <p data-file="models/User.js">User.js<i data-file="models/User.js" class="fa fa-fw fa-file-text-o"></i></p>
                  </div>
          </div>
        </div>
        <div data-folder="public/" class="folder"><span data-folder="public/" class="expand"><i data-folder="public/" class="fa fa-fw fa-folder"></i><span data-folder="public/">public/</span></span>
          <div style="display:none" class="files">
                  <div data-file="public/resend.js" class="file">
                    <p data-file="public/resend.js">resend.js<i data-file="public/resend.js" class="fa fa-fw fa-file-text-o"></i></p>
                  </div>
          </div>
        </div>
        <div data-folder="views/session/" class="folder"><span data-folder="views/session/" class="expand"><i data-folder="views/session/" class="fa fa-fw fa-folder"></i><span data-folder="views/session/">views/session/</span></span>
          <div style="display:none" class="files">
                  <div data-file="views/session/create.jade" class="file">
                    <p data-file="views/session/create.jade">create.jade<i data-file="views/session/create.jade" class="fa fa-fw fa-file-text-o"></i></p>
                  </div>
                  <div data-file="views/session/verify.jade" class="file">
                    <p data-file="views/session/verify.jade">verify.jade<i data-file="views/session/verify.jade" class="fa fa-fw fa-file-text-o"></i></p>
                  </div>
          </div>
        </div>
              <div data-file="config.js" class="file">
                <p data-file="config.js">config.js<i data-file="config.js" class="fa fa-fw fa-file-text-o"></i></p>
              </div>
              <div data-file="index.js" class="file">
                <p data-file="index.js">index.js<i data-file="index.js" class="fa fa-fw fa-file-text-o"></i></p>
              </div>
              <div data-file="package.json" class="file">
                <p data-file="package.json" class="selected">package.json<i data-file="package.json" class="fa fa-fw fa-file-text-o"></i></p>
              </div>
              <div data-file="webapp.js" class="file">
                <p data-file="webapp.js">webapp.js<i data-file="webapp.js" class="fa fa-fw fa-file-text-o"></i></p>
              </div>
      </div>
    </div>
  </div>
  <script>!function e(t,n,r){function i(s,a){if(!n[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(o)return o(s,!0);var l=new Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l}var c=n[s]={exports:{}};t[s][0].call(c.exports,function(e){var n=t[s][1][e];return i(n?n:e)},c,c.exports,e,t,n,r)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<r.length;s++)i(r[s]);return i}({1:[function(e,t){var n,r,i,o,s,a,u,l,c=function(e,t){return function(){return e.apply(t,arguments)}},h={}.hasOwnProperty,f=function(e,t){function n(){this.constructor=e}for(var r in t)h.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};r=e("backbone"),l=e("underscore"),n=e("jquery"),s=130,o=500,a=1240,u=300,i=function(e){function t(){return this.displayFile=c(this.displayFile,this),this.scrollToCode=c(this.scrollToCode,this),this.toggleExplorer=c(this.toggleExplorer,this),this.checkSize=c(this.checkSize,this),this.hideExplorer=c(this.hideExplorer,this),this.showExplorer=c(this.showExplorer,this),this.restorePosition=c(this.restorePosition,this),this.addMute=c(this.addMute,this),this.removeMute=c(this.removeMute,this),t.__super__.constructor.apply(this,arguments)}return f(t,e),t.prototype.explorerShown=!0,t.prototype.el="#viewsaurus .saurus-code",t.prototype.initialize=function(){var e;return this.$files=this.$el.find(".saurus-file"),this.$codeContainer=this.$el.find(".code-files"),this.$toggle=this.$el.find(".explorer-toggle"),this.$toggleIcon=this.$el.find(".explorer-toggle i"),this.$currentFileLabel=this.$el.find(".current-file span"),this.$toggle.on("click",this.toggleExplorer),this.$codeContainer.on("click",".mute",this.removeMute),this.$codeContainer.on("click",".hl",this.addMute),this.$el.on("mouseleave",this.restorePosition),window.onresize=this.checkSize,this.model.on("change",this.displayFile),e=n(".saurus-prose"),e.width()<u&&(this.$el.css("left",u),e.css("width",u)),this.checkSize()},t.prototype.removeMute=function(){return this.$el.find(".hl").addClass("unhighlighted"),this.$el.find(".mute").addClass("unmute")},t.prototype.addMute=function(){return this.$el.find(".hl").removeClass("unhighlighted"),this.$el.find(".mute").removeClass("unmute")},t.prototype.restorePosition=function(){return this.addMute(),this.scrollToCode()},t.prototype.showExplorer=function(){return this.$el.addClass("minimized"),n(".saurus-explorer").show().addClass("maximized"),this.$toggleIcon.removeClass("fa-chevron-left").addClass("fa-chevron-right"),this.explorerShown=!0},t.prototype.hideExplorer=function(){return this.$el.removeClass("minimized"),n(".saurus-explorer").hide().removeClass("maximized"),this.$toggleIcon.removeClass("fa-chevron-right").addClass("fa-chevron-left"),this.explorerShown=!1},t.prototype.checkSize=function(){return n("#viewsaurus").width()>=a?this.showExplorer():this.hideExplorer()},t.prototype.toggleExplorer=function(){return this.explorerShown?this.hideExplorer():this.showExplorer()},t.prototype.scrollToCode=function(){return l.defer(function(e){return function(){var t,n,r;return t=e.$el.find(".saurus-file:visible"),n=t.find("span.hl").first(),n.length>0?(r=t.scrollTop()+(n.position().top-s),r>0||(r=0),t.animate({scrollTop:r,scrollLeft:0},o)):void 0}}(this))},t.prototype.displayFile=function(){return this.$files.each(function(e){return function(t,r){var i,o,s,a,u,c,h,f,p,d,g,v,m,y,x,b;if(i=n(r),i.find("span[id]").removeClass("mute").removeClass("hl"),g=e.model.get("selectedFile"),a=i.attr("data-file"),a===g){if(e.$currentFileLabel.html(g.replace(/\//g," > ")),u=e.model.getStepData(),h=u.highlight,s=e.model.get("chunk"),m=u.chunks[s],m&&m.highlight&&(h=m.highlight),a===u.file&&null!=h){for(o=i.find("span[id]").addClass("mute"),p=h.split(","),y=0,b=p.length;b>y;y++)for(f=p[y],d=f.split("-"),v=Number(d[0]),c=d[1]?Number(d[1]):v,t=x=v;c>=v?c>=x:x>=c;t=c>=v?++x:--x)i.find("span[id='saurus-line-"+t+"']").removeClass("mute").addClass("hl");e.scrollToCode()}else l.defer(function(){return i.scrollTop(0),i.scrollLeft(0)});return i.show()}return i.hide(),l.defer(function(){return i.scrollTop(0),i.scrollLeft(0)})}}(this))},t}(r.View),t.exports=i},{backbone:8,jquery:12,underscore:13}],2:[function(e,t){var n,r,i,o,s,a={}.hasOwnProperty,u=function(e,t){function n(){this.constructor=e}for(var r in t)a.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},l=function(e,t){return function(){return e.apply(t,arguments)}};s=e("path"),r=e("backbone"),n=e("jquery"),i=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return u(t,e),t.prototype.defaults={folder:""},t}(r.Model),o=function(e){function t(){return this.showFolder=l(this.showFolder,this),this.showFile=l(this.showFile,this),this.manualExpandFolder=l(this.manualExpandFolder,this),this.manualSelectFile=l(this.manualSelectFile,this),t.__super__.constructor.apply(this,arguments)}return u(t,e),t.prototype.el="#viewsaurus .saurus-explorer",t.prototype.initialize=function(){return this.self=new i,this.$files=n(".saurus-explorer .file"),this.$folders=n(".saurus-explorer .folder"),this.$expanders=n(".saurus-explorer .folder .expand"),this.$files.on("click",this.manualSelectFile),this.$expanders.on("click",this.manualExpandFolder),this.model.on("change:selectedFile",this.showFile),this.self.on("change",this.showFolder)},t.prototype.manualSelectFile=function(e){return this.model.set("selectedFile",n(e.target).attr("data-file"))},t.prototype.manualExpandFolder=function(e){var t,r;return t=n(e.target).attr("data-folder"),r="",t!==this.self.get("folder")&&(r=t),this.self.set("folder",r)},t.prototype.showFile=function(){return this.$files.find("p").each(function(e){return function(t,r){var i,o,a;return i=n(r),o=i.attr("data-file"),a=o.replace(s.basename(o),""),i.attr("data-file")===e.model.get("selectedFile")?(e.self.set("folder",a),i.addClass("selected")):i.removeClass("selected")}}(this))},t.prototype.showFolder=function(){var e;return e=this.self.get("folder"),this.$folders.each(function(){return function(t,r){var i,o,s,a;return i=n(r),o=i.find(".expand"),a=o.find("i"),s=i.find(".files"),i.attr("data-folder")===e?(a.addClass("fa-folder-open").removeClass("fa-folder"),s.show()):(a.addClass("fa-folder").removeClass("fa-folder-open"),s.hide())}}(this))},t}(r.View),t.exports=o},{backbone:8,jquery:12,path:9}],3:[function(e,t){var n,r,i,o,s=function(e,t){return function(){return e.apply(t,arguments)}},a={}.hasOwnProperty,u=function(e,t){function n(){this.constructor=e}for(var r in t)a.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};r=e("backbone"),o=e("underscore"),n=e("jquery"),i=function(e){function t(){return this.hide=s(this.hide,this),this.showImage=s(this.showImage,this),t.__super__.constructor.apply(this,arguments)}return u(t,e),t.prototype.el="#viewsaurus .saurus-lightbox",t.prototype.initialize=function(){return this.$steps=n("#viewsaurus .saurus-step"),this.$cancel=this.$el.find(".content-container"),this.$mainImage=this.$el.find("img"),this.$steps.on("click","img",this.showImage),this.$cancel.on("click",this.hide)},t.prototype.showImage=function(e){var t;return t=n(e.target),this.$mainImage.attr("src",t.attr("src")),this.$el.fadeIn()},t.prototype.hide=function(){return this.$el.fadeOut()},t}(r.View),t.exports=i},{backbone:8,jquery:12,underscore:13}],4:[function(e,t){var n,r,i,o,s,a={}.hasOwnProperty,u=function(e,t){function n(){this.constructor=e}for(var r in t)a.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},l=function(e,t){return function(){return e.apply(t,arguments)}};r=e("backbone"),n=e("jquery"),s=250,i=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return u(t,e),t.prototype.defaults={modalVisible:!1,selectedChapterIndex:0},t}(r.Model),o=function(e){function t(){return this.toggleModal=l(this.toggleModal,this),this.toggleLink=l(this.toggleLink,this),this.toggleChapters=l(this.toggleChapters,this),this.displayProse=l(this.displayProse,this),this.getSlug=l(this.getSlug,this),t.__super__.constructor.apply(this,arguments)}return u(t,e),t.prototype.el="#viewsaurus .saurus-prose",t.prototype.initialize=function(){return this.self=new i,this.$chapters=this.$el.find(".saurus-chapter"),this.$steps=this.$el.find(".saurus-step"),this.$previous=this.$el.find(".left"),this.$next=this.$el.find(".right"),this.$overview=this.$el.find(".overview"),this.$modals=this.$el.find(".modal"),this.$currentStep=this.$el.find(".controls .overview .current"),this.$header=this.$el.find(".controls h1"),this.$chapterListItems=this.$el.find(".overview-content li"),this.$chapterLinks=this.$el.find(".overview-content a"),this.$tocChapters=this.$el.find(".toc-chapter"),this.$chapterAccordionHeaders=this.$el.find(".accordion-header"),this.$progressBar=this.$el.find(".progress-bar-inner"),this.$overview.on("click",this.toggleModal),this.$chapterLinks.on("click",this.toggleLink),this.$chapterAccordionHeaders.on("click",this.toggleChapters),this.model.on("change",this.displayProse)},t.prototype.getSlug=function(e){var t,n,r,i,o,s,a;return a=/\W+/g,r=e.ci,o=e.si,n=e.chunk,t=r+"-"+this.model.chapters[r].title.replace(a,"-"),s=o+"-"+e.title.replace(a,"-"),i="#"+t+"/"+s,null!=n&&(i+="/"+n),i},t.prototype.displayProse=function(){var e,t,n,r,i,o,s,a,u,l;return this.$steps.scrollTop(0),n=this.model.get("chapterIndex"),a=this.model.get("stepIndex"),t=this.model.get("chunk"),this.$steps.hide().find(".saurus-chunk").hide(),this.$steps.find(".saurus-step-content").show(),e=this.$el.find(".saurus-chapter:eq("+n+")").find(".saurus-step:eq("+a+")"),e.show(),null!=t?(e.find(".saurus-chunk:eq("+t+")").show(),e.find(".saurus-step-content").hide(),l=this.model.getStepData(),i=String((t+1)/l.chunks.length*100)+"%",this.$progressBar.animate({width:i})):(e.find(".saurus-chunk").hide(),e.find(".saurus-step-content").show(),this.$progressBar.animate({width:0})),this.$currentStep.html(this.model.getStepData().overallStep),this.$chapterListItems.removeClass("current"),s=".overview-content li[data-chapter-index='"+n+"'][data-step-index='"+a+"']",this.$el.find(s).addClass("current"),this.$tocChapters.removeClass("expanded-chapter").find("ol").hide(),this.$tocChapters.find("i").removeClass("fa-minus-square").addClass("fa-plus-square"),this.$tocChapters.eq(n).addClass("expanded-chapter").find("ol").show(),this.$tocChapters.eq(n).find("i").removeClass("fa-plus-square").addClass("fa-minus-square"),this.model.hasPrevious()?(o=this.model.getPrevious(),u=this.getSlug(o),this.$previous.attr("href",u),this.$previous.removeClass("disabled")):(this.$previous.attr("href",""),this.$previous.addClass("disabled")),this.model.hasNext()?(r=this.model.getNext(),u=this.getSlug(r),this.$next.removeClass("disabled"),this.$next.attr("href",u)):(this.$next.attr("href",""),this.$next.addClass("disabled"))},t.prototype.toggleChapters=function(e){var t;return t=n(e.currentTarget),t.parent().hasClass("expanded-chapter")?(t.find("i").removeClass("fa-minus-square").addClass("fa-plus-square"),t.siblings("ol").hide(),t.parent().removeClass("expanded-chapter")):(t.find("i").removeClass("fa-plus-square").addClass("fa-minus-square"),t.siblings("ol").show(),t.parent().addClass("expanded-chapter"),t.parent().siblings().each(function(e,t){var r;return r=n(t),r.removeClass("expanded-chapter"),r.find("i").removeClass("fa-minus-square").addClass("fa-plus-square"),r.find("ol").hide()}))},t.prototype.toggleLink=function(e){var t;return t=n(e.target),this.toggleModal(),this.$chapterLinks.parent().removeClass("current"),t.parent().addClass("current")},t.prototype.toggleModal=function(){var e;return e=this.self.get("modalVisible"),e?(this.$modals.fadeOut(),this.$header.removeClass("open"),this.$overview.removeClass("open").find("i").removeClass("fa-close").addClass("fa-list")):(this.$modals.fadeIn(),this.$header.addClass("open"),this.$overview.addClass("open").find("i").addClass("fa-close").removeClass("fa-list")),this.self.set("modalVisible",!e)},t}(r.View),t.exports=o},{backbone:8,jquery:12}],5:[function(e,t){var n,r,i={}.hasOwnProperty,o=function(e,t){function n(){this.constructor=e}for(var r in t)i.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};n=e("backbone"),r=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return o(t,e),t.prototype.routes={"":"home",":chapterSlug/:stepSlug":"doRoute",":chapterSlug/:stepSlug/:chunk":"doRoute"},t.prototype.initialize=function(e){return this.model=e.model,e},t.prototype.home=function(){return this.model.updateStep(0,0)},t.prototype.doRoute=function(e,t,n){var r,i,o;return i=Number(e.split("-")[0]),o=Number(t.split("-")[0]),r=n&&Number(n),this.model.chapters[i]&&this.model.chapters[i].steps[o]?this.model.updateStep(i,o,r):this.home()},t}(n.Router),t.exports=r},{backbone:8}],6:[function(e,t){var n,r,i,o=function(e,t){return function(){return e.apply(t,arguments)}},s={}.hasOwnProperty,a=function(e,t){function n(){this.constructor=e}for(var r in t)s.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};r=e("backbone"),n=e("jquery"),i=function(e){function t(){return this.getStepData=o(this.getStepData,this),this.doPrevious=o(this.doPrevious,this),this.getPrevious=o(this.getPrevious,this),this.hasPrevious=o(this.hasPrevious,this),this.doNext=o(this.doNext,this),this.getNext=o(this.getNext,this),this.hasNext=o(this.hasNext,this),this.updateStep=o(this.updateStep,this),this.initialize=o(this.initialize,this),t.__super__.constructor.apply(this,arguments)}return a(t,e),t.prototype.chapters=[],t.prototype.defaults={selectedFile:"",step:null,chapterIndex:0,stepIndex:0,chunk:null},t.prototype.initialize=function(){var e,t;return e=n("#viewsaurus .saurus-chapter"),t=[],e.each(function(e){return function(r,i){var o,s;return o=n(i),s={title:o.attr("data-title"),steps:[]},o.find(".saurus-step").each(function(t,r){var i,o;return i=n(r),o={title:i.attr("data-title"),file:i.attr("data-file"),language:i.attr("data-language"),highlight:i.attr("data-highlight"),overallStep:Number(i.attr("data-overallStep")),chunks:[]},i.find(".saurus-chunk").each(function(e,t){var r,i;return r=n(t),i={file:r.attr("data-file"),highlight:r.attr("data-highlight")},o.chunks.push(i)}),""===e.get("selectedFile")&&o.file&&e.set("selectedFile",o.file),s.steps.push(o)}),t.push(s)}}(this)),this.chapters=t,this.set("step",this.chapters[0].steps[0])},t.prototype.updateStep=function(e,t,n){var r,i;return i=this.chapters[e].steps[t],r=this.get("selectedFile"),n?r=i.chunks[n].file||r:i.file&&(r=i.file),this.set({step:i,selectedFile:r,chapterIndex:e,stepIndex:t,chunk:n})},t.prototype.hasNext=function(){var e,t,n,r,i,o,s,a;if(t=this.get("chapterIndex"),a=this.get("stepIndex"),e=this.get("chunk"),i=this.chapters.length-1,i>t)return!0;if(i===t){if(s=this.chapters[i].steps,o=s.length-1,o>a)return!0;if(o===a&&e&&(r=s[o].chunks,n=r.length-1,n>e))return!0}return!1},t.prototype.getNext=function(){var e,t,n,r;if(t=this.get("chapterIndex"),n=this.get("stepIndex"),e=this.get("chunk"),r=null,this.hasNext()){if(null!=e){if(r=this.chapters[t].steps[n].chunks[e+1])return r.ci=t,r.si=n,r.title=this.chapters[t].steps[n].title,r.chunk=e+1,r}else if(r=this.chapters[t].steps[n].chunks[0])return r.ci=t,r.si=n,r.title=this.chapters[t].steps[n].title,r.chunk=0,r;r=this.chapters[t].steps[n+1],r?(r.ci=t,r.si=n+1):(r=this.chapters[t+1].steps[0],r.ci=t+1,r.si=0)}return r},t.prototype.doNext=function(){var e;return e=this.getNext(),e?this.updateStep(e.ci,e.si,e.chunk):void 0},t.prototype.hasPrevious=function(){var e,t,n;return t=this.get("chapterIndex"),n=this.get("stepIndex"),e=this.get("chunk"),!(0===t&&0===n&&!e)},t.prototype.getPrevious=function(){var e,t,n,r,i,o,s;if(t=this.get("chapterIndex"),o=this.get("stepIndex"),e=this.get("chunk"),s=null,this.hasPrevious()){if(null!=e&&0===e)return s=this.chapters[t].steps[o],s.ci=t,s.si=o,s.title=this.chapters[t].steps[o].title,s.chunk=null,s;if(s=this.chapters[t].steps[o].chunks[e-1])return s.ci=t,s.si=o,s.title=this.chapters[t].steps[o].title,s.chunk=e-1,s;s=this.chapters[t].steps[o-1],s?(s.ci=t,s.si=o-1):(r=t-1,i=this.chapters[r].steps.length-1,s=this.chapters[r].steps[i],s.ci=r,s.si=i),s.chunks.length>0&&(n=s.chunks[s.chunks.length-1],n.ci=s.ci,n.si=s.si,n.title=s.title,n.chunk=s.chunks.length-1,s=n)}return s},t.prototype.doPrevious=function(){var e;return e=this.getPrevious(),e?this.updateStep(e.ci,e.si,e.chunk):void 0},t.prototype.getStepData=function(){return this.chapters[this.get("chapterIndex")].steps[this.get("stepIndex")]},t}(r.Model),t.exports=i},{backbone:8,jquery:12}],7:[function(e){var t,n,r,i,o,s,a,u,l;n=e("backbone"),t=e("jquery"),l=e("domready"),u=e("./Viewsaurus.coffee"),a=e("./Router.coffee"),i=e("./Explorer.coffee"),r=e("./Code.coffee"),s=e("./Prose.coffee"),o=e("./Lightbox.coffee"),n.$=t,l(function(){return window.viewsaurus=new u,this.explorer=new i({model:viewsaurus}),this.code=new r({model:viewsaurus}),this.prose=new s({model:viewsaurus}),this.lightbox=new o({model:viewsaurus}),this.router=new a({model:viewsaurus}),n.history.start()})},{"./Code.coffee":1,"./Explorer.coffee":2,"./Lightbox.coffee":3,"./Prose.coffee":4,"./Router.coffee":5,"./Viewsaurus.coffee":6,backbone:8,domready:11,jquery:12}],8:[function(e,t,n){!function(t,r){if("function"==typeof define&&define.amd)define(["underscore","jquery","exports"],function(e,n,i){t.Backbone=r(t,i,e,n)});else if("undefined"!=typeof n){var i=e("underscore");r(t,n,i)}else t.Backbone=r(t,{},t._,t.jQuery||t.Zepto||t.ender||t.$)}(this,function(e,t,n,r){{var i=e.Backbone,o=[],s=(o.push,o.slice);o.splice}t.VERSION="1.1.2",t.$=r,t.noConflict=function(){return e.Backbone=i,this},t.emulateHTTP=!1,t.emulateJSON=!1;var a=t.Events={on:function(e,t,n){if(!l(this,"on",e,[t,n])||!t)return this;this._events||(this._events={});var r=this._events[e]||(this._events[e]=[]);return r.push({callback:t,context:n,ctx:n||this}),this},once:function(e,t,r){if(!l(this,"once",e,[t,r])||!t)return this;var i=this,o=n.once(function(){i.off(e,o),t.apply(this,arguments)});return o._callback=t,this.on(e,o,r)},off:function(e,t,r){var i,o,s,a,u,c,h,f;if(!this._events||!l(this,"off",e,[t,r]))return this;if(!e&&!t&&!r)return this._events=void 0,this;for(a=e?[e]:n.keys(this._events),u=0,c=a.length;c>u;u++)if(e=a[u],s=this._events[e]){if(this._events[e]=i=[],t||r)for(h=0,f=s.length;f>h;h++)o=s[h],(t&&t!==o.callback&&t!==o.callback._callback||r&&r!==o.context)&&i.push(o);i.length||delete this._events[e]}return this},trigger:function(e){if(!this._events)return this;var t=s.call(arguments,1);if(!l(this,"trigger",e,t))return this;var n=this._events[e],r=this._events.all;return n&&c(n,t),r&&c(r,arguments),this},stopListening:function(e,t,r){var i=this._listeningTo;if(!i)return this;var o=!t&&!r;r||"object"!=typeof t||(r=this),e&&((i={})[e._listenId]=e);for(var s in i)e=i[s],e.off(t,r,this),(o||n.isEmpty(e._events))&&delete this._listeningTo[s];return this}},u=/\s+/,l=function(e,t,n,r){if(!n)return!0;if("object"==typeof n){for(var i in n)e[t].apply(e,[i,n[i]].concat(r));return!1}if(u.test(n)){for(var o=n.split(u),s=0,a=o.length;a>s;s++)e[t].apply(e,[o[s]].concat(r));return!1}return!0},c=function(e,t){var n,r=-1,i=e.length,o=t[0],s=t[1],a=t[2];switch(t.length){case 0:for(;++r<i;)(n=e[r]).callback.call(n.ctx);return;case 1:for(;++r<i;)(n=e[r]).callback.call(n.ctx,o);return;case 2:for(;++r<i;)(n=e[r]).callback.call(n.ctx,o,s);return;case 3:for(;++r<i;)(n=e[r]).callback.call(n.ctx,o,s,a);return;default:for(;++r<i;)(n=e[r]).callback.apply(n.ctx,t);return}},h={listenTo:"on",listenToOnce:"once"};n.each(h,function(e,t){a[t]=function(t,r,i){var o=this._listeningTo||(this._listeningTo={}),s=t._listenId||(t._listenId=n.uniqueId("l"));return o[s]=t,i||"object"!=typeof r||(i=this),t[e](r,i,this),this}}),a.bind=a.on,a.unbind=a.off,n.extend(t,a);var f=t.Model=function(e,t){var r=e||{};t||(t={}),this.cid=n.uniqueId("c"),this.attributes={},t.collection&&(this.collection=t.collection),t.parse&&(r=this.parse(r,t)||{}),r=n.defaults({},r,n.result(this,"defaults")),this.set(r,t),this.changed={},this.initialize.apply(this,arguments)};n.extend(f.prototype,a,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(){return n.clone(this.attributes)},sync:function(){return t.sync.apply(this,arguments)},get:function(e){return this.attributes[e]},escape:function(e){return n.escape(this.get(e))},has:function(e){return null!=this.get(e)},set:function(e,t,r){var i,o,s,a,u,l,c,h;if(null==e)return this;if("object"==typeof e?(o=e,r=t):(o={})[e]=t,r||(r={}),!this._validate(o,r))return!1;s=r.unset,u=r.silent,a=[],l=this._changing,this._changing=!0,l||(this._previousAttributes=n.clone(this.attributes),this.changed={}),h=this.attributes,c=this._previousAttributes,this.idAttribute in o&&(this.id=o[this.idAttribute]);for(i in o)t=o[i],n.isEqual(h[i],t)||a.push(i),n.isEqual(c[i],t)?delete this.changed[i]:this.changed[i]=t,s?delete h[i]:h[i]=t;if(!u){a.length&&(this._pending=r);for(var f=0,p=a.length;p>f;f++)this.trigger("change:"+a[f],this,h[a[f]],r)}if(l)return this;if(!u)for(;this._pending;)r=this._pending,this._pending=!1,this.trigger("change",this,r);return this._pending=!1,this._changing=!1,this},unset:function(e,t){return this.set(e,void 0,n.extend({},t,{unset:!0}))},clear:function(e){var t={};for(var r in this.attributes)t[r]=void 0;return this.set(t,n.extend({},e,{unset:!0}))},hasChanged:function(e){return null==e?!n.isEmpty(this.changed):n.has(this.changed,e)},changedAttributes:function(e){if(!e)return this.hasChanged()?n.clone(this.changed):!1;var t,r=!1,i=this._changing?this._previousAttributes:this.attributes;for(var o in e)n.isEqual(i[o],t=e[o])||((r||(r={}))[o]=t);return r},previous:function(e){return null!=e&&this._previousAttributes?this._previousAttributes[e]:null},previousAttributes:function(){return n.clone(this._previousAttributes)},fetch:function(e){e=e?n.clone(e):{},void 0===e.parse&&(e.parse=!0);var t=this,r=e.success;return e.success=function(n){return t.set(t.parse(n,e),e)?(r&&r(t,n,e),void t.trigger("sync",t,n,e)):!1},H(this,e),this.sync("read",this,e)},save:function(e,t,r){var i,o,s,a=this.attributes;if(null==e||"object"==typeof e?(i=e,r=t):(i={})[e]=t,r=n.extend({validate:!0},r),i&&!r.wait){if(!this.set(i,r))return!1}else if(!this._validate(i,r))return!1;i&&r.wait&&(this.attributes=n.extend({},a,i)),void 0===r.parse&&(r.parse=!0);var u=this,l=r.success;return r.success=function(e){u.attributes=a;var t=u.parse(e,r);return r.wait&&(t=n.extend(i||{},t)),n.isObject(t)&&!u.set(t,r)?!1:(l&&l(u,e,r),void u.trigger("sync",u,e,r))},H(this,r),o=this.isNew()?"create":r.patch?"patch":"update","patch"===o&&(r.attrs=i),s=this.sync(o,this,r),i&&r.wait&&(this.attributes=a),s},destroy:function(e){e=e?n.clone(e):{};var t=this,r=e.success,i=function(){t.trigger("destroy",t,t.collection,e)};if(e.success=function(n){(e.wait||t.isNew())&&i(),r&&r(t,n,e),t.isNew()||t.trigger("sync",t,n,e)},this.isNew())return e.success(),!1;H(this,e);var o=this.sync("delete",this,e);return e.wait||i(),o},url:function(){var e=n.result(this,"urlRoot")||n.result(this.collection,"url")||O();return this.isNew()?e:e.replace(/([^\/])$/,"$1/")+encodeURIComponent(this.id)},parse:function(e){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(e){return this._validate({},n.extend(e||{},{validate:!0}))},_validate:function(e,t){if(!t.validate||!this.validate)return!0;e=n.extend({},this.attributes,e);var r=this.validationError=this.validate(e,t)||null;return r?(this.trigger("invalid",this,r,n.extend(t,{validationError:r})),!1):!0}});var p=["keys","values","pairs","invert","pick","omit"];n.each(p,function(e){f.prototype[e]=function(){var t=s.call(arguments);return t.unshift(this.attributes),n[e].apply(n,t)}});var d=t.Collection=function(e,t){t||(t={}),t.model&&(this.model=t.model),void 0!==t.comparator&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,n.extend({silent:!0},t))},g={add:!0,remove:!0,merge:!0},v={add:!0,remove:!1};n.extend(d.prototype,a,{model:f,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},sync:function(){return t.sync.apply(this,arguments)},add:function(e,t){return this.set(e,n.extend({merge:!1},t,v))},remove:function(e,t){var r=!n.isArray(e);e=r?[e]:n.clone(e),t||(t={});var i,o,s,a;for(i=0,o=e.length;o>i;i++)a=e[i]=this.get(e[i]),a&&(delete this._byId[a.id],delete this._byId[a.cid],s=this.indexOf(a),this.models.splice(s,1),this.length--,t.silent||(t.index=s,a.trigger("remove",a,this,t)),this._removeReference(a,t));return r?e[0]:e},set:function(e,t){t=n.defaults({},t,g),t.parse&&(e=this.parse(e,t));var r=!n.isArray(e);e=r?e?[e]:[]:n.clone(e);var i,o,s,a,u,l,c,h=t.at,p=this.model,d=this.comparator&&null==h&&t.sort!==!1,v=n.isString(this.comparator)?this.comparator:null,m=[],y=[],x={},b=t.add,w=t.merge,C=t.remove,k=!d&&b&&C?[]:!1;for(i=0,o=e.length;o>i;i++){if(u=e[i]||{},s=u instanceof f?a=u:u[p.prototype.idAttribute||"id"],l=this.get(s))C&&(x[l.cid]=!0),w&&(u=u===a?a.attributes:u,t.parse&&(u=l.parse(u,t)),l.set(u,t),d&&!c&&l.hasChanged(v)&&(c=!0)),e[i]=l;else if(b){if(a=e[i]=this._prepareModel(u,t),!a)continue;m.push(a),this._addReference(a,t)}a=l||a,!k||!a.isNew()&&x[a.id]||k.push(a),x[a.id]=!0}if(C){for(i=0,o=this.length;o>i;++i)x[(a=this.models[i]).cid]||y.push(a);y.length&&this.remove(y,t)}if(m.length||k&&k.length)if(d&&(c=!0),this.length+=m.length,null!=h)for(i=0,o=m.length;o>i;i++)this.models.splice(h+i,0,m[i]);else{k&&(this.models.length=0);var T=k||m;for(i=0,o=T.length;o>i;i++)this.models.push(T[i])}if(c&&this.sort({silent:!0}),!t.silent){for(i=0,o=m.length;o>i;i++)(a=m[i]).trigger("add",a,this,t);(c||k&&k.length)&&this.trigger("sort",this,t)}return r?e[0]:e},reset:function(e,t){t||(t={});for(var r=0,i=this.models.length;i>r;r++)this._removeReference(this.models[r],t);return t.previousModels=this.models,this._reset(),e=this.add(e,n.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),e},push:function(e,t){return this.add(e,n.extend({at:this.length},t))},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e),t},unshift:function(e,t){return this.add(e,n.extend({at:0},t))},shift:function(e){var t=this.at(0);return this.remove(t,e),t},slice:function(){return s.apply(this.models,arguments)},get:function(e){return null==e?void 0:this._byId[e]||this._byId[e.id]||this._byId[e.cid]},at:function(e){return this.models[e]},where:function(e,t){return n.isEmpty(e)?t?void 0:[]:this[t?"find":"filter"](function(t){for(var n in e)if(e[n]!==t.get(n))return!1;return!0})},findWhere:function(e){return this.where(e,!0)},sort:function(e){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return e||(e={}),n.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(n.bind(this.comparator,this)),e.silent||this.trigger("sort",this,e),this},pluck:function(e){return n.invoke(this.models,"get",e)},fetch:function(e){e=e?n.clone(e):{},void 0===e.parse&&(e.parse=!0);var t=e.success,r=this;return e.success=function(n){var i=e.reset?"reset":"set";r[i](n,e),t&&t(r,n,e),r.trigger("sync",r,n,e)},H(this,e),this.sync("read",this,e)},create:function(e,t){if(t=t?n.clone(t):{},!(e=this._prepareModel(e,t)))return!1;t.wait||this.add(e,t);var r=this,i=t.success;return t.success=function(e,n){t.wait&&r.add(e,t),i&&i(e,n,t)},e.save(null,t),e},parse:function(e){return e},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(e,t){if(e instanceof f)return e;t=t?n.clone(t):{},t.collection=this;var r=new this.model(e,t);return r.validationError?(this.trigger("invalid",this,r.validationError,t),!1):r},_addReference:function(e){this._byId[e.cid]=e,null!=e.id&&(this._byId[e.id]=e),e.collection||(e.collection=this),e.on("all",this._onModelEvent,this)},_removeReference:function(e){this===e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,n,r){("add"!==e&&"remove"!==e||n===this)&&("destroy"===e&&this.remove(t,r),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],null!=t.id&&(this._byId[t.id]=t)),this.trigger.apply(this,arguments))}});var m=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain","sample"];n.each(m,function(e){d.prototype[e]=function(){var t=s.call(arguments);return t.unshift(this.models),n[e].apply(n,t)}});var y=["groupBy","countBy","sortBy","indexBy"];n.each(y,function(e){d.prototype[e]=function(t,r){var i=n.isFunction(t)?t:function(e){return e.get(t)};return n[e](this.models,i,r)}});var x=t.View=function(e){this.cid=n.uniqueId("view"),e||(e={}),n.extend(this,n.pick(e,w)),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},b=/^(\S+)\s*(.*)$/,w=["model","collection","el","id","attributes","className","tagName","events"];n.extend(x.prototype,a,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(e,n){return this.$el&&this.undelegateEvents(),this.$el=e instanceof t.$?e:t.$(e),this.el=this.$el[0],n!==!1&&this.delegateEvents(),this},delegateEvents:function(e){if(!e&&!(e=n.result(this,"events")))return this;this.undelegateEvents();for(var t in e){var r=e[t];if(n.isFunction(r)||(r=this[e[t]]),r){var i=t.match(b),o=i[1],s=i[2];r=n.bind(r,this),o+=".delegateEvents"+this.cid,""===s?this.$el.on(o,r):this.$el.on(o,s,r)}}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_ensureElement:function(){if(this.el)this.setElement(n.result(this,"el"),!1);else{var e=n.extend({},n.result(this,"attributes"));this.id&&(e.id=n.result(this,"id")),this.className&&(e["class"]=n.result(this,"className"));var r=t.$("<"+n.result(this,"tagName")+">").attr(e);this.setElement(r,!1)}}}),t.sync=function(e,r,i){var o=k[e];n.defaults(i||(i={}),{emulateHTTP:t.emulateHTTP,emulateJSON:t.emulateJSON});var s={type:o,dataType:"json"};if(i.url||(s.url=n.result(r,"url")||O()),null!=i.data||!r||"create"!==e&&"update"!==e&&"patch"!==e||(s.contentType="application/json",s.data=JSON.stringify(i.attrs||r.toJSON(i))),i.emulateJSON&&(s.contentType="application/x-www-form-urlencoded",s.data=s.data?{model:s.data}:{}),i.emulateHTTP&&("PUT"===o||"DELETE"===o||"PATCH"===o)){s.type="POST",i.emulateJSON&&(s.data._method=o);var a=i.beforeSend;i.beforeSend=function(e){return e.setRequestHeader("X-HTTP-Method-Override",o),a?a.apply(this,arguments):void 0}}"GET"===s.type||i.emulateJSON||(s.processData=!1),"PATCH"===s.type&&C&&(s.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var u=i.xhr=t.ajax(n.extend(s,i));return r.trigger("request",r,u,i),u};var C=!("undefined"==typeof window||!window.ActiveXObject||window.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent),k={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};t.ajax=function(){return t.$.ajax.apply(t.$,arguments)};var T=t.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},E=/\((.*?)\)/g,_=/(\(\?)?:\w+/g,S=/\*\w+/g,N=/[\-{}\[\]+?.,\\\^$|#\s]/g;n.extend(T.prototype,a,{initialize:function(){},route:function(e,r,i){n.isRegExp(e)||(e=this._routeToRegExp(e)),n.isFunction(r)&&(i=r,r=""),i||(i=this[r]);var o=this;return t.history.route(e,function(n){var s=o._extractParameters(e,n);
o.execute(i,s),o.trigger.apply(o,["route:"+r].concat(s)),o.trigger("route",r,s),t.history.trigger("route",o,r,s)}),this},execute:function(e,t){e&&e.apply(this,t)},navigate:function(e,n){return t.history.navigate(e,n),this},_bindRoutes:function(){if(this.routes){this.routes=n.result(this,"routes");for(var e,t=n.keys(this.routes);null!=(e=t.pop());)this.route(e,this.routes[e])}},_routeToRegExp:function(e){return e=e.replace(N,"\\$&").replace(E,"(?:$1)?").replace(_,function(e,t){return t?e:"([^/?]+)"}).replace(S,"([^?]*?)"),new RegExp("^"+e+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(e,t){var r=e.exec(t).slice(1);return n.map(r,function(e,t){return t===r.length-1?e||null:e?decodeURIComponent(e):null})}});var j=t.History=function(){this.handlers=[],n.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},$=/^[#\/]|\s+$/g,A=/^\/+|\/+$/g,D=/msie [\w.]+/,q=/\/$/,F=/#.*$/;j.started=!1,n.extend(j.prototype,a,{interval:50,atRoot:function(){return this.location.pathname.replace(/[^\/]$/,"$&/")===this.root},getHash:function(e){var t=(e||this).location.href.match(/#(.*)$/);return t?t[1]:""},getFragment:function(e,t){if(null==e)if(this._hasPushState||!this._wantsHashChange||t){e=decodeURI(this.location.pathname+this.location.search);var n=this.root.replace(q,"");e.indexOf(n)||(e=e.slice(n.length))}else e=this.getHash();return e.replace($,"")},start:function(e){if(j.started)throw new Error("Backbone.history has already been started");j.started=!0,this.options=n.extend({root:"/"},this.options,e),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var r=this.getFragment(),i=document.documentMode,o=D.exec(navigator.userAgent.toLowerCase())&&(!i||7>=i);if(this.root=("/"+this.root+"/").replace(A,"/"),o&&this._wantsHashChange){var s=t.$('<iframe src="javascript:0" tabindex="-1">');this.iframe=s.hide().appendTo("body")[0].contentWindow,this.navigate(r)}this._hasPushState?t.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!o?t.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=r;var a=this.location;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot())return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+"#"+this.fragment),!0;this._hasPushState&&this.atRoot()&&a.hash&&(this.fragment=this.getHash().replace($,""),this.history.replaceState({},document.title,this.root+this.fragment))}return this.options.silent?void 0:this.loadUrl()},stop:function(){t.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),this._checkUrlInterval&&clearInterval(this._checkUrlInterval),j.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(){var e=this.getFragment();return e===this.fragment&&this.iframe&&(e=this.getFragment(this.getHash(this.iframe))),e===this.fragment?!1:(this.iframe&&this.navigate(e),void this.loadUrl())},loadUrl:function(e){return e=this.fragment=this.getFragment(e),n.any(this.handlers,function(t){return t.route.test(e)?(t.callback(e),!0):void 0})},navigate:function(e,t){if(!j.started)return!1;t&&t!==!0||(t={trigger:!!t});var n=this.root+(e=this.getFragment(e||""));if(e=e.replace(F,""),this.fragment!==e){if(this.fragment=e,""===e&&"/"!==n&&(n=n.slice(0,-1)),this._hasPushState)this.history[t.replace?"replaceState":"pushState"]({},document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);this._updateHash(this.location,e,t.replace),this.iframe&&e!==this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,e,t.replace))}return t.trigger?this.loadUrl(e):void 0}},_updateHash:function(e,t,n){if(n){var r=e.href.replace(/(javascript:|#).*$/,"");e.replace(r+"#"+t)}else e.hash="#"+t}}),t.history=new j;var L=function(e,t){var r,i=this;r=e&&n.has(e,"constructor")?e.constructor:function(){return i.apply(this,arguments)},n.extend(r,i,t);var o=function(){this.constructor=r};return o.prototype=i.prototype,r.prototype=new o,e&&n.extend(r.prototype,e),r.__super__=i.prototype,r};f.extend=d.extend=T.extend=x.extend=j.extend=L;var O=function(){throw new Error('A "url" property or function must be specified')},H=function(e,t){var n=t.error;t.error=function(r){n&&n(e,r,t),e.trigger("error",e,r,t)}};return t})},{underscore:13}],9:[function(e,t,n){(function(e){function t(e,t){for(var n=0,r=e.length-1;r>=0;r--){var i=e[r];"."===i?e.splice(r,1):".."===i?(e.splice(r,1),n++):n&&(e.splice(r,1),n--)}if(t)for(;n--;n)e.unshift("..");return e}function r(e,t){if(e.filter)return e.filter(t);for(var n=[],r=0;r<e.length;r++)t(e[r],r,e)&&n.push(e[r]);return n}var i=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,o=function(e){return i.exec(e).slice(1)};n.resolve=function(){for(var n="",i=!1,o=arguments.length-1;o>=-1&&!i;o--){var s=o>=0?arguments[o]:e.cwd();if("string"!=typeof s)throw new TypeError("Arguments to path.resolve must be strings");s&&(n=s+"/"+n,i="/"===s.charAt(0))}return n=t(r(n.split("/"),function(e){return!!e}),!i).join("/"),(i?"/":"")+n||"."},n.normalize=function(e){var i=n.isAbsolute(e),o="/"===s(e,-1);return e=t(r(e.split("/"),function(e){return!!e}),!i).join("/"),e||i||(e="."),e&&o&&(e+="/"),(i?"/":"")+e},n.isAbsolute=function(e){return"/"===e.charAt(0)},n.join=function(){var e=Array.prototype.slice.call(arguments,0);return n.normalize(r(e,function(e){if("string"!=typeof e)throw new TypeError("Arguments to path.join must be strings");return e}).join("/"))},n.relative=function(e,t){function r(e){for(var t=0;t<e.length&&""===e[t];t++);for(var n=e.length-1;n>=0&&""===e[n];n--);return t>n?[]:e.slice(t,n-t+1)}e=n.resolve(e).substr(1),t=n.resolve(t).substr(1);for(var i=r(e.split("/")),o=r(t.split("/")),s=Math.min(i.length,o.length),a=s,u=0;s>u;u++)if(i[u]!==o[u]){a=u;break}for(var l=[],u=a;u<i.length;u++)l.push("..");return l=l.concat(o.slice(a)),l.join("/")},n.sep="/",n.delimiter=":",n.dirname=function(e){var t=o(e),n=t[0],r=t[1];return n||r?(r&&(r=r.substr(0,r.length-1)),n+r):"."},n.basename=function(e,t){var n=o(e)[2];return t&&n.substr(-1*t.length)===t&&(n=n.substr(0,n.length-t.length)),n},n.extname=function(e){return o(e)[3]};var s="b"==="ab".substr(-1)?function(e,t,n){return e.substr(t,n)}:function(e,t,n){return 0>t&&(t=e.length+t),e.substr(t,n)}}).call(this,e("_process"))},{_process:10}],10:[function(e,t){function n(){}var r=t.exports={};r.nextTick=function(){var e="undefined"!=typeof window&&window.setImmediate,t="undefined"!=typeof window&&window.MutationObserver,n="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(e)return function(e){return window.setImmediate(e)};var r=[];if(t){var i=document.createElement("div"),o=new MutationObserver(function(){var e=r.slice();r.length=0,e.forEach(function(e){e()})});return o.observe(i,{attributes:!0}),function(e){r.length||i.setAttribute("yes","no"),r.push(e)}}return n?(window.addEventListener("message",function(e){var t=e.source;if((t===window||null===t)&&"process-tick"===e.data&&(e.stopPropagation(),r.length>0)){var n=r.shift();n()}},!0),function(e){r.push(e),window.postMessage("process-tick","*")}):function(e){setTimeout(e,0)}}(),r.title="browser",r.browser=!0,r.env={},r.argv=[],r.on=n,r.addListener=n,r.once=n,r.off=n,r.removeListener=n,r.removeAllListeners=n,r.emit=n,r.binding=function(){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(){throw new Error("process.chdir is not supported")}},{}],11:[function(e,t){!function(e,n){"undefined"!=typeof t?t.exports=n():"function"==typeof define&&"object"==typeof define.amd?define(n):this[e]=n()}("domready",function(){var e,t=[],n=document,r=n.documentElement.doScroll,i="DOMContentLoaded",o=(r?/^loaded|^c/:/^loaded|^i|^c/).test(n.readyState);return o||n.addEventListener(i,e=function(){for(n.removeEventListener(i,e),o=1;e=t.shift();)e()}),function(e){o?e():t.push(e)}})},{}],12:[function(e,t){!function(e,n){"object"==typeof t&&"object"==typeof t.exports?t.exports=e.document?n(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return n(e)}:n(e)}("undefined"!=typeof window?window:this,function(e,t){function n(e){var t=e.length,n=Z.type(e);return"function"===n||Z.isWindow(e)?!1:1===e.nodeType&&t?!0:"array"===n||0===t||"number"==typeof t&&t>0&&t-1 in e}function r(e,t,n){if(Z.isFunction(t))return Z.grep(e,function(e,r){return!!t.call(e,r,e)!==n});if(t.nodeType)return Z.grep(e,function(e){return e===t!==n});if("string"==typeof t){if(at.test(t))return Z.filter(t,e,n);t=Z.filter(t,e)}return Z.grep(e,function(e){return X.call(t,e)>=0!==n})}function i(e,t){for(;(e=e[t])&&1!==e.nodeType;);return e}function o(e){var t=dt[e]={};return Z.each(e.match(pt)||[],function(e,n){t[n]=!0}),t}function s(){Q.removeEventListener("DOMContentLoaded",s,!1),e.removeEventListener("load",s,!1),Z.ready()}function a(){Object.defineProperty(this.cache={},0,{get:function(){return{}}}),this.expando=Z.expando+a.uid++}function u(e,t,n){var r;if(void 0===n&&1===e.nodeType)if(r="data-"+t.replace(bt,"-$1").toLowerCase(),n=e.getAttribute(r),"string"==typeof n){try{n="true"===n?!0:"false"===n?!1:"null"===n?null:+n+""===n?+n:xt.test(n)?Z.parseJSON(n):n}catch(i){}yt.set(e,t,n)}else n=void 0;return n}function l(){return!0}function c(){return!1}function h(){try{return Q.activeElement}catch(e){}}function f(e,t){return Z.nodeName(e,"table")&&Z.nodeName(11!==t.nodeType?t:t.firstChild,"tr")?e.getElementsByTagName("tbody")[0]||e.appendChild(e.ownerDocument.createElement("tbody")):e}function p(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function d(e){var t=Ot.exec(e.type);return t?e.type=t[1]:e.removeAttribute("type"),e}function g(e,t){for(var n=0,r=e.length;r>n;n++)mt.set(e[n],"globalEval",!t||mt.get(t[n],"globalEval"))}function v(e,t){var n,r,i,o,s,a,u,l;if(1===t.nodeType){if(mt.hasData(e)&&(o=mt.access(e),s=mt.set(t,o),l=o.events)){delete s.handle,s.events={};for(i in l)for(n=0,r=l[i].length;r>n;n++)Z.event.add(t,i,l[i][n])}yt.hasData(e)&&(a=yt.access(e),u=Z.extend({},a),yt.set(t,u))}}function m(e,t){var n=e.getElementsByTagName?e.getElementsByTagName(t||"*"):e.querySelectorAll?e.querySelectorAll(t||"*"):[];return void 0===t||t&&Z.nodeName(e,t)?Z.merge([e],n):n}function y(e,t){var n=t.nodeName.toLowerCase();"input"===n&&Tt.test(e.type)?t.checked=e.checked:("input"===n||"textarea"===n)&&(t.defaultValue=e.defaultValue)}function x(t,n){var r,i=Z(n.createElement(t)).appendTo(n.body),o=e.getDefaultComputedStyle&&(r=e.getDefaultComputedStyle(i[0]))?r.display:Z.css(i[0],"display");return i.detach(),o}function b(e){var t=Q,n=It[e];return n||(n=x(e,t),"none"!==n&&n||(Mt=(Mt||Z("<iframe frameborder='0' width='0' height='0'/>")).appendTo(t.documentElement),t=Mt[0].contentDocument,t.write(),t.close(),n=x(e,t),Mt.detach()),It[e]=n),n}function w(e,t,n){var r,i,o,s,a=e.style;return n=n||zt(e),n&&(s=n.getPropertyValue(t)||n[t]),n&&(""!==s||Z.contains(e.ownerDocument,e)||(s=Z.style(e,t)),Bt.test(s)&&Rt.test(t)&&(r=a.width,i=a.minWidth,o=a.maxWidth,a.minWidth=a.maxWidth=a.width=s,s=n.width,a.width=r,a.minWidth=i,a.maxWidth=o)),void 0!==s?s+"":s}function C(e,t){return{get:function(){return e()?void delete this.get:(this.get=t).apply(this,arguments)}}}function k(e,t){if(t in e)return t;for(var n=t[0].toUpperCase()+t.slice(1),r=t,i=Yt.length;i--;)if(t=Yt[i]+n,t in e)return t;return r}function T(e,t,n){var r=Ut.exec(t);return r?Math.max(0,r[1]-(n||0))+(r[2]||"px"):t}function E(e,t,n,r,i){for(var o=n===(r?"border":"content")?4:"width"===t?1:0,s=0;4>o;o+=2)"margin"===n&&(s+=Z.css(e,n+Ct[o],!0,i)),r?("content"===n&&(s-=Z.css(e,"padding"+Ct[o],!0,i)),"margin"!==n&&(s-=Z.css(e,"border"+Ct[o]+"Width",!0,i))):(s+=Z.css(e,"padding"+Ct[o],!0,i),"padding"!==n&&(s+=Z.css(e,"border"+Ct[o]+"Width",!0,i)));return s}function _(e,t,n){var r=!0,i="width"===t?e.offsetWidth:e.offsetHeight,o=zt(e),s="border-box"===Z.css(e,"boxSizing",!1,o);if(0>=i||null==i){if(i=w(e,t,o),(0>i||null==i)&&(i=e.style[t]),Bt.test(i))return i;r=s&&(G.boxSizingReliable()||i===e.style[t]),i=parseFloat(i)||0}return i+E(e,t,n||(s?"border":"content"),r,o)+"px"}function S(e,t){for(var n,r,i,o=[],s=0,a=e.length;a>s;s++)r=e[s],r.style&&(o[s]=mt.get(r,"olddisplay"),n=r.style.display,t?(o[s]||"none"!==n||(r.style.display=""),""===r.style.display&&kt(r)&&(o[s]=mt.access(r,"olddisplay",b(r.nodeName)))):(i=kt(r),"none"===n&&i||mt.set(r,"olddisplay",i?n:Z.css(r,"display"))));for(s=0;a>s;s++)r=e[s],r.style&&(t&&"none"!==r.style.display&&""!==r.style.display||(r.style.display=t?o[s]||"":"none"));return e}function N(e,t,n,r,i){return new N.prototype.init(e,t,n,r,i)}function j(){return setTimeout(function(){Gt=void 0}),Gt=Z.now()}function $(e,t){var n,r=0,i={height:e};for(t=t?1:0;4>r;r+=2-t)n=Ct[r],i["margin"+n]=i["padding"+n]=e;return t&&(i.opacity=i.width=e),i}function A(e,t,n){for(var r,i=(nn[t]||[]).concat(nn["*"]),o=0,s=i.length;s>o;o++)if(r=i[o].call(n,t,e))return r}function D(e,t,n){var r,i,o,s,a,u,l,c,h=this,f={},p=e.style,d=e.nodeType&&kt(e),g=mt.get(e,"fxshow");n.queue||(a=Z._queueHooks(e,"fx"),null==a.unqueued&&(a.unqueued=0,u=a.empty.fire,a.empty.fire=function(){a.unqueued||u()}),a.unqueued++,h.always(function(){h.always(function(){a.unqueued--,Z.queue(e,"fx").length||a.empty.fire()})})),1===e.nodeType&&("height"in t||"width"in t)&&(n.overflow=[p.overflow,p.overflowX,p.overflowY],l=Z.css(e,"display"),c="none"===l?mt.get(e,"olddisplay")||b(e.nodeName):l,"inline"===c&&"none"===Z.css(e,"float")&&(p.display="inline-block")),n.overflow&&(p.overflow="hidden",h.always(function(){p.overflow=n.overflow[0],p.overflowX=n.overflow[1],p.overflowY=n.overflow[2]}));for(r in t)if(i=t[r],Kt.exec(i)){if(delete t[r],o=o||"toggle"===i,i===(d?"hide":"show")){if("show"!==i||!g||void 0===g[r])continue;d=!0}f[r]=g&&g[r]||Z.style(e,r)}else l=void 0;if(Z.isEmptyObject(f))"inline"===("none"===l?b(e.nodeName):l)&&(p.display=l);else{g?"hidden"in g&&(d=g.hidden):g=mt.access(e,"fxshow",{}),o&&(g.hidden=!d),d?Z(e).show():h.done(function(){Z(e).hide()}),h.done(function(){var t;mt.remove(e,"fxshow");for(t in f)Z.style(e,t,f[t])});for(r in f)s=A(d?g[r]:0,r,h),r in g||(g[r]=s.start,d&&(s.end=s.start,s.start="width"===r||"height"===r?1:0))}}function q(e,t){var n,r,i,o,s;for(n in e)if(r=Z.camelCase(n),i=t[r],o=e[n],Z.isArray(o)&&(i=o[1],o=e[n]=o[0]),n!==r&&(e[r]=o,delete e[n]),s=Z.cssHooks[r],s&&"expand"in s){o=s.expand(o),delete e[r];for(n in o)n in e||(e[n]=o[n],t[n]=i)}else t[r]=i}function F(e,t,n){var r,i,o=0,s=tn.length,a=Z.Deferred().always(function(){delete u.elem}),u=function(){if(i)return!1;for(var t=Gt||j(),n=Math.max(0,l.startTime+l.duration-t),r=n/l.duration||0,o=1-r,s=0,u=l.tweens.length;u>s;s++)l.tweens[s].run(o);return a.notifyWith(e,[l,o,n]),1>o&&u?n:(a.resolveWith(e,[l]),!1)},l=a.promise({elem:e,props:Z.extend({},t),opts:Z.extend(!0,{specialEasing:{}},n),originalProperties:t,originalOptions:n,startTime:Gt||j(),duration:n.duration,tweens:[],createTween:function(t,n){var r=Z.Tween(e,l.opts,t,n,l.opts.specialEasing[t]||l.opts.easing);return l.tweens.push(r),r},stop:function(t){var n=0,r=t?l.tweens.length:0;if(i)return this;for(i=!0;r>n;n++)l.tweens[n].run(1);return t?a.resolveWith(e,[l,t]):a.rejectWith(e,[l,t]),this}}),c=l.props;for(q(c,l.opts.specialEasing);s>o;o++)if(r=tn[o].call(l,e,c,l.opts))return r;return Z.map(c,A,l),Z.isFunction(l.opts.start)&&l.opts.start.call(e,l),Z.fx.timer(Z.extend(u,{elem:e,anim:l,queue:l.opts.queue})),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always)}function L(e){return function(t,n){"string"!=typeof t&&(n=t,t="*");var r,i=0,o=t.toLowerCase().match(pt)||[];if(Z.isFunction(n))for(;r=o[i++];)"+"===r[0]?(r=r.slice(1)||"*",(e[r]=e[r]||[]).unshift(n)):(e[r]=e[r]||[]).push(n)}}function O(e,t,n,r){function i(a){var u;return o[a]=!0,Z.each(e[a]||[],function(e,a){var l=a(t,n,r);return"string"!=typeof l||s||o[l]?s?!(u=l):void 0:(t.dataTypes.unshift(l),i(l),!1)}),u}var o={},s=e===bn;return i(t.dataTypes[0])||!o["*"]&&i("*")}function H(e,t){var n,r,i=Z.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((i[n]?e:r||(r={}))[n]=t[n]);return r&&Z.extend(!0,e,r),e}function P(e,t,n){for(var r,i,o,s,a=e.contents,u=e.dataTypes;"*"===u[0];)u.shift(),void 0===r&&(r=e.mimeType||t.getResponseHeader("Content-Type"));if(r)for(i in a)if(a[i]&&a[i].test(r)){u.unshift(i);break}if(u[0]in n)o=u[0];else{for(i in n){if(!u[0]||e.converters[i+" "+u[0]]){o=i;break}s||(s=i)}o=o||s}return o?(o!==u[0]&&u.unshift(o),n[o]):void 0}function M(e,t,n,r){var i,o,s,a,u,l={},c=e.dataTypes.slice();if(c[1])for(s in e.converters)l[s.toLowerCase()]=e.converters[s];for(o=c.shift();o;)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!u&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),u=o,o=c.shift())if("*"===o)o=u;else if("*"!==u&&u!==o){if(s=l[u+" "+o]||l["* "+o],!s)for(i in l)if(a=i.split(" "),a[1]===o&&(s=l[u+" "+a[0]]||l["* "+a[0]])){s===!0?s=l[i]:l[i]!==!0&&(o=a[0],c.unshift(a[1]));break}if(s!==!0)if(s&&e["throws"])t=s(t);else try{t=s(t)}catch(h){return{state:"parsererror",error:s?h:"No conversion from "+u+" to "+o}}}return{state:"success",data:t}}function I(e,t,n,r){var i;if(Z.isArray(t))Z.each(t,function(t,i){n||En.test(e)?r(e,i):I(e+"["+("object"==typeof i?t:"")+"]",i,n,r)});else if(n||"object"!==Z.type(t))r(e,t);else for(i in t)I(e+"["+i+"]",t[i],n,r)}function R(e){return Z.isWindow(e)?e:9===e.nodeType&&e.defaultView}var B=[],z=B.slice,W=B.concat,U=B.push,X=B.indexOf,V={},J=V.toString,Y=V.hasOwnProperty,G={},Q=e.document,K="2.1.3",Z=function(e,t){return new Z.fn.init(e,t)},et=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,tt=/^-ms-/,nt=/-([\da-z])/gi,rt=function(e,t){return t.toUpperCase()};Z.fn=Z.prototype={jquery:K,constructor:Z,selector:"",length:0,toArray:function(){return z.call(this)},get:function(e){return null!=e?0>e?this[e+this.length]:this[e]:z.call(this)},pushStack:function(e){var t=Z.merge(this.constructor(),e);return t.prevObject=this,t.context=this.context,t},each:function(e,t){return Z.each(this,e,t)},map:function(e){return this.pushStack(Z.map(this,function(t,n){return e.call(t,n,t)}))},slice:function(){return this.pushStack(z.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,n=+e+(0>e?t:0);return this.pushStack(n>=0&&t>n?[this[n]]:[])},end:function(){return this.prevObject||this.constructor(null)},push:U,sort:B.sort,splice:B.splice},Z.extend=Z.fn.extend=function(){var e,t,n,r,i,o,s=arguments[0]||{},a=1,u=arguments.length,l=!1;for("boolean"==typeof s&&(l=s,s=arguments[a]||{},a++),"object"==typeof s||Z.isFunction(s)||(s={}),a===u&&(s=this,a--);u>a;a++)if(null!=(e=arguments[a]))for(t in e)n=s[t],r=e[t],s!==r&&(l&&r&&(Z.isPlainObject(r)||(i=Z.isArray(r)))?(i?(i=!1,o=n&&Z.isArray(n)?n:[]):o=n&&Z.isPlainObject(n)?n:{},s[t]=Z.extend(l,o,r)):void 0!==r&&(s[t]=r));return s},Z.extend({expando:"jQuery"+(K+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isFunction:function(e){return"function"===Z.type(e)},isArray:Array.isArray,isWindow:function(e){return null!=e&&e===e.window},isNumeric:function(e){return!Z.isArray(e)&&e-parseFloat(e)+1>=0},isPlainObject:function(e){return"object"!==Z.type(e)||e.nodeType||Z.isWindow(e)?!1:e.constructor&&!Y.call(e.constructor.prototype,"isPrototypeOf")?!1:!0},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},type:function(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?V[J.call(e)]||"object":typeof e},globalEval:function(e){var t,n=eval;e=Z.trim(e),e&&(1===e.indexOf("use strict")?(t=Q.createElement("script"),t.text=e,Q.head.appendChild(t).parentNode.removeChild(t)):n(e))},camelCase:function(e){return e.replace(tt,"ms-").replace(nt,rt)},nodeName:function(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()},each:function(e,t,r){var i,o=0,s=e.length,a=n(e);if(r){if(a)for(;s>o&&(i=t.apply(e[o],r),i!==!1);o++);else for(o in e)if(i=t.apply(e[o],r),i===!1)break}else if(a)for(;s>o&&(i=t.call(e[o],o,e[o]),i!==!1);o++);else for(o in e)if(i=t.call(e[o],o,e[o]),i===!1)break;return e},trim:function(e){return null==e?"":(e+"").replace(et,"")},makeArray:function(e,t){var r=t||[];return null!=e&&(n(Object(e))?Z.merge(r,"string"==typeof e?[e]:e):U.call(r,e)),r},inArray:function(e,t,n){return null==t?-1:X.call(t,e,n)},merge:function(e,t){for(var n=+t.length,r=0,i=e.length;n>r;r++)e[i++]=t[r];return e.length=i,e},grep:function(e,t,n){for(var r,i=[],o=0,s=e.length,a=!n;s>o;o++)r=!t(e[o],o),r!==a&&i.push(e[o]);return i},map:function(e,t,r){var i,o=0,s=e.length,a=n(e),u=[];if(a)for(;s>o;o++)i=t(e[o],o,r),null!=i&&u.push(i);else for(o in e)i=t(e[o],o,r),null!=i&&u.push(i);return W.apply([],u)},guid:1,proxy:function(e,t){var n,r,i;return"string"==typeof t&&(n=e[t],t=e,e=n),Z.isFunction(e)?(r=z.call(arguments,2),i=function(){return e.apply(t||this,r.concat(z.call(arguments)))},i.guid=e.guid=e.guid||Z.guid++,i):void 0},now:Date.now,support:G}),Z.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(e,t){V["[object "+t+"]"]=t.toLowerCase()});var it=function(e){function t(e,t,n,r){var i,o,s,a,u,l,h,p,d,g;if((t?t.ownerDocument||t:I)!==D&&A(t),t=t||D,n=n||[],a=t.nodeType,"string"!=typeof e||!e||1!==a&&9!==a&&11!==a)return n;if(!r&&F){if(11!==a&&(i=yt.exec(e)))if(s=i[1]){if(9===a){if(o=t.getElementById(s),!o||!o.parentNode)return n;if(o.id===s)return n.push(o),n}else if(t.ownerDocument&&(o=t.ownerDocument.getElementById(s))&&P(t,o)&&o.id===s)return n.push(o),n}else{if(i[2])return K.apply(n,t.getElementsByTagName(e)),n;if((s=i[3])&&w.getElementsByClassName)return K.apply(n,t.getElementsByClassName(s)),n}if(w.qsa&&(!L||!L.test(e))){if(p=h=M,d=t,g=1!==a&&e,1===a&&"object"!==t.nodeName.toLowerCase()){for(l=E(e),(h=t.getAttribute("id"))?p=h.replace(bt,"\\$&"):t.setAttribute("id",p),p="[id='"+p+"'] ",u=l.length;u--;)l[u]=p+f(l[u]);d=xt.test(e)&&c(t.parentNode)||t,g=l.join(",")}if(g)try{return K.apply(n,d.querySelectorAll(g)),n}catch(v){}finally{h||t.removeAttribute("id")}}}return S(e.replace(ut,"$1"),t,n,r)}function n(){function e(n,r){return t.push(n+" ")>C.cacheLength&&delete e[t.shift()],e[n+" "]=r}var t=[];return e}function r(e){return e[M]=!0,e}function i(e){var t=D.createElement("div");try{return!!e(t)}catch(n){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function o(e,t){for(var n=e.split("|"),r=e.length;r--;)C.attrHandle[n[r]]=t}function s(e,t){var n=t&&e,r=n&&1===e.nodeType&&1===t.nodeType&&(~t.sourceIndex||V)-(~e.sourceIndex||V);if(r)return r;if(n)for(;n=n.nextSibling;)if(n===t)return-1;return e?1:-1}function a(e){return function(t){var n=t.nodeName.toLowerCase();return"input"===n&&t.type===e}}function u(e){return function(t){var n=t.nodeName.toLowerCase();return("input"===n||"button"===n)&&t.type===e}}function l(e){return r(function(t){return t=+t,r(function(n,r){for(var i,o=e([],n.length,t),s=o.length;s--;)n[i=o[s]]&&(n[i]=!(r[i]=n[i]))})})}function c(e){return e&&"undefined"!=typeof e.getElementsByTagName&&e}function h(){}function f(e){for(var t=0,n=e.length,r="";n>t;t++)r+=e[t].value;return r}function p(e,t,n){var r=t.dir,i=n&&"parentNode"===r,o=B++;return t.first?function(t,n,o){for(;t=t[r];)if(1===t.nodeType||i)return e(t,n,o)}:function(t,n,s){var a,u,l=[R,o];if(s){for(;t=t[r];)if((1===t.nodeType||i)&&e(t,n,s))return!0}else for(;t=t[r];)if(1===t.nodeType||i){if(u=t[M]||(t[M]={}),(a=u[r])&&a[0]===R&&a[1]===o)return l[2]=a[2];if(u[r]=l,l[2]=e(t,n,s))return!0}}}function d(e){return e.length>1?function(t,n,r){for(var i=e.length;i--;)if(!e[i](t,n,r))return!1;return!0}:e[0]}function g(e,n,r){for(var i=0,o=n.length;o>i;i++)t(e,n[i],r);return r}function v(e,t,n,r,i){for(var o,s=[],a=0,u=e.length,l=null!=t;u>a;a++)(o=e[a])&&(!n||n(o,r,i))&&(s.push(o),l&&t.push(a));return s}function m(e,t,n,i,o,s){return i&&!i[M]&&(i=m(i)),o&&!o[M]&&(o=m(o,s)),r(function(r,s,a,u){var l,c,h,f=[],p=[],d=s.length,m=r||g(t||"*",a.nodeType?[a]:a,[]),y=!e||!r&&t?m:v(m,f,e,a,u),x=n?o||(r?e:d||i)?[]:s:y;if(n&&n(y,x,a,u),i)for(l=v(x,p),i(l,[],a,u),c=l.length;c--;)(h=l[c])&&(x[p[c]]=!(y[p[c]]=h));if(r){if(o||e){if(o){for(l=[],c=x.length;c--;)(h=x[c])&&l.push(y[c]=h);o(null,x=[],l,u)}for(c=x.length;c--;)(h=x[c])&&(l=o?et(r,h):f[c])>-1&&(r[l]=!(s[l]=h))}}else x=v(x===s?x.splice(d,x.length):x),o?o(null,s,x,u):K.apply(s,x)})}function y(e){for(var t,n,r,i=e.length,o=C.relative[e[0].type],s=o||C.relative[" "],a=o?1:0,u=p(function(e){return e===t},s,!0),l=p(function(e){return et(t,e)>-1},s,!0),c=[function(e,n,r){var i=!o&&(r||n!==N)||((t=n).nodeType?u(e,n,r):l(e,n,r));return t=null,i}];i>a;a++)if(n=C.relative[e[a].type])c=[p(d(c),n)];else{if(n=C.filter[e[a].type].apply(null,e[a].matches),n[M]){for(r=++a;i>r&&!C.relative[e[r].type];r++);return m(a>1&&d(c),a>1&&f(e.slice(0,a-1).concat({value:" "===e[a-2].type?"*":""})).replace(ut,"$1"),n,r>a&&y(e.slice(a,r)),i>r&&y(e=e.slice(r)),i>r&&f(e))}c.push(n)}return d(c)}function x(e,n){var i=n.length>0,o=e.length>0,s=function(r,s,a,u,l){var c,h,f,p=0,d="0",g=r&&[],m=[],y=N,x=r||o&&C.find.TAG("*",l),b=R+=null==y?1:Math.random()||.1,w=x.length;for(l&&(N=s!==D&&s);d!==w&&null!=(c=x[d]);d++){if(o&&c){for(h=0;f=e[h++];)if(f(c,s,a)){u.push(c);break}l&&(R=b)}i&&((c=!f&&c)&&p--,r&&g.push(c))}if(p+=d,i&&d!==p){for(h=0;f=n[h++];)f(g,m,s,a);if(r){if(p>0)for(;d--;)g[d]||m[d]||(m[d]=G.call(u));m=v(m)}K.apply(u,m),l&&!r&&m.length>0&&p+n.length>1&&t.uniqueSort(u)}return l&&(R=b,N=y),g};return i?r(s):s}var b,w,C,k,T,E,_,S,N,j,$,A,D,q,F,L,O,H,P,M="sizzle"+1*new Date,I=e.document,R=0,B=0,z=n(),W=n(),U=n(),X=function(e,t){return e===t&&($=!0),0},V=1<<31,J={}.hasOwnProperty,Y=[],G=Y.pop,Q=Y.push,K=Y.push,Z=Y.slice,et=function(e,t){for(var n=0,r=e.length;r>n;n++)if(e[n]===t)return n;return-1},tt="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",nt="[\\x20\\t\\r\\n\\f]",rt="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",it=rt.replace("w","w#"),ot="\\["+nt+"*("+rt+")(?:"+nt+"*([*^$|!~]?=)"+nt+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+it+"))|)"+nt+"*\\]",st=":("+rt+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+ot+")*)|.*)\\)|)",at=new RegExp(nt+"+","g"),ut=new RegExp("^"+nt+"+|((?:^|[^\\\\])(?:\\\\.)*)"+nt+"+$","g"),lt=new RegExp("^"+nt+"*,"+nt+"*"),ct=new RegExp("^"+nt+"*([>+~]|"+nt+")"+nt+"*"),ht=new RegExp("="+nt+"*([^\\]'\"]*?)"+nt+"*\\]","g"),ft=new RegExp(st),pt=new RegExp("^"+it+"$"),dt={ID:new RegExp("^#("+rt+")"),CLASS:new RegExp("^\\.("+rt+")"),TAG:new RegExp("^("+rt.replace("w","w*")+")"),ATTR:new RegExp("^"+ot),PSEUDO:new RegExp("^"+st),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+nt+"*(even|odd|(([+-]|)(\\d*)n|)"+nt+"*(?:([+-]|)"+nt+"*(\\d+)|))"+nt+"*\\)|)","i"),bool:new RegExp("^(?:"+tt+")$","i"),needsContext:new RegExp("^"+nt+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+nt+"*((?:-\\d)?\\d*)"+nt+"*\\)|)(?=[^-]|$)","i")},gt=/^(?:input|select|textarea|button)$/i,vt=/^h\d$/i,mt=/^[^{]+\{\s*\[native \w/,yt=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,xt=/[+~]/,bt=/'|\\/g,wt=new RegExp("\\\\([\\da-f]{1,6}"+nt+"?|("+nt+")|.)","ig"),Ct=function(e,t,n){var r="0x"+t-65536;return r!==r||n?t:0>r?String.fromCharCode(r+65536):String.fromCharCode(r>>10|55296,1023&r|56320)},kt=function(){A()};try{K.apply(Y=Z.call(I.childNodes),I.childNodes),Y[I.childNodes.length].nodeType}catch(Tt){K={apply:Y.length?function(e,t){Q.apply(e,Z.call(t))}:function(e,t){for(var n=e.length,r=0;e[n++]=t[r++];);e.length=n-1}}}w=t.support={},T=t.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return t?"HTML"!==t.nodeName:!1},A=t.setDocument=function(e){var t,n,r=e?e.ownerDocument||e:I;return r!==D&&9===r.nodeType&&r.documentElement?(D=r,q=r.documentElement,n=r.defaultView,n&&n!==n.top&&(n.addEventListener?n.addEventListener("unload",kt,!1):n.attachEvent&&n.attachEvent("onunload",kt)),F=!T(r),w.attributes=i(function(e){return e.className="i",!e.getAttribute("className")}),w.getElementsByTagName=i(function(e){return e.appendChild(r.createComment("")),!e.getElementsByTagName("*").length}),w.getElementsByClassName=mt.test(r.getElementsByClassName),w.getById=i(function(e){return q.appendChild(e).id=M,!r.getElementsByName||!r.getElementsByName(M).length}),w.getById?(C.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&F){var n=t.getElementById(e);return n&&n.parentNode?[n]:[]}},C.filter.ID=function(e){var t=e.replace(wt,Ct);return function(e){return e.getAttribute("id")===t}}):(delete C.find.ID,C.filter.ID=function(e){var t=e.replace(wt,Ct);return function(e){var n="undefined"!=typeof e.getAttributeNode&&e.getAttributeNode("id");return n&&n.value===t}}),C.find.TAG=w.getElementsByTagName?function(e,t){return"undefined"!=typeof t.getElementsByTagName?t.getElementsByTagName(e):w.qsa?t.querySelectorAll(e):void 0}:function(e,t){var n,r=[],i=0,o=t.getElementsByTagName(e);if("*"===e){for(;n=o[i++];)1===n.nodeType&&r.push(n);return r}return o},C.find.CLASS=w.getElementsByClassName&&function(e,t){return F?t.getElementsByClassName(e):void 0},O=[],L=[],(w.qsa=mt.test(r.querySelectorAll))&&(i(function(e){q.appendChild(e).innerHTML="<a id='"+M+"'></a><select id='"+M+"-\f]' msallowcapture=''><option selected=''></option></select>",e.querySelectorAll("[msallowcapture^='']").length&&L.push("[*^$]="+nt+"*(?:''|\"\")"),e.querySelectorAll("[selected]").length||L.push("\\["+nt+"*(?:value|"+tt+")"),e.querySelectorAll("[id~="+M+"-]").length||L.push("~="),e.querySelectorAll(":checked").length||L.push(":checked"),e.querySelectorAll("a#"+M+"+*").length||L.push(".#.+[+~]")}),i(function(e){var t=r.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),e.querySelectorAll("[name=d]").length&&L.push("name"+nt+"*[*^$|!~]?="),e.querySelectorAll(":enabled").length||L.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),L.push(",.*:")})),(w.matchesSelector=mt.test(H=q.matches||q.webkitMatchesSelector||q.mozMatchesSelector||q.oMatchesSelector||q.msMatchesSelector))&&i(function(e){w.disconnectedMatch=H.call(e,"div"),H.call(e,"[s!='']:x"),O.push("!=",st)}),L=L.length&&new RegExp(L.join("|")),O=O.length&&new RegExp(O.join("|")),t=mt.test(q.compareDocumentPosition),P=t||mt.test(q.contains)?function(e,t){var n=9===e.nodeType?e.documentElement:e,r=t&&t.parentNode;return e===r||!(!r||1!==r.nodeType||!(n.contains?n.contains(r):e.compareDocumentPosition&&16&e.compareDocumentPosition(r)))}:function(e,t){if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},X=t?function(e,t){if(e===t)return $=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n?n:(n=(e.ownerDocument||e)===(t.ownerDocument||t)?e.compareDocumentPosition(t):1,1&n||!w.sortDetached&&t.compareDocumentPosition(e)===n?e===r||e.ownerDocument===I&&P(I,e)?-1:t===r||t.ownerDocument===I&&P(I,t)?1:j?et(j,e)-et(j,t):0:4&n?-1:1)}:function(e,t){if(e===t)return $=!0,0;var n,i=0,o=e.parentNode,a=t.parentNode,u=[e],l=[t];if(!o||!a)return e===r?-1:t===r?1:o?-1:a?1:j?et(j,e)-et(j,t):0;if(o===a)return s(e,t);for(n=e;n=n.parentNode;)u.unshift(n);for(n=t;n=n.parentNode;)l.unshift(n);for(;u[i]===l[i];)i++;return i?s(u[i],l[i]):u[i]===I?-1:l[i]===I?1:0},r):D},t.matches=function(e,n){return t(e,null,null,n)},t.matchesSelector=function(e,n){if((e.ownerDocument||e)!==D&&A(e),n=n.replace(ht,"='$1']"),!(!w.matchesSelector||!F||O&&O.test(n)||L&&L.test(n)))try{var r=H.call(e,n);if(r||w.disconnectedMatch||e.document&&11!==e.document.nodeType)return r}catch(i){}return t(n,D,null,[e]).length>0},t.contains=function(e,t){return(e.ownerDocument||e)!==D&&A(e),P(e,t)},t.attr=function(e,t){(e.ownerDocument||e)!==D&&A(e);var n=C.attrHandle[t.toLowerCase()],r=n&&J.call(C.attrHandle,t.toLowerCase())?n(e,t,!F):void 0;
return void 0!==r?r:w.attributes||!F?e.getAttribute(t):(r=e.getAttributeNode(t))&&r.specified?r.value:null},t.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},t.uniqueSort=function(e){var t,n=[],r=0,i=0;if($=!w.detectDuplicates,j=!w.sortStable&&e.slice(0),e.sort(X),$){for(;t=e[i++];)t===e[i]&&(r=n.push(i));for(;r--;)e.splice(n[r],1)}return j=null,e},k=t.getText=function(e){var t,n="",r=0,i=e.nodeType;if(i){if(1===i||9===i||11===i){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=k(e)}else if(3===i||4===i)return e.nodeValue}else for(;t=e[r++];)n+=k(t);return n},C=t.selectors={cacheLength:50,createPseudo:r,match:dt,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(wt,Ct),e[3]=(e[3]||e[4]||e[5]||"").replace(wt,Ct),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||t.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&t.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return dt.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&ft.test(n)&&(t=E(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(wt,Ct).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=z[e+" "];return t||(t=new RegExp("(^|"+nt+")"+e+"("+nt+"|$)"))&&z(e,function(e){return t.test("string"==typeof e.className&&e.className||"undefined"!=typeof e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(e,n,r){return function(i){var o=t.attr(i,e);return null==o?"!="===n:n?(o+="","="===n?o===r:"!="===n?o!==r:"^="===n?r&&0===o.indexOf(r):"*="===n?r&&o.indexOf(r)>-1:"$="===n?r&&o.slice(-r.length)===r:"~="===n?(" "+o.replace(at," ")+" ").indexOf(r)>-1:"|="===n?o===r||o.slice(0,r.length+1)===r+"-":!1):!0}},CHILD:function(e,t,n,r,i){var o="nth"!==e.slice(0,3),s="last"!==e.slice(-4),a="of-type"===t;return 1===r&&0===i?function(e){return!!e.parentNode}:function(t,n,u){var l,c,h,f,p,d,g=o!==s?"nextSibling":"previousSibling",v=t.parentNode,m=a&&t.nodeName.toLowerCase(),y=!u&&!a;if(v){if(o){for(;g;){for(h=t;h=h[g];)if(a?h.nodeName.toLowerCase()===m:1===h.nodeType)return!1;d=g="only"===e&&!d&&"nextSibling"}return!0}if(d=[s?v.firstChild:v.lastChild],s&&y){for(c=v[M]||(v[M]={}),l=c[e]||[],p=l[0]===R&&l[1],f=l[0]===R&&l[2],h=p&&v.childNodes[p];h=++p&&h&&h[g]||(f=p=0)||d.pop();)if(1===h.nodeType&&++f&&h===t){c[e]=[R,p,f];break}}else if(y&&(l=(t[M]||(t[M]={}))[e])&&l[0]===R)f=l[1];else for(;(h=++p&&h&&h[g]||(f=p=0)||d.pop())&&((a?h.nodeName.toLowerCase()!==m:1!==h.nodeType)||!++f||(y&&((h[M]||(h[M]={}))[e]=[R,f]),h!==t)););return f-=i,f===r||f%r===0&&f/r>=0}}},PSEUDO:function(e,n){var i,o=C.pseudos[e]||C.setFilters[e.toLowerCase()]||t.error("unsupported pseudo: "+e);return o[M]?o(n):o.length>1?(i=[e,e,"",n],C.setFilters.hasOwnProperty(e.toLowerCase())?r(function(e,t){for(var r,i=o(e,n),s=i.length;s--;)r=et(e,i[s]),e[r]=!(t[r]=i[s])}):function(e){return o(e,0,i)}):o}},pseudos:{not:r(function(e){var t=[],n=[],i=_(e.replace(ut,"$1"));return i[M]?r(function(e,t,n,r){for(var o,s=i(e,null,r,[]),a=e.length;a--;)(o=s[a])&&(e[a]=!(t[a]=o))}):function(e,r,o){return t[0]=e,i(t,null,o,n),t[0]=null,!n.pop()}}),has:r(function(e){return function(n){return t(e,n).length>0}}),contains:r(function(e){return e=e.replace(wt,Ct),function(t){return(t.textContent||t.innerText||k(t)).indexOf(e)>-1}}),lang:r(function(e){return pt.test(e||"")||t.error("unsupported lang: "+e),e=e.replace(wt,Ct).toLowerCase(),function(t){var n;do if(n=F?t.lang:t.getAttribute("xml:lang")||t.getAttribute("lang"))return n=n.toLowerCase(),n===e||0===n.indexOf(e+"-");while((t=t.parentNode)&&1===t.nodeType);return!1}}),target:function(t){var n=e.location&&e.location.hash;return n&&n.slice(1)===t.id},root:function(e){return e===q},focus:function(e){return e===D.activeElement&&(!D.hasFocus||D.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:function(e){return e.disabled===!1},disabled:function(e){return e.disabled===!0},checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,e.selected===!0},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!C.pseudos.empty(e)},header:function(e){return vt.test(e.nodeName)},input:function(e){return gt.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:l(function(){return[0]}),last:l(function(e,t){return[t-1]}),eq:l(function(e,t,n){return[0>n?n+t:n]}),even:l(function(e,t){for(var n=0;t>n;n+=2)e.push(n);return e}),odd:l(function(e,t){for(var n=1;t>n;n+=2)e.push(n);return e}),lt:l(function(e,t,n){for(var r=0>n?n+t:n;--r>=0;)e.push(r);return e}),gt:l(function(e,t,n){for(var r=0>n?n+t:n;++r<t;)e.push(r);return e})}},C.pseudos.nth=C.pseudos.eq;for(b in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})C.pseudos[b]=a(b);for(b in{submit:!0,reset:!0})C.pseudos[b]=u(b);return h.prototype=C.filters=C.pseudos,C.setFilters=new h,E=t.tokenize=function(e,n){var r,i,o,s,a,u,l,c=W[e+" "];if(c)return n?0:c.slice(0);for(a=e,u=[],l=C.preFilter;a;){(!r||(i=lt.exec(a)))&&(i&&(a=a.slice(i[0].length)||a),u.push(o=[])),r=!1,(i=ct.exec(a))&&(r=i.shift(),o.push({value:r,type:i[0].replace(ut," ")}),a=a.slice(r.length));for(s in C.filter)!(i=dt[s].exec(a))||l[s]&&!(i=l[s](i))||(r=i.shift(),o.push({value:r,type:s,matches:i}),a=a.slice(r.length));if(!r)break}return n?a.length:a?t.error(e):W(e,u).slice(0)},_=t.compile=function(e,t){var n,r=[],i=[],o=U[e+" "];if(!o){for(t||(t=E(e)),n=t.length;n--;)o=y(t[n]),o[M]?r.push(o):i.push(o);o=U(e,x(i,r)),o.selector=e}return o},S=t.select=function(e,t,n,r){var i,o,s,a,u,l="function"==typeof e&&e,h=!r&&E(e=l.selector||e);if(n=n||[],1===h.length){if(o=h[0]=h[0].slice(0),o.length>2&&"ID"===(s=o[0]).type&&w.getById&&9===t.nodeType&&F&&C.relative[o[1].type]){if(t=(C.find.ID(s.matches[0].replace(wt,Ct),t)||[])[0],!t)return n;l&&(t=t.parentNode),e=e.slice(o.shift().value.length)}for(i=dt.needsContext.test(e)?0:o.length;i--&&(s=o[i],!C.relative[a=s.type]);)if((u=C.find[a])&&(r=u(s.matches[0].replace(wt,Ct),xt.test(o[0].type)&&c(t.parentNode)||t))){if(o.splice(i,1),e=r.length&&f(o),!e)return K.apply(n,r),n;break}}return(l||_(e,h))(r,t,!F,n,xt.test(e)&&c(t.parentNode)||t),n},w.sortStable=M.split("").sort(X).join("")===M,w.detectDuplicates=!!$,A(),w.sortDetached=i(function(e){return 1&e.compareDocumentPosition(D.createElement("div"))}),i(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||o("type|href|height|width",function(e,t,n){return n?void 0:e.getAttribute(t,"type"===t.toLowerCase()?1:2)}),w.attributes&&i(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||o("value",function(e,t,n){return n||"input"!==e.nodeName.toLowerCase()?void 0:e.defaultValue}),i(function(e){return null==e.getAttribute("disabled")})||o(tt,function(e,t,n){var r;return n?void 0:e[t]===!0?t.toLowerCase():(r=e.getAttributeNode(t))&&r.specified?r.value:null}),t}(e);Z.find=it,Z.expr=it.selectors,Z.expr[":"]=Z.expr.pseudos,Z.unique=it.uniqueSort,Z.text=it.getText,Z.isXMLDoc=it.isXML,Z.contains=it.contains;var ot=Z.expr.match.needsContext,st=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,at=/^.[^:#\[\.,]*$/;Z.filter=function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?Z.find.matchesSelector(r,e)?[r]:[]:Z.find.matches(e,Z.grep(t,function(e){return 1===e.nodeType}))},Z.fn.extend({find:function(e){var t,n=this.length,r=[],i=this;if("string"!=typeof e)return this.pushStack(Z(e).filter(function(){for(t=0;n>t;t++)if(Z.contains(i[t],this))return!0}));for(t=0;n>t;t++)Z.find(e,i[t],r);return r=this.pushStack(n>1?Z.unique(r):r),r.selector=this.selector?this.selector+" "+e:e,r},filter:function(e){return this.pushStack(r(this,e||[],!1))},not:function(e){return this.pushStack(r(this,e||[],!0))},is:function(e){return!!r(this,"string"==typeof e&&ot.test(e)?Z(e):e||[],!1).length}});var ut,lt=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,ct=Z.fn.init=function(e,t){var n,r;if(!e)return this;if("string"==typeof e){if(n="<"===e[0]&&">"===e[e.length-1]&&e.length>=3?[null,e,null]:lt.exec(e),!n||!n[1]&&t)return!t||t.jquery?(t||ut).find(e):this.constructor(t).find(e);if(n[1]){if(t=t instanceof Z?t[0]:t,Z.merge(this,Z.parseHTML(n[1],t&&t.nodeType?t.ownerDocument||t:Q,!0)),st.test(n[1])&&Z.isPlainObject(t))for(n in t)Z.isFunction(this[n])?this[n](t[n]):this.attr(n,t[n]);return this}return r=Q.getElementById(n[2]),r&&r.parentNode&&(this.length=1,this[0]=r),this.context=Q,this.selector=e,this}return e.nodeType?(this.context=this[0]=e,this.length=1,this):Z.isFunction(e)?"undefined"!=typeof ut.ready?ut.ready(e):e(Z):(void 0!==e.selector&&(this.selector=e.selector,this.context=e.context),Z.makeArray(e,this))};ct.prototype=Z.fn,ut=Z(Q);var ht=/^(?:parents|prev(?:Until|All))/,ft={children:!0,contents:!0,next:!0,prev:!0};Z.extend({dir:function(e,t,n){for(var r=[],i=void 0!==n;(e=e[t])&&9!==e.nodeType;)if(1===e.nodeType){if(i&&Z(e).is(n))break;r.push(e)}return r},sibling:function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n}}),Z.fn.extend({has:function(e){var t=Z(e,this),n=t.length;return this.filter(function(){for(var e=0;n>e;e++)if(Z.contains(this,t[e]))return!0})},closest:function(e,t){for(var n,r=0,i=this.length,o=[],s=ot.test(e)||"string"!=typeof e?Z(e,t||this.context):0;i>r;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(s?s.index(n)>-1:1===n.nodeType&&Z.find.matchesSelector(n,e))){o.push(n);break}return this.pushStack(o.length>1?Z.unique(o):o)},index:function(e){return e?"string"==typeof e?X.call(Z(e),this[0]):X.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(Z.unique(Z.merge(this.get(),Z(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),Z.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return Z.dir(e,"parentNode")},parentsUntil:function(e,t,n){return Z.dir(e,"parentNode",n)},next:function(e){return i(e,"nextSibling")},prev:function(e){return i(e,"previousSibling")},nextAll:function(e){return Z.dir(e,"nextSibling")},prevAll:function(e){return Z.dir(e,"previousSibling")},nextUntil:function(e,t,n){return Z.dir(e,"nextSibling",n)},prevUntil:function(e,t,n){return Z.dir(e,"previousSibling",n)},siblings:function(e){return Z.sibling((e.parentNode||{}).firstChild,e)},children:function(e){return Z.sibling(e.firstChild)},contents:function(e){return e.contentDocument||Z.merge([],e.childNodes)}},function(e,t){Z.fn[e]=function(n,r){var i=Z.map(this,t,n);return"Until"!==e.slice(-5)&&(r=n),r&&"string"==typeof r&&(i=Z.filter(r,i)),this.length>1&&(ft[e]||Z.unique(i),ht.test(e)&&i.reverse()),this.pushStack(i)}});var pt=/\S+/g,dt={};Z.Callbacks=function(e){e="string"==typeof e?dt[e]||o(e):Z.extend({},e);var t,n,r,i,s,a,u=[],l=!e.once&&[],c=function(o){for(t=e.memory&&o,n=!0,a=i||0,i=0,s=u.length,r=!0;u&&s>a;a++)if(u[a].apply(o[0],o[1])===!1&&e.stopOnFalse){t=!1;break}r=!1,u&&(l?l.length&&c(l.shift()):t?u=[]:h.disable())},h={add:function(){if(u){var n=u.length;!function o(t){Z.each(t,function(t,n){var r=Z.type(n);"function"===r?e.unique&&h.has(n)||u.push(n):n&&n.length&&"string"!==r&&o(n)})}(arguments),r?s=u.length:t&&(i=n,c(t))}return this},remove:function(){return u&&Z.each(arguments,function(e,t){for(var n;(n=Z.inArray(t,u,n))>-1;)u.splice(n,1),r&&(s>=n&&s--,a>=n&&a--)}),this},has:function(e){return e?Z.inArray(e,u)>-1:!(!u||!u.length)},empty:function(){return u=[],s=0,this},disable:function(){return u=l=t=void 0,this},disabled:function(){return!u},lock:function(){return l=void 0,t||h.disable(),this},locked:function(){return!l},fireWith:function(e,t){return!u||n&&!l||(t=t||[],t=[e,t.slice?t.slice():t],r?l.push(t):c(t)),this},fire:function(){return h.fireWith(this,arguments),this},fired:function(){return!!n}};return h},Z.extend({Deferred:function(e){var t=[["resolve","done",Z.Callbacks("once memory"),"resolved"],["reject","fail",Z.Callbacks("once memory"),"rejected"],["notify","progress",Z.Callbacks("memory")]],n="pending",r={state:function(){return n},always:function(){return i.done(arguments).fail(arguments),this},then:function(){var e=arguments;return Z.Deferred(function(n){Z.each(t,function(t,o){var s=Z.isFunction(e[t])&&e[t];i[o[1]](function(){var e=s&&s.apply(this,arguments);e&&Z.isFunction(e.promise)?e.promise().done(n.resolve).fail(n.reject).progress(n.notify):n[o[0]+"With"](this===r?n.promise():this,s?[e]:arguments)})}),e=null}).promise()},promise:function(e){return null!=e?Z.extend(e,r):r}},i={};return r.pipe=r.then,Z.each(t,function(e,o){var s=o[2],a=o[3];r[o[1]]=s.add,a&&s.add(function(){n=a},t[1^e][2].disable,t[2][2].lock),i[o[0]]=function(){return i[o[0]+"With"](this===i?r:this,arguments),this},i[o[0]+"With"]=s.fireWith}),r.promise(i),e&&e.call(i,i),i},when:function(e){var t,n,r,i=0,o=z.call(arguments),s=o.length,a=1!==s||e&&Z.isFunction(e.promise)?s:0,u=1===a?e:Z.Deferred(),l=function(e,n,r){return function(i){n[e]=this,r[e]=arguments.length>1?z.call(arguments):i,r===t?u.notifyWith(n,r):--a||u.resolveWith(n,r)}};if(s>1)for(t=new Array(s),n=new Array(s),r=new Array(s);s>i;i++)o[i]&&Z.isFunction(o[i].promise)?o[i].promise().done(l(i,r,o)).fail(u.reject).progress(l(i,n,t)):--a;return a||u.resolveWith(r,o),u.promise()}});var gt;Z.fn.ready=function(e){return Z.ready.promise().done(e),this},Z.extend({isReady:!1,readyWait:1,holdReady:function(e){e?Z.readyWait++:Z.ready(!0)},ready:function(e){(e===!0?--Z.readyWait:Z.isReady)||(Z.isReady=!0,e!==!0&&--Z.readyWait>0||(gt.resolveWith(Q,[Z]),Z.fn.triggerHandler&&(Z(Q).triggerHandler("ready"),Z(Q).off("ready"))))}}),Z.ready.promise=function(t){return gt||(gt=Z.Deferred(),"complete"===Q.readyState?setTimeout(Z.ready):(Q.addEventListener("DOMContentLoaded",s,!1),e.addEventListener("load",s,!1))),gt.promise(t)},Z.ready.promise();var vt=Z.access=function(e,t,n,r,i,o,s){var a=0,u=e.length,l=null==n;if("object"===Z.type(n)){i=!0;for(a in n)Z.access(e,t,a,n[a],!0,o,s)}else if(void 0!==r&&(i=!0,Z.isFunction(r)||(s=!0),l&&(s?(t.call(e,r),t=null):(l=t,t=function(e,t,n){return l.call(Z(e),n)})),t))for(;u>a;a++)t(e[a],n,s?r:r.call(e[a],a,t(e[a],n)));return i?e:l?t.call(e):u?t(e[0],n):o};Z.acceptData=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType},a.uid=1,a.accepts=Z.acceptData,a.prototype={key:function(e){if(!a.accepts(e))return 0;var t={},n=e[this.expando];if(!n){n=a.uid++;try{t[this.expando]={value:n},Object.defineProperties(e,t)}catch(r){t[this.expando]=n,Z.extend(e,t)}}return this.cache[n]||(this.cache[n]={}),n},set:function(e,t,n){var r,i=this.key(e),o=this.cache[i];if("string"==typeof t)o[t]=n;else if(Z.isEmptyObject(o))Z.extend(this.cache[i],t);else for(r in t)o[r]=t[r];return o},get:function(e,t){var n=this.cache[this.key(e)];return void 0===t?n:n[t]},access:function(e,t,n){var r;return void 0===t||t&&"string"==typeof t&&void 0===n?(r=this.get(e,t),void 0!==r?r:this.get(e,Z.camelCase(t))):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,r,i,o=this.key(e),s=this.cache[o];if(void 0===t)this.cache[o]={};else{Z.isArray(t)?r=t.concat(t.map(Z.camelCase)):(i=Z.camelCase(t),t in s?r=[t,i]:(r=i,r=r in s?[r]:r.match(pt)||[])),n=r.length;for(;n--;)delete s[r[n]]}},hasData:function(e){return!Z.isEmptyObject(this.cache[e[this.expando]]||{})},discard:function(e){e[this.expando]&&delete this.cache[e[this.expando]]}};var mt=new a,yt=new a,xt=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,bt=/([A-Z])/g;Z.extend({hasData:function(e){return yt.hasData(e)||mt.hasData(e)},data:function(e,t,n){return yt.access(e,t,n)},removeData:function(e,t){yt.remove(e,t)},_data:function(e,t,n){return mt.access(e,t,n)},_removeData:function(e,t){mt.remove(e,t)}}),Z.fn.extend({data:function(e,t){var n,r,i,o=this[0],s=o&&o.attributes;if(void 0===e){if(this.length&&(i=yt.get(o),1===o.nodeType&&!mt.get(o,"hasDataAttrs"))){for(n=s.length;n--;)s[n]&&(r=s[n].name,0===r.indexOf("data-")&&(r=Z.camelCase(r.slice(5)),u(o,r,i[r])));mt.set(o,"hasDataAttrs",!0)}return i}return"object"==typeof e?this.each(function(){yt.set(this,e)}):vt(this,function(t){var n,r=Z.camelCase(e);if(o&&void 0===t){if(n=yt.get(o,e),void 0!==n)return n;if(n=yt.get(o,r),void 0!==n)return n;if(n=u(o,r,void 0),void 0!==n)return n}else this.each(function(){var n=yt.get(this,r);yt.set(this,r,t),-1!==e.indexOf("-")&&void 0!==n&&yt.set(this,e,t)})},null,t,arguments.length>1,null,!0)},removeData:function(e){return this.each(function(){yt.remove(this,e)})}}),Z.extend({queue:function(e,t,n){var r;return e?(t=(t||"fx")+"queue",r=mt.get(e,t),n&&(!r||Z.isArray(n)?r=mt.access(e,t,Z.makeArray(n)):r.push(n)),r||[]):void 0},dequeue:function(e,t){t=t||"fx";var n=Z.queue(e,t),r=n.length,i=n.shift(),o=Z._queueHooks(e,t),s=function(){Z.dequeue(e,t)};"inprogress"===i&&(i=n.shift(),r--),i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,s,o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return mt.get(e,n)||mt.access(e,n,{empty:Z.Callbacks("once memory").add(function(){mt.remove(e,[t+"queue",n])})})}}),Z.fn.extend({queue:function(e,t){var n=2;return"string"!=typeof e&&(t=e,e="fx",n--),arguments.length<n?Z.queue(this[0],e):void 0===t?this:this.each(function(){var n=Z.queue(this,e,t);Z._queueHooks(this,e),"fx"===e&&"inprogress"!==n[0]&&Z.dequeue(this,e)})},dequeue:function(e){return this.each(function(){Z.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,r=1,i=Z.Deferred(),o=this,s=this.length,a=function(){--r||i.resolveWith(o,[o])};for("string"!=typeof e&&(t=e,e=void 0),e=e||"fx";s--;)n=mt.get(o[s],e+"queueHooks"),n&&n.empty&&(r++,n.empty.add(a));return a(),i.promise(t)}});var wt=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,Ct=["Top","Right","Bottom","Left"],kt=function(e,t){return e=t||e,"none"===Z.css(e,"display")||!Z.contains(e.ownerDocument,e)},Tt=/^(?:checkbox|radio)$/i;!function(){var e=Q.createDocumentFragment(),t=e.appendChild(Q.createElement("div")),n=Q.createElement("input");n.setAttribute("type","radio"),n.setAttribute("checked","checked"),n.setAttribute("name","t"),t.appendChild(n),G.checkClone=t.cloneNode(!0).cloneNode(!0).lastChild.checked,t.innerHTML="<textarea>x</textarea>",G.noCloneChecked=!!t.cloneNode(!0).lastChild.defaultValue}();var Et="undefined";G.focusinBubbles="onfocusin"in e;var _t=/^key/,St=/^(?:mouse|pointer|contextmenu)|click/,Nt=/^(?:focusinfocus|focusoutblur)$/,jt=/^([^.]*)(?:\.(.+)|)$/;Z.event={global:{},add:function(e,t,n,r,i){var o,s,a,u,l,c,h,f,p,d,g,v=mt.get(e);if(v)for(n.handler&&(o=n,n=o.handler,i=o.selector),n.guid||(n.guid=Z.guid++),(u=v.events)||(u=v.events={}),(s=v.handle)||(s=v.handle=function(t){return typeof Z!==Et&&Z.event.triggered!==t.type?Z.event.dispatch.apply(e,arguments):void 0}),t=(t||"").match(pt)||[""],l=t.length;l--;)a=jt.exec(t[l])||[],p=g=a[1],d=(a[2]||"").split(".").sort(),p&&(h=Z.event.special[p]||{},p=(i?h.delegateType:h.bindType)||p,h=Z.event.special[p]||{},c=Z.extend({type:p,origType:g,data:r,handler:n,guid:n.guid,selector:i,needsContext:i&&Z.expr.match.needsContext.test(i),namespace:d.join(".")},o),(f=u[p])||(f=u[p]=[],f.delegateCount=0,h.setup&&h.setup.call(e,r,d,s)!==!1||e.addEventListener&&e.addEventListener(p,s,!1)),h.add&&(h.add.call(e,c),c.handler.guid||(c.handler.guid=n.guid)),i?f.splice(f.delegateCount++,0,c):f.push(c),Z.event.global[p]=!0)},remove:function(e,t,n,r,i){var o,s,a,u,l,c,h,f,p,d,g,v=mt.hasData(e)&&mt.get(e);if(v&&(u=v.events)){for(t=(t||"").match(pt)||[""],l=t.length;l--;)if(a=jt.exec(t[l])||[],p=g=a[1],d=(a[2]||"").split(".").sort(),p){for(h=Z.event.special[p]||{},p=(r?h.delegateType:h.bindType)||p,f=u[p]||[],a=a[2]&&new RegExp("(^|\\.)"+d.join("\\.(?:.*\\.|)")+"(\\.|$)"),s=o=f.length;o--;)c=f[o],!i&&g!==c.origType||n&&n.guid!==c.guid||a&&!a.test(c.namespace)||r&&r!==c.selector&&("**"!==r||!c.selector)||(f.splice(o,1),c.selector&&f.delegateCount--,h.remove&&h.remove.call(e,c));s&&!f.length&&(h.teardown&&h.teardown.call(e,d,v.handle)!==!1||Z.removeEvent(e,p,v.handle),delete u[p])}else for(p in u)Z.event.remove(e,p+t[l],n,r,!0);Z.isEmptyObject(u)&&(delete v.handle,mt.remove(e,"events"))}},trigger:function(t,n,r,i){var o,s,a,u,l,c,h,f=[r||Q],p=Y.call(t,"type")?t.type:t,d=Y.call(t,"namespace")?t.namespace.split("."):[];if(s=a=r=r||Q,3!==r.nodeType&&8!==r.nodeType&&!Nt.test(p+Z.event.triggered)&&(p.indexOf(".")>=0&&(d=p.split("."),p=d.shift(),d.sort()),l=p.indexOf(":")<0&&"on"+p,t=t[Z.expando]?t:new Z.Event(p,"object"==typeof t&&t),t.isTrigger=i?2:3,t.namespace=d.join("."),t.namespace_re=t.namespace?new RegExp("(^|\\.)"+d.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,t.result=void 0,t.target||(t.target=r),n=null==n?[t]:Z.makeArray(n,[t]),h=Z.event.special[p]||{},i||!h.trigger||h.trigger.apply(r,n)!==!1)){if(!i&&!h.noBubble&&!Z.isWindow(r)){for(u=h.delegateType||p,Nt.test(u+p)||(s=s.parentNode);s;s=s.parentNode)f.push(s),a=s;a===(r.ownerDocument||Q)&&f.push(a.defaultView||a.parentWindow||e)}for(o=0;(s=f[o++])&&!t.isPropagationStopped();)t.type=o>1?u:h.bindType||p,c=(mt.get(s,"events")||{})[t.type]&&mt.get(s,"handle"),c&&c.apply(s,n),c=l&&s[l],c&&c.apply&&Z.acceptData(s)&&(t.result=c.apply(s,n),t.result===!1&&t.preventDefault());return t.type=p,i||t.isDefaultPrevented()||h._default&&h._default.apply(f.pop(),n)!==!1||!Z.acceptData(r)||l&&Z.isFunction(r[p])&&!Z.isWindow(r)&&(a=r[l],a&&(r[l]=null),Z.event.triggered=p,r[p](),Z.event.triggered=void 0,a&&(r[l]=a)),t.result}},dispatch:function(e){e=Z.event.fix(e);var t,n,r,i,o,s=[],a=z.call(arguments),u=(mt.get(this,"events")||{})[e.type]||[],l=Z.event.special[e.type]||{};if(a[0]=e,e.delegateTarget=this,!l.preDispatch||l.preDispatch.call(this,e)!==!1){for(s=Z.event.handlers.call(this,e,u),t=0;(i=s[t++])&&!e.isPropagationStopped();)for(e.currentTarget=i.elem,n=0;(o=i.handlers[n++])&&!e.isImmediatePropagationStopped();)(!e.namespace_re||e.namespace_re.test(o.namespace))&&(e.handleObj=o,e.data=o.data,r=((Z.event.special[o.origType]||{}).handle||o.handler).apply(i.elem,a),void 0!==r&&(e.result=r)===!1&&(e.preventDefault(),e.stopPropagation()));return l.postDispatch&&l.postDispatch.call(this,e),e.result}},handlers:function(e,t){var n,r,i,o,s=[],a=t.delegateCount,u=e.target;if(a&&u.nodeType&&(!e.button||"click"!==e.type))for(;u!==this;u=u.parentNode||this)if(u.disabled!==!0||"click"!==e.type){for(r=[],n=0;a>n;n++)o=t[n],i=o.selector+" ",void 0===r[i]&&(r[i]=o.needsContext?Z(i,this).index(u)>=0:Z.find(i,this,null,[u]).length),r[i]&&r.push(o);r.length&&s.push({elem:u,handlers:r})}return a<t.length&&s.push({elem:this,handlers:t.slice(a)}),s},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(e,t){return null==e.which&&(e.which=null!=t.charCode?t.charCode:t.keyCode),e}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(e,t){var n,r,i,o=t.button;return null==e.pageX&&null!=t.clientX&&(n=e.target.ownerDocument||Q,r=n.documentElement,i=n.body,e.pageX=t.clientX+(r&&r.scrollLeft||i&&i.scrollLeft||0)-(r&&r.clientLeft||i&&i.clientLeft||0),e.pageY=t.clientY+(r&&r.scrollTop||i&&i.scrollTop||0)-(r&&r.clientTop||i&&i.clientTop||0)),e.which||void 0===o||(e.which=1&o?1:2&o?3:4&o?2:0),e}},fix:function(e){if(e[Z.expando])return e;var t,n,r,i=e.type,o=e,s=this.fixHooks[i];for(s||(this.fixHooks[i]=s=St.test(i)?this.mouseHooks:_t.test(i)?this.keyHooks:{}),r=s.props?this.props.concat(s.props):this.props,e=new Z.Event(o),t=r.length;t--;)n=r[t],e[n]=o[n];return e.target||(e.target=Q),3===e.target.nodeType&&(e.target=e.target.parentNode),s.filter?s.filter(e,o):e},special:{load:{noBubble:!0},focus:{trigger:function(){return this!==h()&&this.focus?(this.focus(),!1):void 0},delegateType:"focusin"},blur:{trigger:function(){return this===h()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return"checkbox"===this.type&&this.click&&Z.nodeName(this,"input")?(this.click(),!1):void 0},_default:function(e){return Z.nodeName(e.target,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}},simulate:function(e,t,n,r){var i=Z.extend(new Z.Event,n,{type:e,isSimulated:!0,originalEvent:{}});r?Z.event.trigger(i,null,t):Z.event.dispatch.call(t,i),i.isDefaultPrevented()&&n.preventDefault()}},Z.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n,!1)},Z.Event=function(e,t){return this instanceof Z.Event?(e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&e.returnValue===!1?l:c):this.type=e,t&&Z.extend(this,t),this.timeStamp=e&&e.timeStamp||Z.now(),void(this[Z.expando]=!0)):new Z.Event(e,t)},Z.Event.prototype={isDefaultPrevented:c,isPropagationStopped:c,isImmediatePropagationStopped:c,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=l,e&&e.preventDefault&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=l,e&&e.stopPropagation&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=l,e&&e.stopImmediatePropagation&&e.stopImmediatePropagation(),this.stopPropagation()}},Z.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,t){Z.event.special[e]={delegateType:t,bindType:t,handle:function(e){var n,r=this,i=e.relatedTarget,o=e.handleObj;return(!i||i!==r&&!Z.contains(r,i))&&(e.type=o.origType,n=o.handler.apply(this,arguments),e.type=t),n}}}),G.focusinBubbles||Z.each({focus:"focusin",blur:"focusout"},function(e,t){var n=function(e){Z.event.simulate(t,e.target,Z.event.fix(e),!0)};Z.event.special[t]={setup:function(){var r=this.ownerDocument||this,i=mt.access(r,t);i||r.addEventListener(e,n,!0),mt.access(r,t,(i||0)+1)},teardown:function(){var r=this.ownerDocument||this,i=mt.access(r,t)-1;i?mt.access(r,t,i):(r.removeEventListener(e,n,!0),mt.remove(r,t))}}}),Z.fn.extend({on:function(e,t,n,r,i){var o,s;if("object"==typeof e){"string"!=typeof t&&(n=n||t,t=void 0);for(s in e)this.on(s,t,n,e[s],i);return this}if(null==n&&null==r?(r=t,n=t=void 0):null==r&&("string"==typeof t?(r=n,n=void 0):(r=n,n=t,t=void 0)),r===!1)r=c;else if(!r)return this;return 1===i&&(o=r,r=function(e){return Z().off(e),o.apply(this,arguments)},r.guid=o.guid||(o.guid=Z.guid++)),this.each(function(){Z.event.add(this,e,r,n,t)})},one:function(e,t,n,r){return this.on(e,t,n,r,1)},off:function(e,t,n){var r,i;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,Z(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"==typeof e){for(i in e)this.off(i,t,e[i]);return this}return(t===!1||"function"==typeof t)&&(n=t,t=void 0),n===!1&&(n=c),this.each(function(){Z.event.remove(this,e,n,t)})},trigger:function(e,t){return this.each(function(){Z.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];return n?Z.event.trigger(e,t,n,!0):void 0}});var $t=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,At=/<([\w:]+)/,Dt=/<|&#?\w+;/,qt=/<(?:script|style|link)/i,Ft=/checked\s*(?:[^=]|=\s*.checked.)/i,Lt=/^$|\/(?:java|ecma)script/i,Ot=/^true\/(.*)/,Ht=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,Pt={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};Pt.optgroup=Pt.option,Pt.tbody=Pt.tfoot=Pt.colgroup=Pt.caption=Pt.thead,Pt.th=Pt.td,Z.extend({clone:function(e,t,n){var r,i,o,s,a=e.cloneNode(!0),u=Z.contains(e.ownerDocument,e);if(!(G.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||Z.isXMLDoc(e)))for(s=m(a),o=m(e),r=0,i=o.length;i>r;r++)y(o[r],s[r]);if(t)if(n)for(o=o||m(e),s=s||m(a),r=0,i=o.length;i>r;r++)v(o[r],s[r]);else v(e,a);return s=m(a,"script"),s.length>0&&g(s,!u&&m(e,"script")),a},buildFragment:function(e,t,n,r){for(var i,o,s,a,u,l,c=t.createDocumentFragment(),h=[],f=0,p=e.length;p>f;f++)if(i=e[f],i||0===i)if("object"===Z.type(i))Z.merge(h,i.nodeType?[i]:i);else if(Dt.test(i)){for(o=o||c.appendChild(t.createElement("div")),s=(At.exec(i)||["",""])[1].toLowerCase(),a=Pt[s]||Pt._default,o.innerHTML=a[1]+i.replace($t,"<$1></$2>")+a[2],l=a[0];l--;)o=o.lastChild;Z.merge(h,o.childNodes),o=c.firstChild,o.textContent=""}else h.push(t.createTextNode(i));for(c.textContent="",f=0;i=h[f++];)if((!r||-1===Z.inArray(i,r))&&(u=Z.contains(i.ownerDocument,i),o=m(c.appendChild(i),"script"),u&&g(o),n))for(l=0;i=o[l++];)Lt.test(i.type||"")&&n.push(i);return c},cleanData:function(e){for(var t,n,r,i,o=Z.event.special,s=0;void 0!==(n=e[s]);s++){if(Z.acceptData(n)&&(i=n[mt.expando],i&&(t=mt.cache[i]))){if(t.events)for(r in t.events)o[r]?Z.event.remove(n,r):Z.removeEvent(n,r,t.handle);mt.cache[i]&&delete mt.cache[i]}delete yt.cache[n[yt.expando]]}}}),Z.fn.extend({text:function(e){return vt(this,function(e){return void 0===e?Z.text(this):this.empty().each(function(){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&(this.textContent=e)})},null,e,arguments.length)},append:function(){return this.domManip(arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=f(this,e);t.appendChild(e)}})},prepend:function(){return this.domManip(arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=f(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},remove:function(e,t){for(var n,r=e?Z.filter(e,this):this,i=0;null!=(n=r[i]);i++)t||1!==n.nodeType||Z.cleanData(m(n)),n.parentNode&&(t&&Z.contains(n.ownerDocument,n)&&g(m(n,"script")),n.parentNode.removeChild(n));return this},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(Z.cleanData(m(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null==e?!1:e,t=null==t?e:t,this.map(function(){return Z.clone(this,e,t)})},html:function(e){return vt(this,function(e){var t=this[0]||{},n=0,r=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!qt.test(e)&&!Pt[(At.exec(e)||["",""])[1].toLowerCase()]){e=e.replace($t,"<$1></$2>");try{for(;r>n;n++)t=this[n]||{},1===t.nodeType&&(Z.cleanData(m(t,!1)),t.innerHTML=e);t=0}catch(i){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var e=arguments[0];return this.domManip(arguments,function(t){e=this.parentNode,Z.cleanData(m(this)),e&&e.replaceChild(t,this)}),e&&(e.length||e.nodeType)?this:this.remove()},detach:function(e){return this.remove(e,!0)},domManip:function(e,t){e=W.apply([],e);var n,r,i,o,s,a,u=0,l=this.length,c=this,h=l-1,f=e[0],g=Z.isFunction(f);if(g||l>1&&"string"==typeof f&&!G.checkClone&&Ft.test(f))return this.each(function(n){var r=c.eq(n);g&&(e[0]=f.call(this,n,r.html())),r.domManip(e,t)});if(l&&(n=Z.buildFragment(e,this[0].ownerDocument,!1,this),r=n.firstChild,1===n.childNodes.length&&(n=r),r)){for(i=Z.map(m(n,"script"),p),o=i.length;l>u;u++)s=n,u!==h&&(s=Z.clone(s,!0,!0),o&&Z.merge(i,m(s,"script"))),t.call(this[u],s,u);
if(o)for(a=i[i.length-1].ownerDocument,Z.map(i,d),u=0;o>u;u++)s=i[u],Lt.test(s.type||"")&&!mt.access(s,"globalEval")&&Z.contains(a,s)&&(s.src?Z._evalUrl&&Z._evalUrl(s.src):Z.globalEval(s.textContent.replace(Ht,"")))}return this}}),Z.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,t){Z.fn[e]=function(e){for(var n,r=[],i=Z(e),o=i.length-1,s=0;o>=s;s++)n=s===o?this:this.clone(!0),Z(i[s])[t](n),U.apply(r,n.get());return this.pushStack(r)}});var Mt,It={},Rt=/^margin/,Bt=new RegExp("^("+wt+")(?!px)[a-z%]+$","i"),zt=function(t){return t.ownerDocument.defaultView.opener?t.ownerDocument.defaultView.getComputedStyle(t,null):e.getComputedStyle(t,null)};!function(){function t(){s.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;display:block;margin-top:1%;top:1%;border:1px;padding:1px;width:4px;position:absolute",s.innerHTML="",i.appendChild(o);var t=e.getComputedStyle(s,null);n="1%"!==t.top,r="4px"===t.width,i.removeChild(o)}var n,r,i=Q.documentElement,o=Q.createElement("div"),s=Q.createElement("div");s.style&&(s.style.backgroundClip="content-box",s.cloneNode(!0).style.backgroundClip="",G.clearCloneStyle="content-box"===s.style.backgroundClip,o.style.cssText="border:0;width:0;height:0;top:0;left:-9999px;margin-top:1px;position:absolute",o.appendChild(s),e.getComputedStyle&&Z.extend(G,{pixelPosition:function(){return t(),n},boxSizingReliable:function(){return null==r&&t(),r},reliableMarginRight:function(){var t,n=s.appendChild(Q.createElement("div"));return n.style.cssText=s.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:0",n.style.marginRight=n.style.width="0",s.style.width="1px",i.appendChild(o),t=!parseFloat(e.getComputedStyle(n,null).marginRight),i.removeChild(o),s.removeChild(n),t}}))}(),Z.swap=function(e,t,n,r){var i,o,s={};for(o in t)s[o]=e.style[o],e.style[o]=t[o];i=n.apply(e,r||[]);for(o in t)e.style[o]=s[o];return i};var Wt=/^(none|table(?!-c[ea]).+)/,Ut=new RegExp("^("+wt+")(.*)$","i"),Xt=new RegExp("^([+-])=("+wt+")","i"),Vt={position:"absolute",visibility:"hidden",display:"block"},Jt={letterSpacing:"0",fontWeight:"400"},Yt=["Webkit","O","Moz","ms"];Z.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=w(e,"opacity");return""===n?"1":n}}}},cssNumber:{columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":"cssFloat"},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,o,s,a=Z.camelCase(t),u=e.style;return t=Z.cssProps[a]||(Z.cssProps[a]=k(u,a)),s=Z.cssHooks[t]||Z.cssHooks[a],void 0===n?s&&"get"in s&&void 0!==(i=s.get(e,!1,r))?i:u[t]:(o=typeof n,"string"===o&&(i=Xt.exec(n))&&(n=(i[1]+1)*i[2]+parseFloat(Z.css(e,t)),o="number"),null!=n&&n===n&&("number"!==o||Z.cssNumber[a]||(n+="px"),G.clearCloneStyle||""!==n||0!==t.indexOf("background")||(u[t]="inherit"),s&&"set"in s&&void 0===(n=s.set(e,n,r))||(u[t]=n)),void 0)}},css:function(e,t,n,r){var i,o,s,a=Z.camelCase(t);return t=Z.cssProps[a]||(Z.cssProps[a]=k(e.style,a)),s=Z.cssHooks[t]||Z.cssHooks[a],s&&"get"in s&&(i=s.get(e,!0,n)),void 0===i&&(i=w(e,t,r)),"normal"===i&&t in Jt&&(i=Jt[t]),""===n||n?(o=parseFloat(i),n===!0||Z.isNumeric(o)?o||0:i):i}}),Z.each(["height","width"],function(e,t){Z.cssHooks[t]={get:function(e,n,r){return n?Wt.test(Z.css(e,"display"))&&0===e.offsetWidth?Z.swap(e,Vt,function(){return _(e,t,r)}):_(e,t,r):void 0},set:function(e,n,r){var i=r&&zt(e);return T(e,n,r?E(e,t,r,"border-box"===Z.css(e,"boxSizing",!1,i),i):0)}}}),Z.cssHooks.marginRight=C(G.reliableMarginRight,function(e,t){return t?Z.swap(e,{display:"inline-block"},w,[e,"marginRight"]):void 0}),Z.each({margin:"",padding:"",border:"Width"},function(e,t){Z.cssHooks[e+t]={expand:function(n){for(var r=0,i={},o="string"==typeof n?n.split(" "):[n];4>r;r++)i[e+Ct[r]+t]=o[r]||o[r-2]||o[0];return i}},Rt.test(e)||(Z.cssHooks[e+t].set=T)}),Z.fn.extend({css:function(e,t){return vt(this,function(e,t,n){var r,i,o={},s=0;if(Z.isArray(t)){for(r=zt(e),i=t.length;i>s;s++)o[t[s]]=Z.css(e,t[s],!1,r);return o}return void 0!==n?Z.style(e,t,n):Z.css(e,t)},e,t,arguments.length>1)},show:function(){return S(this,!0)},hide:function(){return S(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){kt(this)?Z(this).show():Z(this).hide()})}}),Z.Tween=N,N.prototype={constructor:N,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||"swing",this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(Z.cssNumber[n]?"":"px")},cur:function(){var e=N.propHooks[this.prop];return e&&e.get?e.get(this):N.propHooks._default.get(this)},run:function(e){var t,n=N.propHooks[this.prop];return this.pos=t=this.options.duration?Z.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):N.propHooks._default.set(this),this}},N.prototype.init.prototype=N.prototype,N.propHooks={_default:{get:function(e){var t;return null==e.elem[e.prop]||e.elem.style&&null!=e.elem.style[e.prop]?(t=Z.css(e.elem,e.prop,""),t&&"auto"!==t?t:0):e.elem[e.prop]},set:function(e){Z.fx.step[e.prop]?Z.fx.step[e.prop](e):e.elem.style&&(null!=e.elem.style[Z.cssProps[e.prop]]||Z.cssHooks[e.prop])?Z.style(e.elem,e.prop,e.now+e.unit):e.elem[e.prop]=e.now}}},N.propHooks.scrollTop=N.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},Z.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2}},Z.fx=N.prototype.init,Z.fx.step={};var Gt,Qt,Kt=/^(?:toggle|show|hide)$/,Zt=new RegExp("^(?:([+-])=|)("+wt+")([a-z%]*)$","i"),en=/queueHooks$/,tn=[D],nn={"*":[function(e,t){var n=this.createTween(e,t),r=n.cur(),i=Zt.exec(t),o=i&&i[3]||(Z.cssNumber[e]?"":"px"),s=(Z.cssNumber[e]||"px"!==o&&+r)&&Zt.exec(Z.css(n.elem,e)),a=1,u=20;if(s&&s[3]!==o){o=o||s[3],i=i||[],s=+r||1;do a=a||".5",s/=a,Z.style(n.elem,e,s+o);while(a!==(a=n.cur()/r)&&1!==a&&--u)}return i&&(s=n.start=+s||+r||0,n.unit=o,n.end=i[1]?s+(i[1]+1)*i[2]:+i[2]),n}]};Z.Animation=Z.extend(F,{tweener:function(e,t){Z.isFunction(e)?(t=e,e=["*"]):e=e.split(" ");for(var n,r=0,i=e.length;i>r;r++)n=e[r],nn[n]=nn[n]||[],nn[n].unshift(t)},prefilter:function(e,t){t?tn.unshift(e):tn.push(e)}}),Z.speed=function(e,t,n){var r=e&&"object"==typeof e?Z.extend({},e):{complete:n||!n&&t||Z.isFunction(e)&&e,duration:e,easing:n&&t||t&&!Z.isFunction(t)&&t};return r.duration=Z.fx.off?0:"number"==typeof r.duration?r.duration:r.duration in Z.fx.speeds?Z.fx.speeds[r.duration]:Z.fx.speeds._default,(null==r.queue||r.queue===!0)&&(r.queue="fx"),r.old=r.complete,r.complete=function(){Z.isFunction(r.old)&&r.old.call(this),r.queue&&Z.dequeue(this,r.queue)},r},Z.fn.extend({fadeTo:function(e,t,n,r){return this.filter(kt).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(e,t,n,r){var i=Z.isEmptyObject(e),o=Z.speed(t,n,r),s=function(){var t=F(this,Z.extend({},e),o);(i||mt.get(this,"finish"))&&t.stop(!0)};return s.finish=s,i||o.queue===!1?this.each(s):this.queue(o.queue,s)},stop:function(e,t,n){var r=function(e){var t=e.stop;delete e.stop,t(n)};return"string"!=typeof e&&(n=t,t=e,e=void 0),t&&e!==!1&&this.queue(e||"fx",[]),this.each(function(){var t=!0,i=null!=e&&e+"queueHooks",o=Z.timers,s=mt.get(this);if(i)s[i]&&s[i].stop&&r(s[i]);else for(i in s)s[i]&&s[i].stop&&en.test(i)&&r(s[i]);for(i=o.length;i--;)o[i].elem!==this||null!=e&&o[i].queue!==e||(o[i].anim.stop(n),t=!1,o.splice(i,1));(t||!n)&&Z.dequeue(this,e)})},finish:function(e){return e!==!1&&(e=e||"fx"),this.each(function(){var t,n=mt.get(this),r=n[e+"queue"],i=n[e+"queueHooks"],o=Z.timers,s=r?r.length:0;for(n.finish=!0,Z.queue(this,e,[]),i&&i.stop&&i.stop.call(this,!0),t=o.length;t--;)o[t].elem===this&&o[t].queue===e&&(o[t].anim.stop(!0),o.splice(t,1));for(t=0;s>t;t++)r[t]&&r[t].finish&&r[t].finish.call(this);delete n.finish})}}),Z.each(["toggle","show","hide"],function(e,t){var n=Z.fn[t];Z.fn[t]=function(e,r,i){return null==e||"boolean"==typeof e?n.apply(this,arguments):this.animate($(t,!0),e,r,i)}}),Z.each({slideDown:$("show"),slideUp:$("hide"),slideToggle:$("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,t){Z.fn[e]=function(e,n,r){return this.animate(t,e,n,r)}}),Z.timers=[],Z.fx.tick=function(){var e,t=0,n=Z.timers;for(Gt=Z.now();t<n.length;t++)e=n[t],e()||n[t]!==e||n.splice(t--,1);n.length||Z.fx.stop(),Gt=void 0},Z.fx.timer=function(e){Z.timers.push(e),e()?Z.fx.start():Z.timers.pop()},Z.fx.interval=13,Z.fx.start=function(){Qt||(Qt=setInterval(Z.fx.tick,Z.fx.interval))},Z.fx.stop=function(){clearInterval(Qt),Qt=null},Z.fx.speeds={slow:600,fast:200,_default:400},Z.fn.delay=function(e,t){return e=Z.fx?Z.fx.speeds[e]||e:e,t=t||"fx",this.queue(t,function(t,n){var r=setTimeout(t,e);n.stop=function(){clearTimeout(r)}})},function(){var e=Q.createElement("input"),t=Q.createElement("select"),n=t.appendChild(Q.createElement("option"));e.type="checkbox",G.checkOn=""!==e.value,G.optSelected=n.selected,t.disabled=!0,G.optDisabled=!n.disabled,e=Q.createElement("input"),e.value="t",e.type="radio",G.radioValue="t"===e.value}();var rn,on,sn=Z.expr.attrHandle;Z.fn.extend({attr:function(e,t){return vt(this,Z.attr,e,t,arguments.length>1)},removeAttr:function(e){return this.each(function(){Z.removeAttr(this,e)})}}),Z.extend({attr:function(e,t,n){var r,i,o=e.nodeType;if(e&&3!==o&&8!==o&&2!==o)return typeof e.getAttribute===Et?Z.prop(e,t,n):(1===o&&Z.isXMLDoc(e)||(t=t.toLowerCase(),r=Z.attrHooks[t]||(Z.expr.match.bool.test(t)?on:rn)),void 0===n?r&&"get"in r&&null!==(i=r.get(e,t))?i:(i=Z.find.attr(e,t),null==i?void 0:i):null!==n?r&&"set"in r&&void 0!==(i=r.set(e,n,t))?i:(e.setAttribute(t,n+""),n):void Z.removeAttr(e,t))},removeAttr:function(e,t){var n,r,i=0,o=t&&t.match(pt);if(o&&1===e.nodeType)for(;n=o[i++];)r=Z.propFix[n]||n,Z.expr.match.bool.test(n)&&(e[r]=!1),e.removeAttribute(n)},attrHooks:{type:{set:function(e,t){if(!G.radioValue&&"radio"===t&&Z.nodeName(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}}}),on={set:function(e,t,n){return t===!1?Z.removeAttr(e,n):e.setAttribute(n,n),n}},Z.each(Z.expr.match.bool.source.match(/\w+/g),function(e,t){var n=sn[t]||Z.find.attr;sn[t]=function(e,t,r){var i,o;return r||(o=sn[t],sn[t]=i,i=null!=n(e,t,r)?t.toLowerCase():null,sn[t]=o),i}});var an=/^(?:input|select|textarea|button)$/i;Z.fn.extend({prop:function(e,t){return vt(this,Z.prop,e,t,arguments.length>1)},removeProp:function(e){return this.each(function(){delete this[Z.propFix[e]||e]})}}),Z.extend({propFix:{"for":"htmlFor","class":"className"},prop:function(e,t,n){var r,i,o,s=e.nodeType;if(e&&3!==s&&8!==s&&2!==s)return o=1!==s||!Z.isXMLDoc(e),o&&(t=Z.propFix[t]||t,i=Z.propHooks[t]),void 0!==n?i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:e[t]=n:i&&"get"in i&&null!==(r=i.get(e,t))?r:e[t]},propHooks:{tabIndex:{get:function(e){return e.hasAttribute("tabindex")||an.test(e.nodeName)||e.href?e.tabIndex:-1}}}}),G.optSelected||(Z.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null}}),Z.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){Z.propFix[this.toLowerCase()]=this});var un=/[\t\r\n\f]/g;Z.fn.extend({addClass:function(e){var t,n,r,i,o,s,a="string"==typeof e&&e,u=0,l=this.length;if(Z.isFunction(e))return this.each(function(t){Z(this).addClass(e.call(this,t,this.className))});if(a)for(t=(e||"").match(pt)||[];l>u;u++)if(n=this[u],r=1===n.nodeType&&(n.className?(" "+n.className+" ").replace(un," "):" ")){for(o=0;i=t[o++];)r.indexOf(" "+i+" ")<0&&(r+=i+" ");s=Z.trim(r),n.className!==s&&(n.className=s)}return this},removeClass:function(e){var t,n,r,i,o,s,a=0===arguments.length||"string"==typeof e&&e,u=0,l=this.length;if(Z.isFunction(e))return this.each(function(t){Z(this).removeClass(e.call(this,t,this.className))});if(a)for(t=(e||"").match(pt)||[];l>u;u++)if(n=this[u],r=1===n.nodeType&&(n.className?(" "+n.className+" ").replace(un," "):"")){for(o=0;i=t[o++];)for(;r.indexOf(" "+i+" ")>=0;)r=r.replace(" "+i+" "," ");s=e?Z.trim(r):"",n.className!==s&&(n.className=s)}return this},toggleClass:function(e,t){var n=typeof e;return"boolean"==typeof t&&"string"===n?t?this.addClass(e):this.removeClass(e):this.each(Z.isFunction(e)?function(n){Z(this).toggleClass(e.call(this,n,this.className,t),t)}:function(){if("string"===n)for(var t,r=0,i=Z(this),o=e.match(pt)||[];t=o[r++];)i.hasClass(t)?i.removeClass(t):i.addClass(t);else(n===Et||"boolean"===n)&&(this.className&&mt.set(this,"__className__",this.className),this.className=this.className||e===!1?"":mt.get(this,"__className__")||"")})},hasClass:function(e){for(var t=" "+e+" ",n=0,r=this.length;r>n;n++)if(1===this[n].nodeType&&(" "+this[n].className+" ").replace(un," ").indexOf(t)>=0)return!0;return!1}});var ln=/\r/g;Z.fn.extend({val:function(e){var t,n,r,i=this[0];{if(arguments.length)return r=Z.isFunction(e),this.each(function(n){var i;1===this.nodeType&&(i=r?e.call(this,n,Z(this).val()):e,null==i?i="":"number"==typeof i?i+="":Z.isArray(i)&&(i=Z.map(i,function(e){return null==e?"":e+""})),t=Z.valHooks[this.type]||Z.valHooks[this.nodeName.toLowerCase()],t&&"set"in t&&void 0!==t.set(this,i,"value")||(this.value=i))});if(i)return t=Z.valHooks[i.type]||Z.valHooks[i.nodeName.toLowerCase()],t&&"get"in t&&void 0!==(n=t.get(i,"value"))?n:(n=i.value,"string"==typeof n?n.replace(ln,""):null==n?"":n)}}}),Z.extend({valHooks:{option:{get:function(e){var t=Z.find.attr(e,"value");return null!=t?t:Z.trim(Z.text(e))}},select:{get:function(e){for(var t,n,r=e.options,i=e.selectedIndex,o="select-one"===e.type||0>i,s=o?null:[],a=o?i+1:r.length,u=0>i?a:o?i:0;a>u;u++)if(n=r[u],!(!n.selected&&u!==i||(G.optDisabled?n.disabled:null!==n.getAttribute("disabled"))||n.parentNode.disabled&&Z.nodeName(n.parentNode,"optgroup"))){if(t=Z(n).val(),o)return t;s.push(t)}return s},set:function(e,t){for(var n,r,i=e.options,o=Z.makeArray(t),s=i.length;s--;)r=i[s],(r.selected=Z.inArray(r.value,o)>=0)&&(n=!0);return n||(e.selectedIndex=-1),o}}}}),Z.each(["radio","checkbox"],function(){Z.valHooks[this]={set:function(e,t){return Z.isArray(t)?e.checked=Z.inArray(Z(e).val(),t)>=0:void 0}},G.checkOn||(Z.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})}),Z.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(e,t){Z.fn[t]=function(e,n){return arguments.length>0?this.on(t,null,e,n):this.trigger(t)}}),Z.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)},bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)}});var cn=Z.now(),hn=/\?/;Z.parseJSON=function(e){return JSON.parse(e+"")},Z.parseXML=function(e){var t,n;if(!e||"string"!=typeof e)return null;try{n=new DOMParser,t=n.parseFromString(e,"text/xml")}catch(r){t=void 0}return(!t||t.getElementsByTagName("parsererror").length)&&Z.error("Invalid XML: "+e),t};var fn=/#.*$/,pn=/([?&])_=[^&]*/,dn=/^(.*?):[ \t]*([^\r\n]*)$/gm,gn=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,vn=/^(?:GET|HEAD)$/,mn=/^\/\//,yn=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,xn={},bn={},wn="*/".concat("*"),Cn=e.location.href,kn=yn.exec(Cn.toLowerCase())||[];Z.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Cn,type:"GET",isLocal:gn.test(kn[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":wn,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":Z.parseJSON,"text xml":Z.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?H(H(e,Z.ajaxSettings),t):H(Z.ajaxSettings,e)},ajaxPrefilter:L(xn),ajaxTransport:L(bn),ajax:function(e,t){function n(e,t,n,s){var u,c,m,y,b,C=t;2!==x&&(x=2,a&&clearTimeout(a),r=void 0,o=s||"",w.readyState=e>0?4:0,u=e>=200&&300>e||304===e,n&&(y=P(h,w,n)),y=M(h,y,w,u),u?(h.ifModified&&(b=w.getResponseHeader("Last-Modified"),b&&(Z.lastModified[i]=b),b=w.getResponseHeader("etag"),b&&(Z.etag[i]=b)),204===e||"HEAD"===h.type?C="nocontent":304===e?C="notmodified":(C=y.state,c=y.data,m=y.error,u=!m)):(m=C,(e||!C)&&(C="error",0>e&&(e=0))),w.status=e,w.statusText=(t||C)+"",u?d.resolveWith(f,[c,C,w]):d.rejectWith(f,[w,C,m]),w.statusCode(v),v=void 0,l&&p.trigger(u?"ajaxSuccess":"ajaxError",[w,h,u?c:m]),g.fireWith(f,[w,C]),l&&(p.trigger("ajaxComplete",[w,h]),--Z.active||Z.event.trigger("ajaxStop")))}"object"==typeof e&&(t=e,e=void 0),t=t||{};var r,i,o,s,a,u,l,c,h=Z.ajaxSetup({},t),f=h.context||h,p=h.context&&(f.nodeType||f.jquery)?Z(f):Z.event,d=Z.Deferred(),g=Z.Callbacks("once memory"),v=h.statusCode||{},m={},y={},x=0,b="canceled",w={readyState:0,getResponseHeader:function(e){var t;if(2===x){if(!s)for(s={};t=dn.exec(o);)s[t[1].toLowerCase()]=t[2];t=s[e.toLowerCase()]}return null==t?null:t},getAllResponseHeaders:function(){return 2===x?o:null},setRequestHeader:function(e,t){var n=e.toLowerCase();return x||(e=y[n]=y[n]||e,m[e]=t),this},overrideMimeType:function(e){return x||(h.mimeType=e),this},statusCode:function(e){var t;if(e)if(2>x)for(t in e)v[t]=[v[t],e[t]];else w.always(e[w.status]);return this},abort:function(e){var t=e||b;return r&&r.abort(t),n(0,t),this}};if(d.promise(w).complete=g.add,w.success=w.done,w.error=w.fail,h.url=((e||h.url||Cn)+"").replace(fn,"").replace(mn,kn[1]+"//"),h.type=t.method||t.type||h.method||h.type,h.dataTypes=Z.trim(h.dataType||"*").toLowerCase().match(pt)||[""],null==h.crossDomain&&(u=yn.exec(h.url.toLowerCase()),h.crossDomain=!(!u||u[1]===kn[1]&&u[2]===kn[2]&&(u[3]||("http:"===u[1]?"80":"443"))===(kn[3]||("http:"===kn[1]?"80":"443")))),h.data&&h.processData&&"string"!=typeof h.data&&(h.data=Z.param(h.data,h.traditional)),O(xn,h,t,w),2===x)return w;l=Z.event&&h.global,l&&0===Z.active++&&Z.event.trigger("ajaxStart"),h.type=h.type.toUpperCase(),h.hasContent=!vn.test(h.type),i=h.url,h.hasContent||(h.data&&(i=h.url+=(hn.test(i)?"&":"?")+h.data,delete h.data),h.cache===!1&&(h.url=pn.test(i)?i.replace(pn,"$1_="+cn++):i+(hn.test(i)?"&":"?")+"_="+cn++)),h.ifModified&&(Z.lastModified[i]&&w.setRequestHeader("If-Modified-Since",Z.lastModified[i]),Z.etag[i]&&w.setRequestHeader("If-None-Match",Z.etag[i])),(h.data&&h.hasContent&&h.contentType!==!1||t.contentType)&&w.setRequestHeader("Content-Type",h.contentType),w.setRequestHeader("Accept",h.dataTypes[0]&&h.accepts[h.dataTypes[0]]?h.accepts[h.dataTypes[0]]+("*"!==h.dataTypes[0]?", "+wn+"; q=0.01":""):h.accepts["*"]);for(c in h.headers)w.setRequestHeader(c,h.headers[c]);if(h.beforeSend&&(h.beforeSend.call(f,w,h)===!1||2===x))return w.abort();b="abort";for(c in{success:1,error:1,complete:1})w[c](h[c]);if(r=O(bn,h,t,w)){w.readyState=1,l&&p.trigger("ajaxSend",[w,h]),h.async&&h.timeout>0&&(a=setTimeout(function(){w.abort("timeout")},h.timeout));try{x=1,r.send(m,n)}catch(C){if(!(2>x))throw C;n(-1,C)}}else n(-1,"No Transport");return w},getJSON:function(e,t,n){return Z.get(e,t,n,"json")},getScript:function(e,t){return Z.get(e,void 0,t,"script")}}),Z.each(["get","post"],function(e,t){Z[t]=function(e,n,r,i){return Z.isFunction(n)&&(i=i||r,r=n,n=void 0),Z.ajax({url:e,type:t,dataType:i,data:n,success:r})}}),Z._evalUrl=function(e){return Z.ajax({url:e,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0})},Z.fn.extend({wrapAll:function(e){var t;return Z.isFunction(e)?this.each(function(t){Z(this).wrapAll(e.call(this,t))}):(this[0]&&(t=Z(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){for(var e=this;e.firstElementChild;)e=e.firstElementChild;return e}).append(this)),this)},wrapInner:function(e){return this.each(Z.isFunction(e)?function(t){Z(this).wrapInner(e.call(this,t))}:function(){var t=Z(this),n=t.contents();n.length?n.wrapAll(e):t.append(e)})},wrap:function(e){var t=Z.isFunction(e);return this.each(function(n){Z(this).wrapAll(t?e.call(this,n):e)})},unwrap:function(){return this.parent().each(function(){Z.nodeName(this,"body")||Z(this).replaceWith(this.childNodes)}).end()}}),Z.expr.filters.hidden=function(e){return e.offsetWidth<=0&&e.offsetHeight<=0},Z.expr.filters.visible=function(e){return!Z.expr.filters.hidden(e)};var Tn=/%20/g,En=/\[\]$/,_n=/\r?\n/g,Sn=/^(?:submit|button|image|reset|file)$/i,Nn=/^(?:input|select|textarea|keygen)/i;Z.param=function(e,t){var n,r=[],i=function(e,t){t=Z.isFunction(t)?t():null==t?"":t,r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(t)};if(void 0===t&&(t=Z.ajaxSettings&&Z.ajaxSettings.traditional),Z.isArray(e)||e.jquery&&!Z.isPlainObject(e))Z.each(e,function(){i(this.name,this.value)});else for(n in e)I(n,e[n],t,i);return r.join("&").replace(Tn,"+")},Z.fn.extend({serialize:function(){return Z.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=Z.prop(this,"elements");return e?Z.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!Z(this).is(":disabled")&&Nn.test(this.nodeName)&&!Sn.test(e)&&(this.checked||!Tt.test(e))}).map(function(e,t){var n=Z(this).val();return null==n?null:Z.isArray(n)?Z.map(n,function(e){return{name:t.name,value:e.replace(_n,"\r\n")}}):{name:t.name,value:n.replace(_n,"\r\n")}}).get()}}),Z.ajaxSettings.xhr=function(){try{return new XMLHttpRequest}catch(e){}};var jn=0,$n={},An={0:200,1223:204},Dn=Z.ajaxSettings.xhr();e.attachEvent&&e.attachEvent("onunload",function(){for(var e in $n)$n[e]()}),G.cors=!!Dn&&"withCredentials"in Dn,G.ajax=Dn=!!Dn,Z.ajaxTransport(function(e){var t;return G.cors||Dn&&!e.crossDomain?{send:function(n,r){var i,o=e.xhr(),s=++jn;if(o.open(e.type,e.url,e.async,e.username,e.password),e.xhrFields)for(i in e.xhrFields)o[i]=e.xhrFields[i];e.mimeType&&o.overrideMimeType&&o.overrideMimeType(e.mimeType),e.crossDomain||n["X-Requested-With"]||(n["X-Requested-With"]="XMLHttpRequest");for(i in n)o.setRequestHeader(i,n[i]);t=function(e){return function(){t&&(delete $n[s],t=o.onload=o.onerror=null,"abort"===e?o.abort():"error"===e?r(o.status,o.statusText):r(An[o.status]||o.status,o.statusText,"string"==typeof o.responseText?{text:o.responseText}:void 0,o.getAllResponseHeaders()))}},o.onload=t(),o.onerror=t("error"),t=$n[s]=t("abort");try{o.send(e.hasContent&&e.data||null)}catch(a){if(t)throw a}},abort:function(){t&&t()}}:void 0}),Z.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(e){return Z.globalEval(e),e}}}),Z.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),Z.ajaxTransport("script",function(e){if(e.crossDomain){var t,n;return{send:function(r,i){t=Z("<script>").prop({async:!0,charset:e.scriptCharset,src:e.url}).on("load error",n=function(e){t.remove(),n=null,e&&i("error"===e.type?404:200,e.type)}),Q.head.appendChild(t[0])},abort:function(){n&&n()}}}});var qn=[],Fn=/(=)\?(?=&|$)|\?\?/;Z.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=qn.pop()||Z.expando+"_"+cn++;return this[e]=!0,e}}),Z.ajaxPrefilter("json jsonp",function(t,n,r){var i,o,s,a=t.jsonp!==!1&&(Fn.test(t.url)?"url":"string"==typeof t.data&&!(t.contentType||"").indexOf("application/x-www-form-urlencoded")&&Fn.test(t.data)&&"data");return a||"jsonp"===t.dataTypes[0]?(i=t.jsonpCallback=Z.isFunction(t.jsonpCallback)?t.jsonpCallback():t.jsonpCallback,a?t[a]=t[a].replace(Fn,"$1"+i):t.jsonp!==!1&&(t.url+=(hn.test(t.url)?"&":"?")+t.jsonp+"="+i),t.converters["script json"]=function(){return s||Z.error(i+" was not called"),s[0]},t.dataTypes[0]="json",o=e[i],e[i]=function(){s=arguments},r.always(function(){e[i]=o,t[i]&&(t.jsonpCallback=n.jsonpCallback,qn.push(i)),s&&Z.isFunction(o)&&o(s[0]),s=o=void 0}),"script"):void 0}),Z.parseHTML=function(e,t,n){if(!e||"string"!=typeof e)return null;"boolean"==typeof t&&(n=t,t=!1),t=t||Q;var r=st.exec(e),i=!n&&[];return r?[t.createElement(r[1])]:(r=Z.buildFragment([e],t,i),i&&i.length&&Z(i).remove(),Z.merge([],r.childNodes))};var Ln=Z.fn.load;Z.fn.load=function(e,t,n){if("string"!=typeof e&&Ln)return Ln.apply(this,arguments);var r,i,o,s=this,a=e.indexOf(" ");return a>=0&&(r=Z.trim(e.slice(a)),e=e.slice(0,a)),Z.isFunction(t)?(n=t,t=void 0):t&&"object"==typeof t&&(i="POST"),s.length>0&&Z.ajax({url:e,type:i,dataType:"html",data:t}).done(function(e){o=arguments,s.html(r?Z("<div>").append(Z.parseHTML(e)).find(r):e)}).complete(n&&function(e,t){s.each(n,o||[e.responseText,t,e])}),this},Z.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){Z.fn[t]=function(e){return this.on(t,e)}}),Z.expr.filters.animated=function(e){return Z.grep(Z.timers,function(t){return e===t.elem}).length};var On=e.document.documentElement;Z.offset={setOffset:function(e,t,n){var r,i,o,s,a,u,l,c=Z.css(e,"position"),h=Z(e),f={};"static"===c&&(e.style.position="relative"),a=h.offset(),o=Z.css(e,"top"),u=Z.css(e,"left"),l=("absolute"===c||"fixed"===c)&&(o+u).indexOf("auto")>-1,l?(r=h.position(),s=r.top,i=r.left):(s=parseFloat(o)||0,i=parseFloat(u)||0),Z.isFunction(t)&&(t=t.call(e,n,a)),null!=t.top&&(f.top=t.top-a.top+s),null!=t.left&&(f.left=t.left-a.left+i),"using"in t?t.using.call(e,f):h.css(f)}},Z.fn.extend({offset:function(e){if(arguments.length)return void 0===e?this:this.each(function(t){Z.offset.setOffset(this,e,t)});var t,n,r=this[0],i={top:0,left:0},o=r&&r.ownerDocument;if(o)return t=o.documentElement,Z.contains(t,r)?(typeof r.getBoundingClientRect!==Et&&(i=r.getBoundingClientRect()),n=R(o),{top:i.top+n.pageYOffset-t.clientTop,left:i.left+n.pageXOffset-t.clientLeft}):i},position:function(){if(this[0]){var e,t,n=this[0],r={top:0,left:0};return"fixed"===Z.css(n,"position")?t=n.getBoundingClientRect():(e=this.offsetParent(),t=this.offset(),Z.nodeName(e[0],"html")||(r=e.offset()),r.top+=Z.css(e[0],"borderTopWidth",!0),r.left+=Z.css(e[0],"borderLeftWidth",!0)),{top:t.top-r.top-Z.css(n,"marginTop",!0),left:t.left-r.left-Z.css(n,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var e=this.offsetParent||On;e&&!Z.nodeName(e,"html")&&"static"===Z.css(e,"position");)e=e.offsetParent;return e||On})}}),Z.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(t,n){var r="pageYOffset"===n;Z.fn[t]=function(i){return vt(this,function(t,i,o){var s=R(t);return void 0===o?s?s[n]:t[i]:void(s?s.scrollTo(r?e.pageXOffset:o,r?o:e.pageYOffset):t[i]=o)},t,i,arguments.length,null)}}),Z.each(["top","left"],function(e,t){Z.cssHooks[t]=C(G.pixelPosition,function(e,n){return n?(n=w(e,t),Bt.test(n)?Z(e).position()[t]+"px":n):void 0})}),Z.each({Height:"height",Width:"width"},function(e,t){Z.each({padding:"inner"+e,content:t,"":"outer"+e},function(n,r){Z.fn[r]=function(r,i){var o=arguments.length&&(n||"boolean"!=typeof r),s=n||(r===!0||i===!0?"margin":"border");return vt(this,function(t,n,r){var i;return Z.isWindow(t)?t.document.documentElement["client"+e]:9===t.nodeType?(i=t.documentElement,Math.max(t.body["scroll"+e],i["scroll"+e],t.body["offset"+e],i["offset"+e],i["client"+e])):void 0===r?Z.css(t,n,s):Z.style(t,n,r,s)},t,o?r:void 0,o,null)}})}),Z.fn.size=function(){return this.length},Z.fn.andSelf=Z.fn.addBack,"function"==typeof define&&define.amd&&define("jquery",[],function(){return Z});var Hn=e.jQuery,Pn=e.$;return Z.noConflict=function(t){return e.$===Z&&(e.$=Pn),t&&e.jQuery===Z&&(e.jQuery=Hn),Z},typeof t===Et&&(e.jQuery=e.$=Z),Z})},{}],13:[function(e,t,n){(function(){var e=this,r=e._,i=Array.prototype,o=Object.prototype,s=Function.prototype,a=i.push,u=i.slice,l=i.concat,c=o.toString,h=o.hasOwnProperty,f=Array.isArray,p=Object.keys,d=s.bind,g=function(e){return e instanceof g?e:this instanceof g?void(this._wrapped=e):new g(e)};"undefined"!=typeof n?("undefined"!=typeof t&&t.exports&&(n=t.exports=g),n._=g):e._=g,g.VERSION="1.7.0";var v=function(e,t,n){if(void 0===t)return e;switch(null==n?3:n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,i){return e.call(t,n,r,i)};case 4:return function(n,r,i,o){return e.call(t,n,r,i,o)}}return function(){return e.apply(t,arguments)}};g.iteratee=function(e,t,n){return null==e?g.identity:g.isFunction(e)?v(e,t,n):g.isObject(e)?g.matches(e):g.property(e)},g.each=g.forEach=function(e,t,n){if(null==e)return e;t=v(t,n);var r,i=e.length;if(i===+i)for(r=0;i>r;r++)t(e[r],r,e);else{var o=g.keys(e);for(r=0,i=o.length;i>r;r++)t(e[o[r]],o[r],e)}return e},g.map=g.collect=function(e,t,n){if(null==e)return[];t=g.iteratee(t,n);for(var r,i=e.length!==+e.length&&g.keys(e),o=(i||e).length,s=Array(o),a=0;o>a;a++)r=i?i[a]:a,s[a]=t(e[r],r,e);return s};var m="Reduce of empty array with no initial value";g.reduce=g.foldl=g.inject=function(e,t,n,r){null==e&&(e=[]),t=v(t,r,4);var i,o=e.length!==+e.length&&g.keys(e),s=(o||e).length,a=0;if(arguments.length<3){if(!s)throw new TypeError(m);n=e[o?o[a++]:a++]}for(;s>a;a++)i=o?o[a]:a,n=t(n,e[i],i,e);return n},g.reduceRight=g.foldr=function(e,t,n,r){null==e&&(e=[]),t=v(t,r,4);var i,o=e.length!==+e.length&&g.keys(e),s=(o||e).length;if(arguments.length<3){if(!s)throw new TypeError(m);n=e[o?o[--s]:--s]}for(;s--;)i=o?o[s]:s,n=t(n,e[i],i,e);return n},g.find=g.detect=function(e,t,n){var r;return t=g.iteratee(t,n),g.some(e,function(e,n,i){return t(e,n,i)?(r=e,!0):void 0}),r},g.filter=g.select=function(e,t,n){var r=[];return null==e?r:(t=g.iteratee(t,n),g.each(e,function(e,n,i){t(e,n,i)&&r.push(e)}),r)},g.reject=function(e,t,n){return g.filter(e,g.negate(g.iteratee(t)),n)},g.every=g.all=function(e,t,n){if(null==e)return!0;t=g.iteratee(t,n);var r,i,o=e.length!==+e.length&&g.keys(e),s=(o||e).length;for(r=0;s>r;r++)if(i=o?o[r]:r,!t(e[i],i,e))return!1;return!0},g.some=g.any=function(e,t,n){if(null==e)return!1;t=g.iteratee(t,n);var r,i,o=e.length!==+e.length&&g.keys(e),s=(o||e).length;for(r=0;s>r;r++)if(i=o?o[r]:r,t(e[i],i,e))return!0;return!1},g.contains=g.include=function(e,t){return null==e?!1:(e.length!==+e.length&&(e=g.values(e)),g.indexOf(e,t)>=0)},g.invoke=function(e,t){var n=u.call(arguments,2),r=g.isFunction(t);return g.map(e,function(e){return(r?t:e[t]).apply(e,n)})},g.pluck=function(e,t){return g.map(e,g.property(t))},g.where=function(e,t){return g.filter(e,g.matches(t))},g.findWhere=function(e,t){return g.find(e,g.matches(t))},g.max=function(e,t,n){var r,i,o=-1/0,s=-1/0;if(null==t&&null!=e){e=e.length===+e.length?e:g.values(e);for(var a=0,u=e.length;u>a;a++)r=e[a],r>o&&(o=r)}else t=g.iteratee(t,n),g.each(e,function(e,n,r){i=t(e,n,r),(i>s||i===-1/0&&o===-1/0)&&(o=e,s=i)});return o},g.min=function(e,t,n){var r,i,o=1/0,s=1/0;if(null==t&&null!=e){e=e.length===+e.length?e:g.values(e);for(var a=0,u=e.length;u>a;a++)r=e[a],o>r&&(o=r)}else t=g.iteratee(t,n),g.each(e,function(e,n,r){i=t(e,n,r),(s>i||1/0===i&&1/0===o)&&(o=e,s=i)});return o},g.shuffle=function(e){for(var t,n=e&&e.length===+e.length?e:g.values(e),r=n.length,i=Array(r),o=0;r>o;o++)t=g.random(0,o),t!==o&&(i[o]=i[t]),i[t]=n[o];return i},g.sample=function(e,t,n){return null==t||n?(e.length!==+e.length&&(e=g.values(e)),e[g.random(e.length-1)]):g.shuffle(e).slice(0,Math.max(0,t))},g.sortBy=function(e,t,n){return t=g.iteratee(t,n),g.pluck(g.map(e,function(e,n,r){return{value:e,index:n,criteria:t(e,n,r)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;
if(n!==r){if(n>r||void 0===n)return 1;if(r>n||void 0===r)return-1}return e.index-t.index}),"value")};var y=function(e){return function(t,n,r){var i={};return n=g.iteratee(n,r),g.each(t,function(r,o){var s=n(r,o,t);e(i,r,s)}),i}};g.groupBy=y(function(e,t,n){g.has(e,n)?e[n].push(t):e[n]=[t]}),g.indexBy=y(function(e,t,n){e[n]=t}),g.countBy=y(function(e,t,n){g.has(e,n)?e[n]++:e[n]=1}),g.sortedIndex=function(e,t,n,r){n=g.iteratee(n,r,1);for(var i=n(t),o=0,s=e.length;s>o;){var a=o+s>>>1;n(e[a])<i?o=a+1:s=a}return o},g.toArray=function(e){return e?g.isArray(e)?u.call(e):e.length===+e.length?g.map(e,g.identity):g.values(e):[]},g.size=function(e){return null==e?0:e.length===+e.length?e.length:g.keys(e).length},g.partition=function(e,t,n){t=g.iteratee(t,n);var r=[],i=[];return g.each(e,function(e,n,o){(t(e,n,o)?r:i).push(e)}),[r,i]},g.first=g.head=g.take=function(e,t,n){return null==e?void 0:null==t||n?e[0]:0>t?[]:u.call(e,0,t)},g.initial=function(e,t,n){return u.call(e,0,Math.max(0,e.length-(null==t||n?1:t)))},g.last=function(e,t,n){return null==e?void 0:null==t||n?e[e.length-1]:u.call(e,Math.max(e.length-t,0))},g.rest=g.tail=g.drop=function(e,t,n){return u.call(e,null==t||n?1:t)},g.compact=function(e){return g.filter(e,g.identity)};var x=function(e,t,n,r){if(t&&g.every(e,g.isArray))return l.apply(r,e);for(var i=0,o=e.length;o>i;i++){var s=e[i];g.isArray(s)||g.isArguments(s)?t?a.apply(r,s):x(s,t,n,r):n||r.push(s)}return r};g.flatten=function(e,t){return x(e,t,!1,[])},g.without=function(e){return g.difference(e,u.call(arguments,1))},g.uniq=g.unique=function(e,t,n,r){if(null==e)return[];g.isBoolean(t)||(r=n,n=t,t=!1),null!=n&&(n=g.iteratee(n,r));for(var i=[],o=[],s=0,a=e.length;a>s;s++){var u=e[s];if(t)s&&o===u||i.push(u),o=u;else if(n){var l=n(u,s,e);g.indexOf(o,l)<0&&(o.push(l),i.push(u))}else g.indexOf(i,u)<0&&i.push(u)}return i},g.union=function(){return g.uniq(x(arguments,!0,!0,[]))},g.intersection=function(e){if(null==e)return[];for(var t=[],n=arguments.length,r=0,i=e.length;i>r;r++){var o=e[r];if(!g.contains(t,o)){for(var s=1;n>s&&g.contains(arguments[s],o);s++);s===n&&t.push(o)}}return t},g.difference=function(e){var t=x(u.call(arguments,1),!0,!0,[]);return g.filter(e,function(e){return!g.contains(t,e)})},g.zip=function(e){if(null==e)return[];for(var t=g.max(arguments,"length").length,n=Array(t),r=0;t>r;r++)n[r]=g.pluck(arguments,r);return n},g.object=function(e,t){if(null==e)return{};for(var n={},r=0,i=e.length;i>r;r++)t?n[e[r]]=t[r]:n[e[r][0]]=e[r][1];return n},g.indexOf=function(e,t,n){if(null==e)return-1;var r=0,i=e.length;if(n){if("number"!=typeof n)return r=g.sortedIndex(e,t),e[r]===t?r:-1;r=0>n?Math.max(0,i+n):n}for(;i>r;r++)if(e[r]===t)return r;return-1},g.lastIndexOf=function(e,t,n){if(null==e)return-1;var r=e.length;for("number"==typeof n&&(r=0>n?r+n+1:Math.min(r,n+1));--r>=0;)if(e[r]===t)return r;return-1},g.range=function(e,t,n){arguments.length<=1&&(t=e||0,e=0),n=n||1;for(var r=Math.max(Math.ceil((t-e)/n),0),i=Array(r),o=0;r>o;o++,e+=n)i[o]=e;return i};var b=function(){};g.bind=function(e,t){var n,r;if(d&&e.bind===d)return d.apply(e,u.call(arguments,1));if(!g.isFunction(e))throw new TypeError("Bind must be called on a function");return n=u.call(arguments,2),r=function(){if(!(this instanceof r))return e.apply(t,n.concat(u.call(arguments)));b.prototype=e.prototype;var i=new b;b.prototype=null;var o=e.apply(i,n.concat(u.call(arguments)));return g.isObject(o)?o:i}},g.partial=function(e){var t=u.call(arguments,1);return function(){for(var n=0,r=t.slice(),i=0,o=r.length;o>i;i++)r[i]===g&&(r[i]=arguments[n++]);for(;n<arguments.length;)r.push(arguments[n++]);return e.apply(this,r)}},g.bindAll=function(e){var t,n,r=arguments.length;if(1>=r)throw new Error("bindAll must be passed function names");for(t=1;r>t;t++)n=arguments[t],e[n]=g.bind(e[n],e);return e},g.memoize=function(e,t){var n=function(r){var i=n.cache,o=t?t.apply(this,arguments):r;return g.has(i,o)||(i[o]=e.apply(this,arguments)),i[o]};return n.cache={},n},g.delay=function(e,t){var n=u.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},g.defer=function(e){return g.delay.apply(g,[e,1].concat(u.call(arguments,1)))},g.throttle=function(e,t,n){var r,i,o,s=null,a=0;n||(n={});var u=function(){a=n.leading===!1?0:g.now(),s=null,o=e.apply(r,i),s||(r=i=null)};return function(){var l=g.now();a||n.leading!==!1||(a=l);var c=t-(l-a);return r=this,i=arguments,0>=c||c>t?(clearTimeout(s),s=null,a=l,o=e.apply(r,i),s||(r=i=null)):s||n.trailing===!1||(s=setTimeout(u,c)),o}},g.debounce=function(e,t,n){var r,i,o,s,a,u=function(){var l=g.now()-s;t>l&&l>0?r=setTimeout(u,t-l):(r=null,n||(a=e.apply(o,i),r||(o=i=null)))};return function(){o=this,i=arguments,s=g.now();var l=n&&!r;return r||(r=setTimeout(u,t)),l&&(a=e.apply(o,i),o=i=null),a}},g.wrap=function(e,t){return g.partial(t,e)},g.negate=function(e){return function(){return!e.apply(this,arguments)}},g.compose=function(){var e=arguments,t=e.length-1;return function(){for(var n=t,r=e[t].apply(this,arguments);n--;)r=e[n].call(this,r);return r}},g.after=function(e,t){return function(){return--e<1?t.apply(this,arguments):void 0}},g.before=function(e,t){var n;return function(){return--e>0?n=t.apply(this,arguments):t=null,n}},g.once=g.partial(g.before,2),g.keys=function(e){if(!g.isObject(e))return[];if(p)return p(e);var t=[];for(var n in e)g.has(e,n)&&t.push(n);return t},g.values=function(e){for(var t=g.keys(e),n=t.length,r=Array(n),i=0;n>i;i++)r[i]=e[t[i]];return r},g.pairs=function(e){for(var t=g.keys(e),n=t.length,r=Array(n),i=0;n>i;i++)r[i]=[t[i],e[t[i]]];return r},g.invert=function(e){for(var t={},n=g.keys(e),r=0,i=n.length;i>r;r++)t[e[n[r]]]=n[r];return t},g.functions=g.methods=function(e){var t=[];for(var n in e)g.isFunction(e[n])&&t.push(n);return t.sort()},g.extend=function(e){if(!g.isObject(e))return e;for(var t,n,r=1,i=arguments.length;i>r;r++){t=arguments[r];for(n in t)h.call(t,n)&&(e[n]=t[n])}return e},g.pick=function(e,t,n){var r,i={};if(null==e)return i;if(g.isFunction(t)){t=v(t,n);for(r in e){var o=e[r];t(o,r,e)&&(i[r]=o)}}else{var s=l.apply([],u.call(arguments,1));e=new Object(e);for(var a=0,c=s.length;c>a;a++)r=s[a],r in e&&(i[r]=e[r])}return i},g.omit=function(e,t,n){if(g.isFunction(t))t=g.negate(t);else{var r=g.map(l.apply([],u.call(arguments,1)),String);t=function(e,t){return!g.contains(r,t)}}return g.pick(e,t,n)},g.defaults=function(e){if(!g.isObject(e))return e;for(var t=1,n=arguments.length;n>t;t++){var r=arguments[t];for(var i in r)void 0===e[i]&&(e[i]=r[i])}return e},g.clone=function(e){return g.isObject(e)?g.isArray(e)?e.slice():g.extend({},e):e},g.tap=function(e,t){return t(e),e};var w=function(e,t,n,r){if(e===t)return 0!==e||1/e===1/t;if(null==e||null==t)return e===t;e instanceof g&&(e=e._wrapped),t instanceof g&&(t=t._wrapped);var i=c.call(e);if(i!==c.call(t))return!1;switch(i){case"[object RegExp]":case"[object String]":return""+e==""+t;case"[object Number]":return+e!==+e?+t!==+t:0===+e?1/+e===1/t:+e===+t;case"[object Date]":case"[object Boolean]":return+e===+t}if("object"!=typeof e||"object"!=typeof t)return!1;for(var o=n.length;o--;)if(n[o]===e)return r[o]===t;var s=e.constructor,a=t.constructor;if(s!==a&&"constructor"in e&&"constructor"in t&&!(g.isFunction(s)&&s instanceof s&&g.isFunction(a)&&a instanceof a))return!1;n.push(e),r.push(t);var u,l;if("[object Array]"===i){if(u=e.length,l=u===t.length)for(;u--&&(l=w(e[u],t[u],n,r)););}else{var h,f=g.keys(e);if(u=f.length,l=g.keys(t).length===u)for(;u--&&(h=f[u],l=g.has(t,h)&&w(e[h],t[h],n,r)););}return n.pop(),r.pop(),l};g.isEqual=function(e,t){return w(e,t,[],[])},g.isEmpty=function(e){if(null==e)return!0;if(g.isArray(e)||g.isString(e)||g.isArguments(e))return 0===e.length;for(var t in e)if(g.has(e,t))return!1;return!0},g.isElement=function(e){return!(!e||1!==e.nodeType)},g.isArray=f||function(e){return"[object Array]"===c.call(e)},g.isObject=function(e){var t=typeof e;return"function"===t||"object"===t&&!!e},g.each(["Arguments","Function","String","Number","Date","RegExp"],function(e){g["is"+e]=function(t){return c.call(t)==="[object "+e+"]"}}),g.isArguments(arguments)||(g.isArguments=function(e){return g.has(e,"callee")}),"function"!=typeof/./&&(g.isFunction=function(e){return"function"==typeof e||!1}),g.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},g.isNaN=function(e){return g.isNumber(e)&&e!==+e},g.isBoolean=function(e){return e===!0||e===!1||"[object Boolean]"===c.call(e)},g.isNull=function(e){return null===e},g.isUndefined=function(e){return void 0===e},g.has=function(e,t){return null!=e&&h.call(e,t)},g.noConflict=function(){return e._=r,this},g.identity=function(e){return e},g.constant=function(e){return function(){return e}},g.noop=function(){},g.property=function(e){return function(t){return t[e]}},g.matches=function(e){var t=g.pairs(e),n=t.length;return function(e){if(null==e)return!n;e=new Object(e);for(var r=0;n>r;r++){var i=t[r],o=i[0];if(i[1]!==e[o]||!(o in e))return!1}return!0}},g.times=function(e,t,n){var r=Array(Math.max(0,e));t=v(t,n,1);for(var i=0;e>i;i++)r[i]=t(i);return r},g.random=function(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))},g.now=Date.now||function(){return(new Date).getTime()};var C={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},k=g.invert(C),T=function(e){var t=function(t){return e[t]},n="(?:"+g.keys(e).join("|")+")",r=RegExp(n),i=RegExp(n,"g");return function(e){return e=null==e?"":""+e,r.test(e)?e.replace(i,t):e}};g.escape=T(C),g.unescape=T(k),g.result=function(e,t){if(null==e)return void 0;var n=e[t];return g.isFunction(n)?e[t]():n};var E=0;g.uniqueId=function(e){var t=++E+"";return e?e+t:t},g.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var _=/(.)^/,S={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},N=/\\|'|\r|\n|\u2028|\u2029/g,j=function(e){return"\\"+S[e]};g.template=function(e,t,n){!t&&n&&(t=n),t=g.defaults({},t,g.templateSettings);var r=RegExp([(t.escape||_).source,(t.interpolate||_).source,(t.evaluate||_).source].join("|")+"|$","g"),i=0,o="__p+='";e.replace(r,function(t,n,r,s,a){return o+=e.slice(i,a).replace(N,j),i=a+t.length,n?o+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'":r?o+="'+\n((__t=("+r+"))==null?'':__t)+\n'":s&&(o+="';\n"+s+"\n__p+='"),t}),o+="';\n",t.variable||(o="with(obj||{}){\n"+o+"}\n"),o="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+o+"return __p;\n";try{var s=new Function(t.variable||"obj","_",o)}catch(a){throw a.source=o,a}var u=function(e){return s.call(this,e,g)},l=t.variable||"obj";return u.source="function("+l+"){\n"+o+"}",u},g.chain=function(e){var t=g(e);return t._chain=!0,t};var $=function(e){return this._chain?g(e).chain():e};g.mixin=function(e){g.each(g.functions(e),function(t){var n=g[t]=e[t];g.prototype[t]=function(){var e=[this._wrapped];return a.apply(e,arguments),$.call(this,n.apply(g,e))}})},g.mixin(g),g.each(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=i[e];g.prototype[e]=function(){var n=this._wrapped;return t.apply(n,arguments),"shift"!==e&&"splice"!==e||0!==n.length||delete n[0],$.call(this,n)}}),g.each(["concat","join","slice"],function(e){var t=i[e];g.prototype[e]=function(){return $.call(this,t.apply(this._wrapped,arguments))}}),g.prototype.value=function(){return this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return g})}).call(this)},{}]},{},[7]);</script>
</body>